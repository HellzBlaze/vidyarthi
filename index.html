<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi - LifeOS</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241;
            --primary-light: rgba(99, 102, 241, 0.1);
            
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface-2: #f1f5f9;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="dark"] {
            --bg: #020617;
            --surface: #0f172a;
            --surface-2: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 80px; background: var(--surface); display: flex; flex-direction: column; 
            border-right: 1px solid var(--border); z-index: 100; align-items: center; padding-top: 30px; 
        }
        .logo { 
            width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), #a855f7); 
            border-radius: 14px; display: grid; place-items: center; color: white; font-weight: 900; 
            font-size: 1.5rem; margin-bottom: 40px; box-shadow: 0 8px 20px -5px rgba(var(--primary-rgb), 0.5);
        }
        .nav-item { 
            width: 50px; height: 50px; border-radius: 16px; color: var(--text-muted); font-size: 1.4rem; 
            margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: var(--transition); border: none; background: transparent; position: relative;
        }
        .nav-item:hover { background: var(--surface-2); color: var(--primary); transform: translateY(-2px); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); }
        .nav-item.active::after { content:''; position: absolute; right: -15px; height: 30px; width: 4px; background: var(--primary); border-radius: 4px 0 0 4px; }

        /* --- CONTENT --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; position: relative; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        
        .section { display: none; animation: fadeIn 0.4s ease-out; padding-bottom: 100px; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & GRIDS --- */
        .bento-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .card { 
            background: var(--surface); border-radius: var(--radius-lg); padding: 25px; 
            border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        
        .btn { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: var(--transition); font-size: 0.95rem; }
        .btn:active { transform: scale(0.96); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-icon { width: 36px; height: 36px; display: grid; place-items: center; border-radius: 10px; background: var(--surface-2); color: var(--text); border: none; cursor: pointer; }

        input, select { padding: 12px 15px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); outline: none; width: 100%; font-size: 0.95rem; }

        /* --- üîÑ UNIVERSAL TIMELINE --- */
        .timeline-container { position: relative; padding-left: 20px; }
        .timeline-line { position: absolute; left: 45px; top: 15px; bottom: 15px; width: 2px; background: var(--border); z-index: 0; }
        
        .tl-block { display: flex; margin-bottom: 20px; position: relative; z-index: 1; gap: 15px; }
        .tl-time { width: 50px; text-align: right; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); padding-top: 12px; }
        
        /* Node Styles */
        .tl-node { 
            width: 40px; height: 40px; border-radius: 50%; background: var(--surface); 
            border: 2px solid var(--border); display: grid; place-items: center; font-size: 1.1rem; 
            flex-shrink: 0; transition: var(--transition); box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .tl-block.school .tl-node { border-radius: 12px; } /* Square for school */
        .tl-block.life .tl-node { border-radius: 50%; } /* Circle for life */
        
        .tl-card { 
            flex: 1; background: var(--surface); border-radius: var(--radius-md); border: 1px solid var(--border); 
            padding: 15px; display: flex; justify-content: space-between; align-items: center; transition: var(--transition);
        }
        
        /* Active State */
        .tl-block.active .tl-node { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.1); }
        .tl-block.active .tl-card { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        /* --- üõ†Ô∏è TOOLS GRID --- */
        .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .tool-card { 
            background: var(--surface); padding: 25px; border-radius: var(--radius-lg); border: 1px solid var(--border); 
            cursor: pointer; transition: var(--transition); text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 180px;
        }
        .tool-card:hover { transform: translateY(-5px); border-color: var(--primary); background: var(--surface-2); }
        .tool-icon { font-size: 3rem; margin-bottom: 15px; }
        .tool-title { font-weight: 700; font-size: 1.1rem; }

        /* Focus Tool Specifics */
        .focus-circle { 
            width: 200px; height: 200px; border-radius: 50%; border: 8px solid var(--surface-2); 
            margin: 0 auto 30px auto; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        .focus-circle::after { 
            content:''; position: absolute; top: -8px; left: -8px; right: -8px; bottom: -8px; 
            border-radius: 50%; border: 8px solid var(--primary); border-top-color: transparent; 
            transform: rotate(45deg); animation: spin 2s linear infinite; display: none;
        }
        .focus-active .focus-circle::after { display: block; }
        @keyframes spin { to { transform: rotate(405deg); } }

        /* --- üéí SCHOOL (Subject Folders) --- */
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .sub-folder { 
            background: var(--surface); border-radius: 20px; padding: 20px; border: 1px solid var(--border); 
            position: relative; overflow: hidden; transition: var(--transition); cursor: pointer;
        }
        .sub-folder::before { 
            content:''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: var(--color); 
        }
        .sub-folder:hover { transform: translateY(-5px); box-shadow: var(--shadow); }

        /* --- MODALS --- */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--surface); width: 90%; max-width: 450px; border-radius: 24px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* --- FAB --- */
        .fab { position: fixed; bottom: 35px; right: 35px; width: 65px; height: 65px; background: var(--text); color: var(--bg); border-radius: 20px; display: grid; place-items: center; font-size: 2rem; box-shadow: 0 15px 30px rgba(0,0,0,0.25); cursor: pointer; z-index: 500; transition: var(--transition); }
        .fab:hover { transform: scale(1.1) rotate(90deg); border-radius: 50%; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; flex-direction: row; padding: 0; justify-content: space-evenly; border-top: 1px solid var(--border); border-right: none; padding-top: 0; }
            .logo { display: none; }
            .main-content { padding: 20px; margin-bottom: 75px; }
            .fab { bottom: 95px; right: 25px; }
            .tools-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">V</div>
        <button class="nav-item active" onclick="nav('dashboard')" title="Home">üè†</button>
        <button class="nav-item" onclick="nav('timeline')" title="My Day">‚è±Ô∏è</button>
        <button class="nav-item" onclick="nav('school')" title="School">üéí</button>
        <button class="nav-item" onclick="nav('tasks')" title="Tasks">‚úÖ</button>
        <button class="nav-item" onclick="nav('tools')" title="Tools">üõ†Ô∏è</button>
        <button class="nav-item" onclick="nav('settings')" title="Settings">‚öôÔ∏è</button>
    </nav>

    <main class="main-content">
        
        <div class="header">
            <div>
                <div style="font-size:0.9rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">LifeOS</div>
                <h1 id="page-title">Dashboard</h1>
            </div>
            <div id="clock" style="font-family:monospace; font-weight:700; font-size:1.2rem; color:var(--primary);">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="bento-grid">
                
                <div class="card" style="grid-column: span 2; background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; border: none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="opacity:0.8; font-size:0.9rem; font-weight:700;">HAPPENING NOW</div>
                            <div style="font-size:2.2rem; font-weight:800; margin-top:5px;" id="dash-now-title">Free Time</div>
                            <div style="opacity:0.9;" id="dash-now-time">Until --:--</div>
                        </div>
                        <div style="font-size:4rem; opacity:0.2;">‚è≥</div>
                    </div>
                </div>

                <div class="card">
                    <div style="color:var(--text-muted); font-size:0.9rem; font-weight:700;">TASKS DUE</div>
                    <div style="font-size:3rem; font-weight:900; color:var(--text);" id="dash-task-count">0</div>
                </div>

                <div class="card" onclick="nav('tools')" style="cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; background:var(--surface-2);">
                    <span style="font-size:1.5rem;">üçÖ</span>
                    <span style="font-weight:700;">Start Focus Session</span>
                </div>
            </div>
            
            <h3 style="margin: 30px 0 15px 0;">Today's Timeline</h3>
            <div id="dash-timeline-preview"></div>
        </section>

        <section id="timeline" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--surface); padding:10px 15px; border-radius:16px; border:1px solid var(--border);">
                <button class="btn-icon" onclick="changeDate(-1)">‚óÄ</button>
                <div style="text-align:center;">
                    <div style="font-weight:800;" id="tl-date-main">Today</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="tl-date-sub">Jan 01</div>
                </div>
                <button class="btn-icon" onclick="changeDate(1)">‚ñ∂</button>
            </div>

            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div id="timeline-list"></div>
            </div>
            
            <div style="text-align:center; padding:30px; color:var(--text-muted);">
                Tap <span style="font-weight:800;">+</span> to add school or life blocks.
            </div>
        </section>

        <section id="school" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>My Subjects</h3>
                <button class="btn-sm btn-ghost" onclick="openSubjectModal()">+ Add Subject</button>
            </div>
            <div class="sub-grid" id="subject-list"></div>
        </section>

        <section id="tasks" class="section">
            <div id="task-list"></div>
        </section>

        <section id="tools" class="section">
            <div class="tools-grid">
                
                <div class="tool-card" onclick="openTool('focus')">
                    <div class="tool-icon">üçÖ</div>
                    <div class="tool-title">Focus Timer</div>
                    <div style="color:var(--text-muted); font-size:0.8rem;">Pomodoro & Flow</div>
                </div>

                <div class="tool-card" onclick="openTool('cards')">
                    <div class="tool-icon">üóÇÔ∏è</div>
                    <div class="tool-title">Flashcards</div>
                    <div style="color:var(--text-muted); font-size:0.8rem;">Study & Memorize</div>
                </div>

                <div class="tool-card" onclick="openTool('breathe')">
                    <div class="tool-icon">üå¨Ô∏è</div>
                    <div class="tool-title">Breathe</div>
                    <div style="color:var(--text-muted); font-size:0.8rem;">Calm Down</div>
                </div>

                <div class="tool-card" onclick="openTool('decision')">
                    <div class="tool-icon">üé≤</div>
                    <div class="tool-title">Decide</div>
                    <div style="color:var(--text-muted); font-size:0.8rem;">Spin the Wheel</div>
                </div>

            </div>
        </section>

        <section id="settings" class="section">
            <div class="card">
                <h3>App Settings</h3>
                <button class="btn-ghost" style="width:100%; margin-top:15px;" onclick="toggleTheme()">Toggle Dark Mode üåó</button>
                <button class="btn-ghost" style="width:100%; margin-top:10px;" onclick="exportData()">Backup Data üíæ</button>
                <label class="btn-ghost" style="width:100%; margin-top:10px; display:block; text-align:center; cursor:pointer;">
                    Restore Data üìÇ <input type="file" hidden onchange="importData(this)">
                </label>
                <button class="btn-ghost" style="width:100%; margin-top:10px; color:var(--danger); border-color:var(--danger);" onclick="resetApp()">Factory Reset üóëÔ∏è</button>
            </div>
        </section>

    </main>

    <button class="fab" onclick="handleFab()">+</button>

    <div id="modal-block" class="modal">
        <div class="modal-box">
            <h3>Add Activity</h3>
            <div style="display:flex; gap:10px; margin: 20px 0;">
                <button class="btn" style="flex:1;" id="btn-type-school" onclick="setBlockType('school')">üè´ School</button>
                <button class="btn-ghost" style="flex:1;" id="btn-type-life" onclick="setBlockType('life')">üßò Life</button>
            </div>
            
            <div id="input-school">
                <label style="font-size:0.8rem; font-weight:700;">Select Subject</label>
                <select id="b-sub" style="margin-bottom:15px;"></select>
            </div>

            <div id="input-life" style="display:none;">
                <label style="font-size:0.8rem; font-weight:700;">Activity Name</label>
                <input type="text" id="b-name" placeholder="e.g. Gym, Gaming" style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700;">Icon</label>
                <select id="b-icon" style="margin-bottom:15px;">
                    <option value="üßò">üßò Yoga/Gym</option>
                    <option value="üéÆ">üéÆ Gaming</option>
                    <option value="üí§">üí§ Sleep</option>
                    <option value="ü•™">ü•™ Eat</option>
                    <option value="üöø">üöø Routine</option>
                    <option value="üöå">üöå Commute</option>
                </select>
            </div>

            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <div style="flex:1"><label style="font-size:0.8rem; font-weight:700;">Start</label><input type="time" id="b-start"></div>
                <div style="flex:1"><label style="font-size:0.8rem; font-weight:700;">End</label><input type="time" id="b-end"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1" onclick="closeModal('modal-block')">Cancel</button>
                <button class="btn" style="flex:1" onclick="saveBlock()">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-tool-focus" class="modal">
        <div class="modal-box" style="text-align:center;">
            <div class="focus-circle" id="focus-ui">
                <div style="font-size:3.5rem; font-weight:900;" id="focus-display">25:00</div>
                <div style="color:var(--text-muted);">FOCUS</div>
            </div>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                <button class="btn-sm btn-ghost" onclick="setFocusTime(25)">25m</button>
                <button class="btn-sm btn-ghost" onclick="setFocusTime(45)">45m</button>
                <button class="btn-sm btn-ghost" onclick="setFocusTime(60)">60m</button>
            </div>
            <button class="btn" id="focus-btn" onclick="toggleFocus()" style="width:100%;">START FOCUS</button>
            <button class="btn-ghost" onclick="closeModal('modal-tool-focus')" style="width:100%; margin-top:10px;">Exit</button>
        </div>
    </div>

    <div id="modal-tool-breathe" class="modal">
        <div class="modal-box" style="text-align:center; height:400px; display:flex; flex-direction:column; justify-content:center;">
            <div style="width:150px; height:150px; background:var(--primary-light); border-radius:50%; margin:0 auto 30px auto; animation: breathe 4s infinite ease-in-out;"></div>
            <h2 style="color:var(--primary);">Breathe In...</h2>
            <p style="color:var(--text-muted); margin-top:10px;">Sync your breath with the circle.</p>
            <button class="btn-ghost" onclick="closeModal('modal-tool-breathe')" style="margin-top:auto;">Close</button>
        </div>
        <style> @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.5); } } </style>
    </div>

    <div id="modal-sub" class="modal"><div class="modal-box"><h3>Add Subject</h3><input id="s-name" placeholder="Name" style="margin:10px 0;"><input id="s-room" placeholder="Room" style="margin-bottom:10px;"><input type="color" id="s-color" value="#6366f1" style="width:100%; height:40px; margin-bottom:20px;"><div style="display:flex; gap:10px;"><button class="btn-ghost" style="flex:1" onclick="closeModal('modal-sub')">Cancel</button><button class="btn" style="flex:1" onclick="saveSubject()">Save</button></div></div></div>
    
    <div id="modal-task" class="modal"><div class="modal-box"><h3>Add Task</h3><input id="t-desc" placeholder="Task" style="margin:10px 0;"><select id="t-sub" style="margin-bottom:10px;"></select><input type="date" id="t-date" style="margin-bottom:20px;"><div style="display:flex; gap:10px;"><button class="btn-ghost" style="flex:1" onclick="closeModal('modal-task')">Cancel</button><button class="btn" style="flex:1" onclick="saveTask()">Save</button></div></div></div>

    <script>
        // --- DATA STORE ---
        let db = {
            // "Blocks" replace the old timetable. Can be type 'school' (linked to subId) or 'life' (custom).
            // Structure: { date: "2024-01-01", blocks: [ {id, type, subId, name, icon, start, end} ] }
            days: JSON.parse(localStorage.getItem('vLoDays')) || {},
            subjects: JSON.parse(localStorage.getItem('vLoSubs')) || [],
            tasks: JSON.parse(localStorage.getItem('vLoTasks')) || [],
            settings: JSON.parse(localStorage.getItem('vLoSets')) || { theme: 'light' }
        };

        let selectedDate = new Date();
        let currentBlockType = 'school';
        let currentPage = 'dashboard';

        // --- INIT ---
        function init() {
            if(db.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
            renderAll();
            setInterval(updateClock, 1000);
            setInterval(checkLiveStatus, 5000);
        }

        // --- TIMELINE ENGINE ---
        function changeDate(d) { selectedDate.setDate(selectedDate.getDate()+d); renderTimeline(); }
        
        function renderTimeline() {
            const list = document.getElementById('timeline-list');
            const preview = document.getElementById('dash-timeline-preview');
            list.innerHTML = ''; if(preview) preview.innerHTML = '';

            // Header
            const isToday = new Date().toDateString() === selectedDate.toDateString();
            const dateStr = selectedDate.toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
            document.getElementById('tl-date-main').innerText = isToday ? "Today" : dateStr.split(',')[0];
            document.getElementById('tl-date-sub').innerText = dateStr.split(',')[1];

            // Get Blocks
            const key = selectedDate.toISOString().split('T')[0];
            const blocks = db.days[key] || [];
            
            if(blocks.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No plans for this day.<br>Tap + to plan.</div>`;
                if(preview && isToday) preview.innerHTML = `<div style="text-align:center; color:var(--text-muted);">Nothing scheduled.</div>`;
                return;
            }

            blocks.sort((a,b) => a.start.localeCompare(b.start));
            
            const now = new Date();
            const curTime = now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');

            blocks.forEach(b => {
                let title, icon, color, subName = '';
                if(b.type === 'school') {
                    const sub = db.subjects.find(s => s.id == b.subId) || {name:'?', color:'#ccc'};
                    title = sub.name; icon = 'üìö'; color = sub.color; subName = 'Class';
                } else {
                    title = b.name; icon = b.icon; color = 'var(--text)'; subName = 'Activity';
                }

                const isActive = isToday && (curTime >= b.start && curTime < b.end);
                
                const html = `
                    <div class="tl-block ${b.type} ${isActive?'active':''}">
                        <div class="tl-time">${b.start}</div>
                        <div class="tl-node" style="border-color:${color}; color:${color}">${icon}</div>
                        <div class="tl-card" style="border-left:4px solid ${color}">
                            <div>
                                <div style="font-weight:700; font-size:1rem;">${title}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">${b.start} - ${b.end}</div>
                            </div>
                            <button class="btn-icon" onclick="delBlock(${b.id})">üóëÔ∏è</button>
                        </div>
                    </div>`;
                
                list.innerHTML += html;
                if(preview && isToday) preview.innerHTML += html; // simplified for preview
            });
        }

        // --- BLOCK MANAGEMENT ---
        function setBlockType(t) {
            currentBlockType = t;
            document.getElementById('btn-type-school').className = t==='school'?'btn':'btn-ghost';
            document.getElementById('btn-type-life').className = t==='life'?'btn':'btn-ghost';
            document.getElementById('input-school').style.display = t==='school'?'block':'none';
            document.getElementById('input-life').style.display = t==='life'?'block':'none';
        }

        function saveBlock() {
            const start = document.getElementById('b-start').value;
            const end = document.getElementById('b-end').value;
            if(!start || !end) return alert("Time required");

            const key = selectedDate.toISOString().split('T')[0];
            if(!db.days[key]) db.days[key] = [];

            const newBlock = { id: Date.now(), type: currentBlockType, start, end };
            
            if(currentBlockType === 'school') {
                newBlock.subId = document.getElementById('b-sub').value;
            } else {
                newBlock.name = document.getElementById('b-name').value;
                newBlock.icon = document.getElementById('b-icon').value;
            }

            db.days[key].push(newBlock);
            save(); closeModal('modal-block'); renderTimeline();
        }

        function delBlock(id) {
            const key = selectedDate.toISOString().split('T')[0];
            if(confirm("Delete block?")) {
                db.days[key] = db.days[key].filter(b => b.id !== id);
                save(); renderTimeline();
            }
        }

        // --- DASHBOARD LIVE ---
        function checkLiveStatus() {
            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');
            const key = now.toISOString().split('T')[0];
            const blocks = db.days[key] || [];
            
            const active = blocks.find(b => cur >= b.start && cur < b.end);
            
            if(active) {
                let name = active.type==='school' ? (db.subjects.find(s=>s.id==active.subId)?.name) : active.name;
                document.getElementById('dash-now-title').innerText = name;
                document.getElementById('dash-now-time').innerText = `Until ${active.end}`;
            } else {
                document.getElementById('dash-now-title').innerText = "Free Time";
                document.getElementById('dash-now-time').innerText = "--:--";
            }
            if(selectedDate.toDateString() === now.toDateString()) renderTimeline();
        }

        // --- SCHOOL & TASKS ---
        function renderSchool() {
            const grid = document.getElementById('subject-list');
            const subSel = document.getElementById('b-sub');
            const taskSel = document.getElementById('t-sub');
            grid.innerHTML=''; subSel.innerHTML=''; taskSel.innerHTML='';

            db.subjects.forEach(s => {
                subSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                taskSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                grid.innerHTML += `
                    <div class="sub-folder" style="--color:${s.color}">
                        <h3 style="color:${s.color}">${s.name}</h3>
                        <p style="color:var(--text-muted);">${s.room}</p>
                    </div>`;
            });
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML='';
            const count = db.tasks.filter(t=>!t.done).length;
            document.getElementById('dash-task-count').innerText = count;

            db.tasks.forEach(t => {
                const s = db.subjects.find(x=>x.id==t.subId);
                list.innerHTML += `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; opacity:${t.done?0.5:1}">
                        <div>
                            <div style="font-size:0.8rem; font-weight:700; color:${s?s.color:'#ccc'}">${s?s.name:'General'}</div>
                            <div style="font-size:1.1rem; font-weight:600; text-decoration:${t.done?'line-through':'none'}">${t.desc}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${t.date}</div>
                        </div>
                        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="width:25px; height:25px;">
                    </div>`;
            });
        }

        // --- TOOLS LOGIC ---
        let focusTimer = null;
        let focusTime = 1500;
        
        function openTool(t) {
            if(t==='focus') document.getElementById('modal-tool-focus').style.display='flex';
            if(t==='breathe') document.getElementById('modal-tool-breathe').style.display='flex';
            if(t==='cards') alert("Flashcards coming in v2.0!");
            if(t==='decision') alert(Math.random()>0.5 ? "Yes, do it!" : "Maybe later.");
        }

        function setFocusTime(m) {
            focusTime = m * 60;
            document.getElementById('focus-display').innerText = `${m}:00`;
            clearInterval(focusTimer); focusTimer=null;
            document.getElementById('focus-btn').innerText = "START";
            document.getElementById('focus-ui').classList.remove('focus-active');
        }

        function toggleFocus() {
            if(focusTimer) {
                clearInterval(focusTimer); focusTimer=null;
                document.getElementById('focus-btn').innerText = "RESUME";
                document.getElementById('focus-ui').classList.remove('focus-active');
            } else {
                document.getElementById('focus-btn').innerText = "PAUSE";
                document.getElementById('focus-ui').classList.add('focus-active');
                focusTimer = setInterval(() => {
                    focusTime--;
                    const m = Math.floor(focusTime/60).toString().padStart(2,'0');
                    const s = (focusTime%60).toString().padStart(2,'0');
                    document.getElementById('focus-display').innerText = `${m}:${s}`;
                    if(focusTime<=0) { clearInterval(focusTimer); alert("Focus Complete!"); }
                }, 1000);
            }
        }

        // --- UTILS ---
        function save() { localStorage.setItem('vLoDays', JSON.stringify(db.days)); localStorage.setItem('vLoSubs', JSON.stringify(db.subjects)); localStorage.setItem('vLoTasks', JSON.stringify(db.tasks)); localStorage.setItem('vLoSets', JSON.stringify(db.settings)); renderAll(); }
        function renderAll() { renderSchool(); renderTimeline(); renderTasks(); }
        
        function nav(id) {
            currentPage = id;
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = Array.from(document.querySelectorAll('.nav-item')).find(b=>b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
            document.querySelector('.fab').style.display = (id==='timeline'||id==='school'||id==='tasks')?'grid':'none';
            document.getElementById('page-title').innerText = id.charAt(0).toUpperCase() + id.slice(1);
        }

        function handleFab() {
            if(currentPage==='timeline') { document.getElementById('modal-block').style.display='flex'; setBlockType('school'); }
            if(currentPage==='school') document.getElementById('modal-sub').style.display='flex';
            if(currentPage==='tasks') document.getElementById('modal-task').style.display='flex';
        }

        // CRUD Helpers
        function saveSubject(){ const n=document.getElementById('s-name').value; if(n){ db.subjects.push({id:Date.now(), name:n, room:document.getElementById('s-room').value, color:document.getElementById('s-color').value}); save(); closeModal('modal-sub'); } }
        function saveTask(){ const d=document.getElementById('t-desc').value; if(d){ db.tasks.push({id:Date.now(), desc:d, subId:document.getElementById('t-sub').value, date:document.getElementById('t-date').value, done:false}); save(); closeModal('modal-task'); } }
        function toggleTask(id){ const t=db.tasks.find(x=>x.id==id); if(t)t.done=!t.done; save(); }
        
        function closeModal(id){ document.getElementById(id).style.display='none'; }
        function toggleTheme(){ db.settings.theme = db.settings.theme==='dark'?'light':'dark'; save(); location.reload(); }
        function exportData(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(db)],{type:'application/json'})); a.download='vidyarthi_backup.json'; a.click(); }
        function importData(el){ const fr=new FileReader(); fr.onload=e=>{ db=JSON.parse(e.target.result); save(); alert("Restored!"); }; fr.readAsText(el.files[0]); }
        function resetApp(){ if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
        function updateClock(){ document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}); }

        init();
        nav('dashboard');
    </script>
</body>
</html>
