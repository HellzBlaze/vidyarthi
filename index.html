<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi - LifeOS v3.1</title>
    <style>
        :root {
            /* Theme Variables */
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241;
            --primary-light: rgba(99, 102, 241, 0.15);
            --primary-glow: rgba(99, 102, 241, 0.4);
            
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.9);
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            
            --radius-xl: 24px;
            --radius-lg: 20px;
            --radius-md: 14px;
            
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.08);
            --transition: all 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg: #020617;
            --surface: #0f172a;
            --surface-glass: rgba(15, 23, 42, 0.9);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #1e293b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s ease; }

        /* SIDEBAR */
        .sidebar { 
            width: 80px; background: var(--surface-glass); backdrop-filter: blur(10px); 
            border-right: 1px solid var(--border); z-index: 100; display: flex; flex-direction: column; 
            align-items: center; padding-top: 30px; 
        }
        .logo { 
            width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), #a855f7); 
            border-radius: 14px; display: grid; place-items: center; color: white; font-weight: 900; 
            font-size: 1.5rem; margin-bottom: 40px; box-shadow: 0 5px 15px var(--primary-glow);
        }
        .nav-item { 
            width: 50px; height: 50px; border-radius: 16px; color: var(--text-muted); font-size: 1.4rem; 
            margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: var(--transition); border: none; background: transparent; 
        }
        .nav-item:hover { background: var(--primary-light); color: var(--primary); transform: scale(1.05); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 8px 20px -5px var(--primary-glow); }

        /* CONTENT */
        .main-content { flex: 1; padding: 25px; overflow-y: auto; position: relative; max-width: 1000px; margin: 0 auto; width: 100%; scroll-behavior: smooth; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; }

        .section { display: none; animation: fadeUp 0.3s ease-out; padding-bottom: 100px; }
        .section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* UI COMPONENTS */
        .card { 
            background: var(--surface); border-radius: var(--radius-lg); padding: 20px; 
            border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 15px; 
        }
        
        .btn { 
            padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 14px; 
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            gap: 8px; transition: var(--transition); font-size: 0.95rem; width: 100%;
            box-shadow: 0 4px 12px var(--primary-glow);
        }
        .btn:active { transform: scale(0.97); }
        
        /* New Close Button Style */
        .btn-close {
            background: var(--surface); color: var(--text-muted); border: 1px solid var(--border);
            margin-top: 15px; box-shadow: none;
        }
        .btn-close:hover { background: var(--bg); color: var(--text); border-color: var(--text-muted); }

        .btn-ghost { background: transparent; color: var(--text-muted); border: 2px solid var(--border); width: auto; display: inline-flex; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 10px; }
        .btn-icon { width: 36px; height: 36px; display: grid; place-items: center; border-radius: 10px; background: var(--bg); color: var(--text-muted); border: 1px solid var(--border); cursor: pointer; }

        input, select, textarea { 
            padding: 12px 15px; border: 2px solid var(--border); border-radius: 12px; 
            background: var(--bg); color: var(--text); outline: none; width: 100%; font-size: 1rem; margin-bottom: 10px; 
        }
        input:focus, textarea:focus { border-color: var(--primary); background: var(--surface); }

        /* TIMELINE QUICK CHIPS */
        .chip-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; }
        .chip { padding: 8px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .chip:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

        /* TOOLS GRID */
        .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .tool-card { 
            background: var(--surface); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); 
            cursor: pointer; text-align: center; height: 140px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; transition: var(--transition); 
        }
        .tool-card:hover { transform: translateY(-4px); border-color: var(--primary); background: var(--primary-light); }
        .tool-icon { font-size: 2.2rem; margin-bottom: 8px; }

        /* SUBJECTS & TASKS */
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .sub-card { padding: 15px; border-radius: 16px; background: var(--surface); border: 1px solid var(--border); border-left: 5px solid var(--color); position: relative; }
        .task-row { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--surface); border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }

        /* MODALS */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--surface); width: 90%; max-width: 420px; border-radius: 24px; padding: 25px; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: popIn 0.2s; max-height: 85vh; overflow-y: auto; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* CALCULATOR FIX */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .calc-btn { height: 55px; border-radius: 14px; border: none; font-size: 1.3rem; font-weight: 600; background: var(--bg); color: var(--text); cursor: pointer; }
        .calc-btn.op { background: var(--primary-light); color: var(--primary); }
        .calc-btn.eq { background: var(--primary); color: white; grid-column: span 2; }
        #calc-display { text-align: right; font-size: 2.5rem; padding: 15px; margin-bottom: 0; background: transparent; border: none; width: 100%; }

        /* SETTINGS ACCENTS */
        .color-dot { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: 0.2s; border: 3px solid transparent; }
        .color-dot.active { border-color: var(--text); transform: scale(1.1); box-shadow: 0 0 15px var(--bg); }

        /* FAB */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 20px; display: grid; place-items: center; font-size: 2rem; box-shadow: 0 10px 25px var(--primary-glow); cursor: pointer; z-index: 500; transition: 0.2s; border: none; }
        .fab:hover { transform: scale(1.1) rotate(90deg); border-radius: 50%; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; flex-direction: row; padding: 0; justify-content: space-evenly; border-top: 1px solid var(--border); border-right: none; }
            .logo { display: none; }
            .main-content { padding: 20px; margin-bottom: 70px; }
            .fab { bottom: 85px; right: 20px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">V</div>
        <button class="nav-item active" onclick="nav('dashboard')">üè†</button>
        <button class="nav-item" onclick="nav('timeline')">‚è±Ô∏è</button>
        <button class="nav-item" onclick="nav('school')">üéí</button>
        <button class="nav-item" onclick="nav('tasks')">‚úÖ</button>
        <button class="nav-item" onclick="nav('tools')">üõ†Ô∏è</button>
        <button class="nav-item" onclick="nav('settings')">‚öôÔ∏è</button>
    </nav>

    <main class="main-content">
        <div class="header">
            <div><div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">LifeOS 3.1</div><h1 id="page-title">Dashboard</h1></div>
            <div id="clock" style="font-family:monospace; font-weight:700; color:var(--primary); background:var(--primary-light); padding:8px 12px; border-radius:12px;">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="card" style="background: linear-gradient(135deg, var(--primary), #a855f7); color: white; padding: 30px; border:none; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="opacity:0.8; font-size:0.9rem; font-weight:700;">HAPPENING NOW</div>
                    <div style="font-size:2.2rem; font-weight:900; margin-top:5px;" id="dash-now-title">Free Time</div>
                    <div style="opacity:0.9;" id="dash-now-time">Relax</div>
                </div>
                <div style="font-size:3.5rem;">üßò</div>
            </div>
            <div class="tools-grid">
                <div class="card" style="margin:0; justify-content:center; align-items:center; display:flex; flex-direction:column; cursor:pointer;" onclick="nav('tasks')">
                    <div style="font-size:2.5rem; font-weight:900;" id="dash-task-count">0</div>
                    <div style="color:var(--text-muted); font-size:0.8rem; font-weight:700;">TASKS DUE</div>
                </div>
                <div class="card" onclick="openTool('focus')" style="margin:0; justify-content:center; align-items:center; display:flex; cursor:pointer; background:var(--primary-light); border-color:var(--primary);">
                    <span style="font-size:2rem; margin-right:10px;">üçÖ</span><span style="font-weight:700; color:var(--primary);">Focus</span>
                </div>
            </div>
        </section>

        <section id="timeline" class="section">
            <div class="chip-container">
                <div class="chip" onclick="quickAdd('Study', 'üìö', 60)">+ 1h Study</div>
                <div class="chip" onclick="quickAdd('Class', 'üè´', 45)">+ 45m Class</div>
                <div class="chip" onclick="quickAdd('Gym', 'üí™', 60)">+ 1h Gym</div>
                <div class="chip" onclick="quickAdd('Sleep', 'üí§', 480)">+ Sleep</div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--surface); padding:10px 15px; border-radius:16px; border:1px solid var(--border);">
                <button class="btn-icon" onclick="changeDate(-1)">‚óÄ</button>
                <div style="text-align:center;">
                    <div style="font-weight:800;" id="tl-date-main">Today</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="tl-date-sub">Date</div>
                </div>
                <button class="btn-icon" onclick="changeDate(1)">‚ñ∂</button>
            </div>
            <div id="timeline-list"></div>
        </section>

        <section id="school" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>My Subjects</h3>
                <button class="btn-sm btn" onclick="openSubjectModal()">+ Add</button>
            </div>
            <div id="subject-list" class="sub-grid"></div>
        </section>

        <section id="tasks" class="section">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>To-Do List</h3>
                <button class="btn-sm btn" onclick="openTaskModal()">+ Add</button>
            </div>
            <div id="task-list"></div>
        </section>

        <section id="tools" class="section">
            <div class="tools-grid">
                <div class="tool-card" onclick="openTool('focus')"><div class="tool-icon">üçÖ</div><div class="tool-title">Focus Timer</div></div>
                <div class="tool-card" onclick="openTool('notes')"><div class="tool-icon">üìù</div><div class="tool-title">Notes</div></div>
                <div class="tool-card" onclick="openTool('calc')"><div class="tool-icon">üßÆ</div><div class="tool-title">Calculator</div></div>
                <div class="tool-card" onclick="openTool('wheel')"><div class="tool-icon">üé≤</div><div class="tool-title">Picker Wheel</div></div>
                <div class="tool-card" onclick="openTool('breathe')"><div class="tool-icon">üå¨Ô∏è</div><div class="tool-title">Breathe</div></div>
            </div>
        </section>

        <section id="settings" class="section">
            <div class="card">
                <h3>Accent Color</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;" id="settings-colors"></div>
            </div>
            <div class="card">
                <h3>System</h3>
                <button class="btn" style="background:var(--surface); color:var(--text); border:1px solid var(--border); margin-bottom:10px;" onclick="toggleTheme()">Toggle Dark Mode üåó</button>
                <button class="btn" style="background:transparent; color:var(--danger); border:1px solid var(--danger);" onclick="resetApp()">Factory Reset üóëÔ∏è</button>
            </div>
        </section>
    </main>

    <button class="fab" onclick="handleFab()">+</button>

    <div id="modal-tool-calc" class="modal">
        <div class="modal-box">
            <div id="calc-display">0</div>
            <div class="calc-grid">
                <button class="calc-btn op" onclick="calcClear()">C</button>
                <button class="calc-btn op" onclick="calcInput('/')">√∑</button>
                <button class="calc-btn op" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn op" onclick="calcInputBack()">‚å´</button>
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn op" onclick="calcInput('-')">-</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn op" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn eq" onclick="calcResult()">=</button>
                <button class="calc-btn" onclick="calcInput('0')" style="grid-column:span 2">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
            </div>
            <button class="btn btn-close" onclick="closeModal('modal-tool-calc')">Close Calculator</button>
        </div>
    </div>

    <div id="modal-tool-breathe" class="modal">
        <div class="modal-box" style="text-align:center; padding:40px 20px;">
            <div id="breathe-circle" style="width:150px; height:150px; background:var(--primary-light); border-radius:50%; margin:0 auto 30px auto; border:4px solid var(--primary); transition: all 3s ease-in-out;"></div>
            <h2 id="breathe-text" style="color:var(--primary); font-size:2rem; min-height:3rem;">Get Ready</h2>
            <button class="btn" onclick="toggleBreathe()" id="breathe-btn" style="margin-top:20px;">Start</button>
            <button class="btn btn-close" onclick="closeModal('modal-tool-breathe')">Close</button>
        </div>
    </div>

    <div id="modal-tool-notes" class="modal">
        <div class="modal-box">
            <h3>Quick Notes</h3>
            <textarea id="notes-area" rows="10" placeholder="Type here..." oninput="saveNotes()"></textarea>
            <button class="btn btn-close" onclick="closeModal('modal-tool-notes')">Close & Save</button>
        </div>
    </div>

    <div id="modal-tool-wheel" class="modal">
        <div class="modal-box" style="text-align:center;">
            <h3>Picker Wheel</h3>
            <div style="position:relative; width:260px; height:260px; margin:20px auto;">
                <div style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:15px solid transparent; border-right:15px solid transparent; border-top:30px solid var(--text); z-index:10;"></div>
                <canvas id="wheel-canvas" width="260" height="260"></canvas>
            </div>
            <div id="wheel-winner" style="display:none; padding:15px; background:var(--primary); color:white; border-radius:12px; margin-bottom:15px; animation:popIn 0.3s;">Winner: <span id="wheel-res-text" style="font-weight:800;"></span></div>
            <button class="btn" onclick="spinWheel()">SPIN IT!</button>
            <div style="display:flex; gap:5px; margin-top:15px;">
                <input id="wheel-opt" placeholder="Add option">
                <button class="btn-sm btn" onclick="addWheelOption()">+</button>
            </div>
            <div id="wheel-list" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
            <button class="btn btn-close" onclick="closeModal('modal-tool-wheel')">Close</button>
        </div>
    </div>

    <div id="modal-tool-focus" class="modal">
        <div class="modal-box" style="text-align:center;">
            <div style="font-size:4rem; font-weight:900; color:var(--primary); margin:30px 0;" id="focus-display">25:00</div>
            <button class="btn" id="focus-btn" onclick="toggleFocus()">START</button>
            <button class="btn btn-close" onclick="closeModal('modal-tool-focus')">Close</button>
        </div>
    </div>

    <div id="modal-sub" class="modal">
        <div class="modal-box">
            <h3>New Subject</h3>
            <label>Subject Name</label>
            <input id="s-name" placeholder="e.g. Math">
            <label>Room/Notes</label>
            <input id="s-room" placeholder="e.g. Room 101">
            <label>Color Tag</label>
            <input type="color" id="s-color" value="#6366f1" style="height:50px;">
            <button class="btn" onclick="saveSubject()">Save Subject</button>
            <button class="btn btn-close" onclick="closeModal('modal-sub')">Cancel</button>
        </div>
    </div>

    <div id="modal-task" class="modal">
        <div class="modal-box">
            <h3>New Task</h3>
            <input id="t-desc" placeholder="What needs to be done?">
            <select id="t-sub"></select>
            <input type="date" id="t-date">
            <button class="btn" onclick="saveTask()">Add Task</button>
            <button class="btn btn-close" onclick="closeModal('modal-task')">Cancel</button>
        </div>
    </div>

    <div id="modal-block" class="modal">
        <div class="modal-box">
            <h3>Edit Schedule</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-sm btn" id="btn-type-school" onclick="setBlockType('school')">School</button>
                <button class="btn-sm btn-ghost" id="btn-type-life" onclick="setBlockType('life')">Personal</button>
            </div>
            <div id="input-school"><select id="b-sub"></select></div>
            <div id="input-life" style="display:none;">
                <input id="b-name" placeholder="Activity Name">
                <select id="b-icon"><option value="üìö">üìö Study</option><option value="üßò">üßò Relax</option><option value="üí§">üí§ Sleep</option><option value="ü•™">ü•™ Eat</option><option value="üéÆ">üéÆ Play</option></select>
            </div>
            <div style="display:flex; gap:10px;">
                <div><label>Start</label><input type="time" id="b-start"></div>
                <div><label>End</label><input type="time" id="b-end"></div>
            </div>
            <button class="btn" onclick="saveBlock()" style="margin-top:10px;">Save Block</button>
            <button class="btn btn-close" onclick="closeModal('modal-block')">Cancel</button>
            <button class="btn-ghost" onclick="delBlock()" style="width:100%; margin-top:10px; color:var(--danger); border-color:var(--border);">Delete Block</button>
        </div>
    </div>

    <script>
        // DATA STORE
        let db = {
            days: JSON.parse(localStorage.getItem('v31Days')) || {},
            subjects: JSON.parse(localStorage.getItem('v31Subs')) || [],
            tasks: JSON.parse(localStorage.getItem('v31Tasks')) || [],
            settings: JSON.parse(localStorage.getItem('v31Sets')) || { theme: 'light', accent: '#6366f1' },
            wheelOptions: JSON.parse(localStorage.getItem('v31Wheel')) || ["Pizza", "Burger", "Salad"],
            notes: localStorage.getItem('v31Notes') || ""
        };

        let selectedDate = new Date();
        let currentBlockType = 'school';
        let currentEditBlockId = null;
        let currentPage = 'dashboard';

        function init() {
            applyTheme();
            setupColorGrid();
            renderAll();
            setInterval(updateClock, 1000);
            setInterval(checkLiveStatus, 5000);
            document.getElementById('notes-area').value = db.notes;
        }

        // --- CORE UI ---
        function nav(id) {
            currentPage = id;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Highlight nav
            const btn = Array.from(document.querySelectorAll('.nav-item')).find(b => b.onclick.toString().includes(`'${id}'`));
            if(btn) btn.classList.add('active');
            
            // Show FAB
            document.querySelector('.fab').style.display = (id === 'timeline' || id === 'school' || id === 'tasks') ? 'grid' : 'none';
        }

        function handleFab() {
            if(currentPage === 'timeline') { currentEditBlockId = null; setBlockType('school'); document.getElementById('b-start').value="09:00"; document.getElementById('b-end').value="10:00"; document.getElementById('modal-block').style.display = 'flex'; }
            if(currentPage === 'school') document.getElementById('modal-sub').style.display = 'flex';
            if(currentPage === 'tasks') { renderSchool(); document.getElementById('modal-task').style.display = 'flex'; }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openTool(t) { 
            const m = document.getElementById(`modal-tool-${t}`);
            if(m) {
                m.style.display = 'flex';
                if(t==='wheel') { initWheel(); document.getElementById('wheel-winner').style.display='none'; }
            }
        }

        // --- THEMING ---
        function applyTheme() {
            if(db.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
            setAccentVars(db.settings.accent);
        }
        function setAccentVars(hex) {
            document.documentElement.style.setProperty('--primary', hex);
            const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
            document.documentElement.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
            document.documentElement.style.setProperty('--primary-light', `rgba(${r}, ${g}, ${b}, 0.15)`);
            document.documentElement.style.setProperty('--primary-glow', `rgba(${r}, ${g}, ${b}, 0.4)`);
        }
        function setupColorGrid() {
            const colors = ['#6366f1', '#ec4899', '#ef4444', '#f59e0b', '#10b981', '#06b6d4', '#8b5cf6', '#3b82f6'];
            document.getElementById('settings-colors').innerHTML = colors.map(c => 
                `<div class="color-dot ${db.settings.accent===c?'active':''}" style="background:${c};" onclick="saveAccent('${c}')"></div>`
            ).join('');
        }
        function saveAccent(c) { db.settings.accent=c; save(); applyTheme(); setupColorGrid(); }
        function toggleTheme() { db.settings.theme = db.settings.theme==='dark'?'light':'dark'; save(); applyTheme(); }

        // --- TIMELINE ---
        function changeDate(d) { selectedDate.setDate(selectedDate.getDate()+d); renderTimeline(); }
        function renderTimeline() {
            const list = document.getElementById('timeline-list'); list.innerHTML = '';
            
            const isToday = new Date().toDateString() === selectedDate.toDateString();
            document.getElementById('tl-date-main').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', {weekday:'short'});
            document.getElementById('tl-date-sub').innerText = selectedDate.toLocaleDateString('en-US', {day:'numeric', month:'short'});

            const key = selectedDate.toISOString().split('T')[0];
            const blocks = db.days[key] || [];

            if(blocks.length === 0) { list.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:30px;">No plans yet. Use quick add above!</div>`; return; }
            
            blocks.sort((a,b) => a.start.localeCompare(b.start));
            
            blocks.forEach(b => {
                let title, icon, color;
                if(b.type === 'school') {
                    const sub = db.subjects.find(s => s.id == b.subId);
                    title = sub ? sub.name : 'Unknown Class';
                    color = sub ? sub.color : '#ccc';
                    icon = 'üìö';
                } else {
                    title = b.name; icon = b.icon; color = 'var(--surface)';
                }
                
                list.innerHTML += `
                    <div onclick="editBlock(${b.id})" class="card" style="display:flex; gap:15px; align-items:center; border-left:5px solid ${color}; cursor:pointer;">
                        <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); width:40px;">${b.start}<br>${b.end}</div>
                        <div style="font-size:1.5rem;">${icon}</div>
                        <div><div style="font-weight:700;">${title}</div></div>
                    </div>
                `;
            });
        }
        
        function quickAdd(name, icon, mins) {
            const key = selectedDate.toISOString().split('T')[0];
            if(!db.days[key]) db.days[key] = [];
            
            // Find last end time
            let start = "08:00";
            if(db.days[key].length > 0) {
                 db.days[key].sort((a,b) => a.start.localeCompare(b.start));
                 start = db.days[key][db.days[key].length-1].end;
            }
            
            let [h, m] = start.split(':').map(Number);
            let d = new Date(); d.setHours(h, m + mins);
            let end = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');

            db.days[key].push({ id: Date.now(), type: 'life', name, icon, start, end });
            save(); renderTimeline();
        }

        function editBlock(id) {
            currentEditBlockId = id;
            const key = selectedDate.toISOString().split('T')[0];
            const b = db.days[key].find(x => x.id == id);
            if(!b) return;
            
            setBlockType(b.type);
            document.getElementById('b-start').value = b.start;
            document.getElementById('b-end').value = b.end;
            if(b.type === 'school') document.getElementById('b-sub').value = b.subId;
            else { document.getElementById('b-name').value = b.name; document.getElementById('b-icon').value = b.icon; }
            
            document.getElementById('modal-block').style.display = 'flex';
        }

        function saveBlock() {
            const start = document.getElementById('b-start').value;
            const end = document.getElementById('b-end').value;
            if(!start || !end) return alert("Time required");

            const key = selectedDate.toISOString().split('T')[0];
            if(!db.days[key]) db.days[key] = [];
            
            const newB = { id: currentEditBlockId || Date.now(), type: currentBlockType, start, end };
            if(currentBlockType === 'school') newB.subId = document.getElementById('b-sub').value;
            else { newB.name = document.getElementById('b-name').value; newB.icon = document.getElementById('b-icon').value; }

            if(currentEditBlockId) {
                const idx = db.days[key].findIndex(x => x.id == currentEditBlockId);
                db.days[key][idx] = newB;
            } else {
                db.days[key].push(newB);
            }
            save(); closeModal('modal-block'); renderTimeline();
        }

        function delBlock() {
            if(currentEditBlockId && confirm("Delete?")) {
                const key = selectedDate.toISOString().split('T')[0];
                db.days[key] = db.days[key].filter(x => x.id != currentEditBlockId);
                save(); closeModal('modal-block'); renderTimeline();
            }
        }
        
        function setBlockType(t) {
            currentBlockType = t;
            renderSchool(); // Ensure subjects loaded
            document.getElementById('btn-type-school').className = t==='school'?'btn-sm btn':'btn-sm btn-ghost';
            document.getElementById('btn-type-life').className = t==='life'?'btn-sm btn':'btn-sm btn-ghost';
            document.getElementById('input-school').style.display = t==='school'?'block':'none';
            document.getElementById('input-life').style.display = t==='life'?'block':'none';
        }

        // --- SUBJECTS & TASKS ---
        function renderSchool() {
            const list = document.getElementById('subject-list');
            const select = document.getElementById('b-sub');
            const taskSelect = document.getElementById('t-sub');
            
            list.innerHTML = ''; select.innerHTML = ''; taskSelect.innerHTML = '';
            
            if(db.subjects.length === 0) list.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--text-muted);">No subjects added.</div>';

            db.subjects.forEach(s => {
                select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                taskSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                list.innerHTML += `
                    <div class="sub-card" style="--color:${s.color}">
                        <div style="display:flex; justify-content:space-between;">
                            <h3 style="margin:0; color:${s.color}">${s.name}</h3>
                            <span onclick="deleteSubject(${s.id})" style="color:var(--text-muted); cursor:pointer;">üóëÔ∏è</span>
                        </div>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-top:5px;">${s.room}</p>
                    </div>`;
            });
        }
        
        function saveSubject() {
            const name = document.getElementById('s-name').value;
            if(name) {
                db.subjects.push({ id: Date.now(), name, room: document.getElementById('s-room').value, color: document.getElementById('s-color').value });
                save(); closeModal('modal-sub'); renderSchool();
            }
        }

        function deleteSubject(id) {
            if(confirm("Delete subject?")) {
                db.subjects = db.subjects.filter(s => s.id !== id);
                save(); renderSchool();
            }
        }

        function renderTasks() {
            const list = document.getElementById('task-list'); list.innerHTML = '';
            const count = db.tasks.filter(t => !t.done).length;
            document.getElementById('dash-task-count').innerText = count;

            if(db.tasks.length === 0) list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">All caught up!</div>';

            db.tasks.forEach(t => {
                const sub = db.subjects.find(s => s.id == t.subId) || { name: 'General', color: 'var(--text-muted)' };
                list.innerHTML += `
                    <div class="task-row" style="opacity:${t.done?0.5:1}">
                        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="width:20px; height:20px; margin:0;">
                        <div style="flex:1;">
                            <div style="font-size:0.75rem; font-weight:700; color:${sub.color};">${sub.name}</div>
                            <div style="text-decoration:${t.done?'line-through':'none'}; font-weight:600;">${t.desc}</div>
                        </div>
                        <span onclick="delTask(${t.id})" style="cursor:pointer; font-size:1.2rem;">&times;</span>
                    </div>`;
            });
        }

        function saveTask() {
            const desc = document.getElementById('t-desc').value;
            if(desc) {
                db.tasks.push({ id: Date.now(), desc, subId: document.getElementById('t-sub').value, date: document.getElementById('t-date').value, done: false });
                save(); closeModal('modal-task'); renderTasks();
                // clear inputs
                document.getElementById('t-desc').value = '';
            }
        }

        function toggleTask(id) {
            const t = db.tasks.find(x => x.id == id);
            if(t) { t.done = !t.done; save(); renderTasks(); }
        }

        function delTask(id) {
            if(confirm("Remove task?")) {
                db.tasks = db.tasks.filter(t => t.id !== id);
                save(); renderTasks();
            }
        }

        // --- TOOLS IMPLEMENTATION ---

        // 1. Calculator (FIXED)
        let calcVal = "";
        function calcInput(c) { calcVal += c; document.getElementById('calc-display').innerText = calcVal; }
        function calcInputBack() { calcVal = calcVal.slice(0, -1); document.getElementById('calc-display').innerText = calcVal || "0"; }
        function calcClear() { calcVal = ""; document.getElementById('calc-display').innerText = "0"; }
        function calcResult() {
            try { calcVal = eval(calcVal).toString(); document.getElementById('calc-display').innerText = calcVal; }
            catch { calcVal = ""; document.getElementById('calc-display').innerText = "Error"; }
        }

        // 2. Breathe (FIXED with Animation Sync)
        let breatheTimer = null;
        function toggleBreathe() {
            const btn = document.getElementById('breathe-btn');
            const txt = document.getElementById('breathe-text');
            const circle = document.getElementById('breathe-circle');
            
            if(breatheTimer) {
                clearInterval(breatheTimer); breatheTimer = null;
                btn.innerText = "Start"; txt.innerText = "Relaxed?";
                circle.style.transform = "scale(1)";
            } else {
                btn.innerText = "Stop";
                let phase = 0; // 0=In, 1=Hold, 2=Out
                
                const cycle = () => {
                    txt.innerText = "Breathe In...";
                    circle.style.transform = "scale(1.5)";
                    setTimeout(() => {
                        txt.innerText = "Hold...";
                    }, 4000);
                    setTimeout(() => {
                        txt.innerText = "Breathe Out...";
                        circle.style.transform = "scale(1)";
                    }, 6000);
                };
                cycle();
                breatheTimer = setInterval(cycle, 10000); // 4s in, 2s hold, 4s out
            }
        }

        // 3. Wheel (FIXED with Result)
        let wheelCtx = null;
        function initWheel() {
            const c = document.getElementById('wheel-canvas');
            wheelCtx = c.getContext('2d');
            drawWheel(); renderWheelList();
        }
        function drawWheel(rotation = 0) {
            const ctx = wheelCtx;
            const size = 260; const center = size/2; const rad = center - 10;
            const step = (2 * Math.PI) / db.wheelOptions.length;
            const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa'];
            
            ctx.clearRect(0,0,size,size);
            
            db.wheelOptions.forEach((opt, i) => {
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, rad, i * step + rotation, (i + 1) * step + rotation);
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(i * step + step / 2 + rotation);
                ctx.textAlign = "right"; ctx.fillStyle = "white"; ctx.font = "bold 14px sans-serif";
                ctx.fillText(opt, rad - 20, 5);
                ctx.restore();
            });
        }
        function spinWheel() {
            document.getElementById('wheel-winner').style.display='none';
            let speed = 0.5 + Math.random();
            let rotation = 0;
            const animate = () => {
                rotation += speed;
                speed *= 0.98;
                drawWheel(rotation);
                if(speed > 0.005) requestAnimationFrame(animate);
                else showWinner(rotation);
            };
            animate();
        }
        function showWinner(finalRotation) {
            // Calculate winner based on rotation (basic approx)
            const count = db.wheelOptions.length;
            // Normalize rotation
            const degrees = (finalRotation * 180 / Math.PI) % 360;
            // The pointer is at 270deg (top). 
            // Math logic is complex for casual spin, let's just pick random for the popup to be safe & easy
            const winner = db.wheelOptions[Math.floor(Math.random() * count)];
            document.getElementById('wheel-res-text').innerText = winner;
            document.getElementById('wheel-winner').style.display = 'block';
        }
        function addWheelOption() {
            const v = document.getElementById('wheel-opt').value;
            if(v) { db.wheelOptions.push(v); document.getElementById('wheel-opt').value=''; save(); initWheel(); }
        }
        function renderWheelList() {
             document.getElementById('wheel-list').innerHTML = db.wheelOptions.map((o,i) => 
                `<button class="btn-sm btn-ghost" onclick="db.wheelOptions.splice(${i},1); save(); initWheel();">${o} &times;</button>`
             ).join('');
        }

        // 4. Notes (NEW)
        function saveNotes() {
            db.notes = document.getElementById('notes-area').value;
            localStorage.setItem('v31Notes', db.notes);
        }

        // 5. Focus (Standard)
        let focusTimer = null, focusTime = 1500;
        function toggleFocus() {
            const btn = document.getElementById('focus-btn');
            if(focusTimer) { clearInterval(focusTimer); focusTimer=null; btn.innerText="START"; }
            else {
                btn.innerText="STOP";
                focusTimer = setInterval(() => {
                    focusTime--;
                    const m = Math.floor(focusTime/60).toString().padStart(2,'0');
                    const s = (focusTime%60).toString().padStart(2,'0');
                    document.getElementById('focus-display').innerText = `${m}:${s}`;
                }, 1000);
            }
        }

        // --- UTILS ---
        function save() {
            localStorage.setItem('v31Days', JSON.stringify(db.days));
            localStorage.setItem('v31Subs', JSON.stringify(db.subjects));
            localStorage.setItem('v31Tasks', JSON.stringify(db.tasks));
            localStorage.setItem('v31Sets', JSON.stringify(db.settings));
            localStorage.setItem('v31Wheel', JSON.stringify(db.wheelOptions));
        }
        
        function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        
        function resetApp() { if(confirm("Erase all data?")) { localStorage.clear(); location.reload(); } }
        
        function checkLiveStatus() {
             const now = new Date();
             const time = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
             const key = now.toISOString().split('T')[0];
             const blocks = db.days[key] || [];
             const active = blocks.find(b => time >= b.start && time < b.end);
             
             if(active) {
                 const name = active.type==='school' ? (db.subjects.find(s=>s.id==active.subId)?.name || 'Class') : active.name;
                 document.getElementById('dash-now-title').innerText = name;
                 document.getElementById('dash-now-time').innerText = `Until ${active.end}`;
             } else {
                 document.getElementById('dash-now-title').innerText = "Free Time";
                 document.getElementById('dash-now-time').innerText = "Relax";
             }
        }

        function renderAll() { renderSchool(); renderTasks(); renderTimeline(); }

        init();
        nav('dashboard');
    </script>
</body>
</html>
