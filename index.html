<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi - Platinum Fixed</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #e0e7ff;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 18px;
            --shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            --danger: #ef4444;
            --success: #10b981;
        }

        [data-theme="dark"] {
            --bg: #0b0f19;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary: #818cf8;
            --primary-light: #312e81;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Inter', system-ui, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- LAYOUT --- */
        .sidebar { width: 80px; background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 100; align-items: center; padding-top: 25px; }
        .main-content { flex: 1; padding: 25px; overflow-y: auto; scroll-behavior: smooth; position: relative; max-width: 800px; margin: 0 auto; width: 100%; }
        
        .nav-item { width: 50px; height: 50px; border-radius: 16px; color: var(--text-muted); font-size: 1.5rem; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; border: none; background: transparent; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 8px 20px -4px rgba(99, 102, 241, 0.5); }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { font-size: 1.8rem; font-weight: 800; }
        
        .section { display: none; animation: fadeScale 0.3s ease-out; padding-bottom: 100px; }
        .section.active { display: block; }
        @keyframes fadeScale { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

        .card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 15px; }
        
        .btn { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 0.95rem; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
        .btn-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: none; background: transparent; cursor: pointer; color: var(--text-muted); }

        input, select { padding: 12px 15px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); outline: none; width: 100%; font-size: 0.95rem; }

        /* --- TIMELINE --- */
        .date-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: var(--surface); padding: 10px; border-radius: 16px; border: 1px solid var(--border); }
        
        .timeline-wrapper { position: relative; padding: 10px 0 10px 20px; }
        .timeline-line { position: absolute; left: 45px; top: 0; bottom: 0; width: 2px; background: var(--border); z-index: 0; }
        
        .tl-item { display: flex; margin-bottom: 20px; position: relative; z-index: 1; }
        .tl-time { width: 50px; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-align: right; padding-right: 15px; padding-top: 14px; }
        .tl-node { width: 40px; height: 40px; border-radius: 50%; background: var(--surface); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; flex-shrink: 0; z-index: 2; }
        .tl-card { flex: 1; background: var(--surface); padding: 15px; border-radius: 16px; border: 1px solid var(--border); position: relative; }
        
        .tl-item.active .tl-node { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); transform: scale(1.1); }
        .live-badge { position: absolute; top: -10px; right: 10px; background: var(--danger); color: white; font-size: 0.65rem; padding: 4px 8px; border-radius: 10px; font-weight: 800; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- EDITOR LIST --- */
        .editor-block { display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 10px; border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border); }

        /* --- SCHOOL & AGENDA --- */
        .gpa-hero { background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; padding: 25px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .sub-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 15px; cursor: pointer; border-top: 4px solid var(--text-muted); transition: 0.2s; }
        
        .task-row { background: var(--surface); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; margin-bottom: 8px; }
        .task-row.done { opacity: 0.5; text-decoration: line-through; }
        .task-check { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 6px; margin-right: 10px; cursor: pointer; }
        .task-row.done .task-check { background: var(--success); border-color: var(--success); }

        /* FAB */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--text); color: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); cursor: pointer; z-index: 500; }

        /* Modal */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--surface); width: 90%; max-width: 450px; border-radius: 24px; padding: 25px; max-height: 90vh; overflow-y: auto; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; flex-direction: row; padding: 0; justify-content: space-evenly; border-top: 1px solid var(--border); }
            .main-content { padding: 15px; margin-bottom: 65px; }
            .fab { bottom: 85px; right: 20px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div style="font-weight:900; color:var(--primary); font-size:1.5rem; margin-bottom:20px;">V</div>
        <button class="nav-item active" onclick="nav('dashboard')">üè†</button>
        <button class="nav-item" onclick="nav('school')">üéì</button>
        <button class="nav-item" onclick="nav('timeline')">‚è±Ô∏è</button>
        <button class="nav-item" onclick="nav('schedules')">üìÖ</button>
        <button class="nav-item" onclick="nav('agenda')">‚úÖ</button>
    </nav>

    <main class="main-content">
        
        <div class="header">
            <h1 id="page-title">Dashboard</h1>
            <div id="clock" style="font-weight:700; color:var(--primary);">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="gpa-hero">
                <div>
                    <div style="opacity:0.9; font-size:0.8rem;">ACADEMIC PERFORMANCE</div>
                    <div style="font-size:2.5rem; font-weight:800; margin-top:5px;" id="dash-gpa">0%</div>
                    <div style="opacity:0.9; font-size:0.9rem;" id="dash-grade">Grade: -</div>
                </div>
                <div style="font-size:3rem;">üìä</div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>Happening Now</h3>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="now-time">--:--</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <div style="width:50px; height:50px; background:var(--primary-light); color:var(--primary); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;" id="now-icon">‚òï</div>
                    <div>
                        <div style="font-size:1.2rem; font-weight:700;" id="now-activity">Free Time</div>
                        <div style="font-size:0.9rem; color:var(--text-muted);" id="now-schedule-name">No Schedule</div>
                    </div>
                </div>
            </div>
            
            <div id="dash-agenda-preview"></div>
        </section>

        <section id="timeline" class="section">
            <div class="date-nav">
                <button class="btn-icon" onclick="changeDate(-1)">‚óÄ</button>
                <div style="text-align:center;">
                    <div style="font-weight:700;" id="tl-date-display">Today</div>
                    <div style="font-size:0.8rem; color:var(--primary);" id="tl-schedule-name">Loading...</div>
                </div>
                <button class="btn-icon" onclick="changeDate(1)">‚ñ∂</button>
            </div>

            <button class="btn" style="width:100%; margin-bottom:20px; background:var(--surface); color:var(--primary); border:1px solid var(--primary);" onclick="editCurrentDaySchedule()">
                ‚úèÔ∏è Edit This Routine
            </button>

            <div class="timeline-wrapper">
                <div class="timeline-line"></div>
                <div id="timeline-list"></div>
            </div>
        </section>

        <section id="schedules" class="section">
            <div class="card">
                <h3>Calendar Assignment</h3>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;">Assign your routines to days.</p>
                <div id="calendar-assigner"></div>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <h3>My Routines</h3>
                <button class="btn btn-sm" onclick="createSchedule()">+ New</button>
            </div>
            <div id="schedule-list"></div>
        </section>

        <section id="school" class="section">
            <div id="school-grid">
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>My Subjects</h3>
                    <button class="btn btn-sm" onclick="openSubjectModal()">+ Add</button>
                </div>
                <div class="sub-grid" id="subject-list"></div>
            </div>
        </section>

        <section id="agenda" class="section">
            <div id="agenda-container"></div>
            <div style="height:60px;"></div>
        </section>

    </main>

    <button class="fab" onclick="handleFab()">+</button>

    <div id="modal-sched" class="modal">
        <div class="modal-box">
            <h3>Edit Routine</h3>
            <input type="hidden" id="sch-id">
            <input type="text" id="sch-name" placeholder="Routine Name" style="margin:10px 0;">
            
            <div style="background:var(--bg); padding:10px; border-radius:12px; margin-bottom:10px;">
                <div style="font-size:0.8rem; font-weight:700; margin-bottom:5px;">ADD BLOCK</div>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="time" id="b-start">
                    <input type="time" id="b-end">
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="b-name" placeholder="Activity" style="flex:1;">
                    <input type="text" id="b-icon" placeholder="Emoji" style="width:50px; text-align:center;">
                    <button class="btn btn-sm" onclick="addBlockToSchedule()">+</button>
                </div>
            </div>

            <div style="max-height:250px; overflow-y:auto; margin-bottom:15px;" id="sch-blocks-list"></div>

            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1" onclick="closeModal('modal-sched')">Done</button>
            </div>
        </div>
    </div>

    <div id="modal-task" class="modal">
        <div class="modal-box">
            <h3>Add Task</h3>
            <input type="text" id="t-desc" placeholder="Task Name" style="margin:10px 0;">
            <select id="t-sub" style="margin-bottom:10px;"></select>
            <input type="date" id="t-date" style="margin-bottom:10px;">
            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1" onclick="closeModal('modal-task')">Cancel</button>
                <button class="btn" style="flex:1" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-sub" class="modal">
        <div class="modal-box">
            <h3>New Subject</h3>
            <input type="text" id="s-name" placeholder="Name" style="margin:10px 0;">
            <input type="text" id="s-room" placeholder="Room/Teacher" style="margin-bottom:10px;">
            <input type="color" id="s-color" value="#6366f1" style="width:100%; height:40px; margin-bottom:10px;">
            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1" onclick="closeModal('modal-sub')">Cancel</button>
                <button class="btn" style="flex:1" onclick="saveSubject()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let db = {
            schedules: JSON.parse(localStorage.getItem('vpfScheds')) || [
                { id: 1, name: "School Day", blocks: [
                    {id:1, name:"Wake Up", start:"07:00", end:"08:00", icon:"‚òÄÔ∏è"},
                    {id:2, name:"School", start:"08:00", end:"15:00", icon:"üè´"},
                    {id:3, name:"Study", start:"16:00", end:"18:00", icon:"üìö"}
                ]},
                { id: 2, name: "Weekend", blocks: [
                    {id:1, name:"Sleep In", start:"09:00", end:"10:00", icon:"üí§"},
                    {id:2, name:"Relax", start:"10:00", end:"22:00", icon:"üéÆ"}
                ]}
            ],
            assignments: JSON.parse(localStorage.getItem('vpfAssign')) || { 1:1, 2:1, 3:1, 4:1, 5:1, 6:2, 0:2 },
            subjects: JSON.parse(localStorage.getItem('vpfSubs')) || [],
            tasks: JSON.parse(localStorage.getItem('vpfTasks')) || [],
            grades: JSON.parse(localStorage.getItem('vpfGrades')) || [],
        };

        let selectedDate = new Date();
        let editingScheduleId = null;

        function init() {
            renderAll();
            setInterval(updateClock, 1000);
            setInterval(checkLiveStatus, 5000);
        }

        // --- TIMELINE ENGINE ---
        function changeDate(delta) {
            selectedDate.setDate(selectedDate.getDate() + delta);
            renderTimeline();
        }

        function getScheduleForDate(date) {
            const dayIdx = date.getDay(); // 0 (Sun) - 6 (Sat)
            const schedId = db.assignments[dayIdx];
            return db.schedules.find(s => s.id == schedId);
        }

        function renderTimeline() {
            const list = document.getElementById('timeline-list');
            list.innerHTML = '';
            
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            const isToday = new Date().toDateString() === selectedDate.toDateString();
            document.getElementById('tl-date-display').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', options);

            const sched = getScheduleForDate(selectedDate);
            
            if (!sched) {
                document.getElementById('tl-schedule-name').innerText = "No Routine Assigned";
                list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">No routine assigned to this day.</div>`;
                return;
            }

            document.getElementById('tl-schedule-name').innerText = sched.name;

            sched.blocks.sort((a,b) => a.start.localeCompare(b.start));
            sched.blocks.forEach(b => {
                list.innerHTML += `
                    <div class="tl-item" data-start="${b.start}" data-end="${b.end}">
                        <div class="tl-time">${b.start}</div>
                        <div class="tl-node">${b.icon}</div>
                        <div class="tl-card">
                            <div class="live-badge" style="display:none;">LIVE</div>
                            <div style="font-weight:700;">${b.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${b.start} - ${b.end}</div>
                        </div>
                    </div>`;
            });

            if(isToday) checkLiveStatus();
        }

        function checkLiveStatus() {
            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            
            // Dashboard Logic
            const sched = getScheduleForDate(now);
            if(sched) {
                const active = sched.blocks.find(b => cur >= b.start && cur < b.end);
                if(active) {
                    document.getElementById('now-activity').innerText = active.name;
                    document.getElementById('now-icon').innerText = active.icon;
                    document.getElementById('now-time').innerText = active.end;
                    document.getElementById('now-schedule-name').innerText = sched.name;
                } else {
                    document.getElementById('now-activity').innerText = "Free Time";
                    document.getElementById('now-icon').innerText = "‚òï";
                }
            }

            // Timeline Logic (Only if viewing today)
            if(selectedDate.toDateString() === now.toDateString()) {
                document.querySelectorAll('.tl-item').forEach(el => {
                    const s = el.dataset.start;
                    const e = el.dataset.end;
                    if(cur >= s && cur < e) {
                        el.classList.add('active');
                        el.querySelector('.live-badge').style.display = 'block';
                    } else {
                        el.classList.remove('active');
                        el.querySelector('.live-badge').style.display = 'none';
                    }
                });
            }
        }

        // --- NEW: EDIT CURRENT DAY SCHEDULE ---
        function editCurrentDaySchedule() {
            const sched = getScheduleForDate(selectedDate);
            if(sched) {
                editSchedule(sched.id);
            } else {
                alert("No schedule assigned to this day. Please assign one in the Schedules tab first.");
            }
        }

        // --- SCHEDULE MANAGER ---
        function renderScheduleManager() {
            // Calendar Assigner
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const cont = document.getElementById('calendar-assigner');
            cont.innerHTML = '';
            
            days.forEach((day, idx) => {
                const currentSchedId = db.assignments[idx];
                let options = `<option value="">None</option>`;
                db.schedules.forEach(s => {
                    options += `<option value="${s.id}" ${s.id == currentSchedId ? 'selected' : ''}>${s.name}</option>`;
                });
                cont.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
                        <div style="font-weight:600; width:50px;">${day}</div>
                        <select onchange="assignSchedule(${idx}, this.value)" style="padding:5px;">${options}</select>
                    </div>`;
            });

            // List
            const list = document.getElementById('schedule-list');
            list.innerHTML = '';
            db.schedules.forEach(s => {
                list.innerHTML += `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700;">${s.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${s.blocks.length} blocks</div>
                        </div>
                        <button class="btn btn-ghost" onclick="editSchedule(${s.id})">Edit</button>
                    </div>`;
            });
        }

        function assignSchedule(dayIdx, schedId) {
            db.assignments[dayIdx] = schedId;
            save(); renderTimeline();
        }

        function createSchedule() {
            const name = prompt("Routine Name:");
            if(name) {
                const newS = {id:Date.now(), name:name, blocks:[]};
                db.schedules.push(newS);
                save(); renderScheduleManager(); editSchedule(newS.id);
            }
        }

        function editSchedule(id) {
            editingScheduleId = id;
            const s = db.schedules.find(x => x.id == id);
            document.getElementById('sch-id').value = id;
            document.getElementById('sch-name').value = s.name;
            renderEditorBlocks();
            document.getElementById('modal-sched').style.display = 'flex';
        }

        function renderEditorBlocks() {
            const s = db.schedules.find(x => x.id == editingScheduleId);
            const list = document.getElementById('sch-blocks-list');
            list.innerHTML = '';
            s.blocks.sort((a,b) => a.start.localeCompare(b.start));
            
            s.blocks.forEach(b => {
                list.innerHTML += `
                    <div class="editor-block">
                        <div>
                            <div style="font-size:0.8rem; font-weight:700;">${b.icon} ${b.name}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${b.start} - ${b.end}</div>
                        </div>
                        <button onclick="removeBlock(${b.id})" style="color:var(--danger); border:none; background:none;">&times;</button>
                    </div>`;
            });
        }

        function addBlockToSchedule() {
            const start = document.getElementById('b-start').value;
            const end = document.getElementById('b-end').value;
            const name = document.getElementById('b-name').value;
            const icon = document.getElementById('b-icon').value || '‚è±Ô∏è';
            
            if(start && end && name) {
                const s = db.schedules.find(x => x.id == editingScheduleId);
                s.blocks.push({ id:Date.now(), name, start, end, icon });
                document.getElementById('b-name').value = '';
                save(); renderEditorBlocks(); renderTimeline();
            }
        }

        function removeBlock(bid) {
            const s = db.schedules.find(x => x.id == editingScheduleId);
            s.blocks = s.blocks.filter(b => b.id !== bid);
            save(); renderEditorBlocks(); renderTimeline();
        }

        // --- SCHOOL, TASKS, GENERAL ---
        function renderSchool() {
            const grid = document.getElementById('subject-list');
            grid.innerHTML = '';
            const tSub = document.getElementById('t-sub');
            tSub.innerHTML = '<option value="">General</option>';
            
            db.subjects.forEach(s => {
                tSub.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                grid.innerHTML += `
                    <div class="sub-card" style="border-top:4px solid ${s.color}">
                        <h3 style="color:${s.color}">${s.name}</h3>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${s.room}</div>
                    </div>`;
            });
            updateGPA();
        }

        function renderTasks() {
            const list = document.getElementById('agenda-container');
            list.innerHTML = '';
            const preview = document.getElementById('dash-agenda-preview');
            preview.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            db.tasks.sort((a,b) => a.date.localeCompare(b.date));
            
            db.tasks.forEach(t => {
                const s = db.subjects.find(x => x.id == t.subId);
                const html = `
                    <div class="task-row ${t.done?'done':''}">
                        <div class="task-check" onclick="toggleTask(${t.id})"></div>
                        <div style="flex:1;">
                            <div style="font-size:0.7rem; font-weight:800; color:${s?s.color:'#ccc'}">${s?s.name:'GENERAL'}</div>
                            <div class="task-title">${t.desc}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${t.date}</div>
                        </div>
                        <button onclick="delTask(${t.id})" style="border:none; background:none;">&times;</button>
                    </div>`;
                list.innerHTML += html;
                if(t.date === today && !t.done) preview.innerHTML += html;
            });
        }

        function updateGPA() {
            let total=0, max=0;
            db.grades.forEach(g => { total+=parseFloat(g.score); max+=parseFloat(g.total); });
            const pct = max > 0 ? Math.round((total/max)*100) : 0;
            document.getElementById('dash-gpa').innerText = pct + "%";
        }

        // --- UTILS ---
        function save() {
            localStorage.setItem('vpfScheds', JSON.stringify(db.schedules));
            localStorage.setItem('vpfAssign', JSON.stringify(db.assignments));
            localStorage.setItem('vpfSubs', JSON.stringify(db.subjects));
            localStorage.setItem('vpfTasks', JSON.stringify(db.tasks));
            renderAll();
        }

        function renderAll() {
            renderTimeline();
            renderScheduleManager();
            renderSchool();
            renderTasks();
        }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = Array.from(document.querySelectorAll('.nav-item')).find(b => b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
            document.getElementById('page-title').innerText = id.charAt(0).toUpperCase() + id.slice(1);
            document.querySelector('.fab').style.display = id === 'agenda' ? 'flex' : 'none';
        }

        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function saveSubject() {
            const name = document.getElementById('s-name').value;
            const room = document.getElementById('s-room').value;
            const color = document.getElementById('s-color').value;
            if(name) { db.subjects.push({id:Date.now(), name, room, color}); save(); closeModal('modal-sub'); }
        }
        function saveTask() {
            const desc = document.getElementById('t-desc').value;
            const sub = document.getElementById('t-sub').value;
            const date = document.getElementById('t-date').value;
            if(desc) { db.tasks.push({id:Date.now(), desc, subId:sub, date, done:false}); save(); closeModal('modal-task'); }
        }
        function toggleTask(id) { const t=db.tasks.find(x=>x.id==id); if(t)t.done=!t.done; save(); }
        function delTask(id) { db.tasks=db.tasks.filter(x=>x.id!==id); save(); }
        
        function openSubjectModal() { document.getElementById('modal-sub').style.display='flex'; }
        function openTaskModal() { document.getElementById('t-date').value = new Date().toISOString().split('T')[0]; document.getElementById('modal-task').style.display='flex'; }
        function handleFab() { openTaskModal(); }
        function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}); }

        init();
        nav('dashboard');
    </script>
</body>
</html>
