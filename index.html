<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi - Ultimate Fixed</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-soft: #e0e7ff;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --radius: 16px;
            --shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05);
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-light: #94a3b8;
            --border: #334155;
            --primary: #6366f1;
            --primary-soft: #1e3a8a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- LAYOUT --- */
        .sidebar { width: 75px; background: var(--card-bg); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 100; align-items: center; padding-top: 20px; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; position: relative; }
        
        .nav-btn { background: none; border: none; width: 50px; height: 50px; border-radius: 14px; color: var(--text-light); font-size: 1.5rem; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .nav-btn:hover { background: var(--bg); color: var(--primary); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { font-size: 1.6rem; font-weight: 800; letter-spacing: -0.5px; }

        /* --- COMPONENTS --- */
        .section { display: none; animation: slideUp 0.2s ease-out; padding-bottom: 80px; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 15px; position: relative; }
        
        .btn { padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; }
        .btn-ghost { background: transparent; color: var(--text-light); border: 1px solid var(--border); }
        .btn-icon { background: transparent; border: none; font-size: 1.1rem; cursor: pointer; color: var(--text-light); padding: 5px; }
        
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); outline: none; width: 100%; font-size: 0.95rem; }
        input:focus, select:focus { border-color: var(--primary); background: var(--card-bg); }

        /* --- AGENDA (School Planner Style) --- */
        .agenda-header { font-size: 0.8rem; font-weight: 800; color: var(--text-light); margin: 25px 0 10px 0; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .agenda-card { background: var(--card-bg); border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; margin-bottom: 10px; position: relative; overflow: hidden; border: 1px solid var(--border); transition: transform 0.1s; }
        .color-strip { width: 6px; flex-shrink: 0; }
        .agenda-content { flex: 1; padding: 12px 15px; }
        .agenda-subject { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 3px; }
        .agenda-title { font-size: 1rem; font-weight: 600; color: var(--text); }
        .agenda-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 5px; display: flex; align-items: center; gap: 8px; }
        .agenda-check { width: 50px; display: flex; align-items: center; justify-content: center; border-left: 1px solid var(--border); cursor: pointer; background: var(--bg); }
        .checkbox-circle { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--text-light); transition: 0.2s; }
        .agenda-card.done .agenda-title { text-decoration: line-through; opacity: 0.5; }
        .agenda-card.done .checkbox-circle { background: var(--success); border-color: var(--success); }

        /* --- SCHOOL HUB --- */
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .subject-card { background: var(--card-bg); border-radius: 12px; padding: 15px; border: 1px solid var(--border); text-align: center; cursor: pointer; transition: 0.2s; box-shadow: var(--shadow); position: relative; }
        .subject-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .subject-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        
        .grade-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .grade-badge { background: var(--bg); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; display: inline-block; }

        /* --- SETTINGS LIST --- */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); }
        .color-preview { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-right: 10px; vertical-align: middle; }

        /* --- TIMELINE --- */
        .timeline-container { position: relative; padding-left: 20px; margin-top: 20px; }
        .timeline-container::before { content: ''; position: absolute; left: 29px; top: 0; bottom: 0; width: 2px; background: var(--border); z-index: 0; }
        .timeline-block { position: relative; margin-bottom: 15px; display: flex; align-items: flex-start; z-index: 1; }
        .time-col { width: 50px; font-size: 0.8rem; color: var(--text-light); text-align: right; padding-right: 15px; padding-top: 10px; font-weight: 600; }
        .icon-col { width: 36px; height: 36px; border-radius: 50%; background: var(--card-bg); border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-right: 15px; z-index: 2; }
        .timeline-block.active .icon-col { background: var(--primary); color: white; box-shadow: 0 0 0 5px rgba(79, 70, 229, 0.2); }
        
        /* --- MODALS & PICKERS --- */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 450px; border-radius: 20px; padding: 25px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }

        .picker-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 10px; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: var(--text); transform: scale(1.1); }
        
        /* Emoji Popup */
        #emoji-popup { display: none; position: absolute; background: var(--card-bg); box-shadow: 0 5px 20px rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; z-index: 2000; width: 280px; max-height: 200px; overflow-y: auto; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .emoji-btn { font-size: 1.5rem; background: none; border: none; cursor: pointer; padding: 5px; border-radius: 5px; }
        .emoji-btn:hover { background: var(--border); }

        /* FAB */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); cursor: pointer; border: none; z-index: 500; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }

        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; flex-direction: row; padding: 0; border-top: 1px solid var(--border); border-right: none; justify-content: space-around; }
            .nav-btn { width: auto; height: 100%; margin: 0; flex: 1; border-radius: 0; margin-bottom: 0; }
            .main-content { padding: 15px; margin-bottom: 65px; }
            .fab { bottom: 85px; right: 20px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div style="font-weight: 900; color: var(--primary); margin-bottom: 20px; font-size: 1.5rem;">V</div>
        <button class="nav-btn active" onclick="nav('dashboard')" title="Dashboard">üè†</button>
        <button class="nav-btn" onclick="nav('tasks')" title="Agenda">üìÖ</button>
        <button class="nav-btn" onclick="nav('school')" title="School">üéí</button>
        <button class="nav-btn" onclick="nav('timeline')" title="Timeline">‚è±Ô∏è</button>
        <button class="nav-btn" onclick="nav('settings')" title="Settings">‚öôÔ∏è</button>
    </nav>

    <main class="main-content">
        
        <div class="header">
            <h2 id="page-title">Dashboard</h2>
            <div id="clock" style="font-weight: 600; color: var(--primary);">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="card" style="background: linear-gradient(135deg, var(--primary), #818cf8); color: white; border: none; padding: 25px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">HAPPENING NOW</div>
                    <div style="font-size: 2rem; font-weight: 800; margin: 5px 0;" id="now-title">Free Time</div>
                    <div style="font-size: 0.9rem;">Until <span id="now-end">--:--</span></div>
                </div>
                <div style="font-size: 3rem; opacity: 0.8;" id="now-icon">‚òï</div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 10px;">Due Today</h3>
                <div id="dash-agenda"></div>
            </div>
        </section>

        <section id="tasks" class="section">
            <div id="agenda-container"></div>
            <div style="text-align: center; color: var(--text-light); margin-top: 20px; font-size: 0.8rem;">
                Manage categories in Settings ‚öôÔ∏è
            </div>
            <div style="height: 60px;"></div>
        </section>

        <section id="school" class="section">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-sm btn" id="tab-sub" onclick="schoolTab('sub')">Subjects</button>
                <button class="btn-sm btn-ghost" id="tab-grd" onclick="schoolTab('grd')">Grades</button>
            </div>

            <div id="view-subjects">
                <div class="subject-grid" id="subject-list"></div>
                <button class="btn" onclick="openSubjectModal()" style="width: 100%; margin-top: 20px;">+ Add New Subject</button>
            </div>

            <div id="view-grades" style="display: none;">
                <div id="grades-list"></div>
            </div>
        </section>

        <section id="timeline" class="section">
            <div class="card">
                <h3 style="margin-bottom: 15px;">Add Routine Block</h3>
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <input type="time" id="tl-start">
                    <input type="time" id="tl-end">
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="tl-name" placeholder="Activity name..." style="flex:1;">
                    <button class="btn-ghost" onclick="showEmojiPicker(this, 'tl-name')" style="font-size: 1.2rem;">üòä</button>
                    <button class="btn" onclick="addBlock()">+</button>
                </div>
            </div>
            <div class="timeline-container" id="timeline-list"></div>
        </section>

        <section id="settings" class="section">
            
            <div class="card">
                <h3>Agenda Categories</h3>
                <div id="settings-cat-list"></div>
                <div style="margin-top: 10px; display: flex; gap: 5px; border-top: 1px dashed var(--border); padding-top: 10px;">
                    <input type="text" id="new-cat-name" placeholder="Category Name">
                    <input type="color" id="new-cat-color" value="#4f46e5" style="width: 50px; padding: 0; border: none;">
                    <button class="btn" onclick="addCategory()">+</button>
                </div>
            </div>

            <div class="card">
                <h3>Focus Timer</h3>
                <div style="margin-top: 10px;">
                    Duration: <input type="number" id="focus-dur" value="25" style="width: 60px; display: inline-block;"> mins
                    <button class="btn-sm" onclick="saveSettings()">Save</button>
                </div>
            </div>

            <div class="card">
                <h3>Data</h3>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-ghost" onclick="exportData()" style="flex:1;">Backup ‚¨áÔ∏è</button>
                    <button class="btn-ghost" onclick="document.getElementById('file-input').click()" style="flex:1;">Restore ‚¨ÜÔ∏è</button>
                    <input type="file" id="file-input" style="display:none" onchange="importData(this)">
                </div>
                <button class="btn-ghost" onclick="toggleTheme()" style="width: 100%; margin-top: 10px;">Toggle Dark Mode üåó</button>
                <button class="btn-ghost" onclick="resetApp()" style="width: 100%; color: var(--danger); margin-top: 10px;">Factory Reset</button>
            </div>
        </section>

    </main>

    <div id="modal-task" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">New Task</h3>
            <label style="font-size: 0.8rem; color: var(--text-light);">Subject</label>
            <select id="t-sub" style="margin-bottom: 10px;"></select>
            
            <label style="font-size: 0.8rem; color: var(--text-light);">Description</label>
            <input type="text" id="t-desc" placeholder="e.g. Chapter 1 Exercises" style="margin-bottom: 10px;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <select id="t-cat"></select>
                <input type="date" id="t-date">
            </div>

            <div style="display: flex; gap: 10px; align-items: center; border: 1px solid var(--border); padding: 8px; border-radius: 8px; margin-bottom: 20px;">
                <span>‚è∞ Time:</span>
                <input type="time" id="t-time" style="border:none; background:transparent;">
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-ghost" onclick="closeModal('modal-task')" style="flex:1;">Cancel</button>
                <button class="btn" onclick="addTask()" style="flex:1;">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-subject" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;" id="s-modal-title">Manage Subject</h3>
            <input type="hidden" id="s-id">
            <input type="text" id="s-name" placeholder="Subject Name" style="margin-bottom: 10px;">
            <input type="text" id="s-room" placeholder="Room / Teacher" style="margin-bottom: 10px;">
            
            <label style="font-size: 0.8rem; color: var(--text-light);">Color Code</label>
            <div id="color-picker" class="picker-grid" style="margin-bottom: 15px;"></div>
            <input type="hidden" id="s-color">

            <div style="display: flex; gap: 10px;">
                <button class="btn-ghost" onclick="closeModal('modal-subject')" style="flex:1;">Cancel</button>
                <button class="btn" onclick="saveSubject()" style="flex:1;">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-grade" class="modal">
        <div class="modal-content">
            <h3 id="grade-modal-title">Grade</h3>
            <input type="hidden" id="g-id">
            <input type="hidden" id="g-sub-id">
            <input type="text" id="g-title" placeholder="Exam Name" style="margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="number" id="g-score" placeholder="Score">
                <span style="align-self:center;">/</span>
                <input type="number" id="g-total" placeholder="Total" value="100">
            </div>
            <button class="btn" onclick="saveGrade()" style="width: 100%;">Save Grade</button>
            <button class="btn-ghost" onclick="closeModal('modal-grade')" style="width: 100%; margin-top: 10px;">Close</button>
        </div>
    </div>

    <div id="emoji-popup" style="display:none;"></div>

    <button class="fab" onclick="openTaskModal()">+</button>

    <script>
        // --- 1. DATA STORE ---
        let db = {
            subjects: JSON.parse(localStorage.getItem('vFixSub')) || [],
            tasks: JSON.parse(localStorage.getItem('vFixTasks')) || [],
            categories: JSON.parse(localStorage.getItem('vFixCats')) || [
                {id: 1, name: 'Homework', color: '#4f46e5'}, 
                {id: 2, name: 'Exam', color: '#ef4444'},
                {id: 3, name: 'Other', color: '#10b981'}
            ],
            grades: JSON.parse(localStorage.getItem('vFixGrades')) || [],
            timeline: JSON.parse(localStorage.getItem('vFixTime')) || [],
            settings: JSON.parse(localStorage.getItem('vFixSet')) || { theme: 'light', focus: 25 }
        };

        const colors = ["#4f46e5", "#ef4444", "#f59e0b", "#10b981", "#3b82f6", "#8b5cf6", "#ec4899", "#6366f1", "#14b8a6", "#f43f5e"];
        const emojis = ["üìö","üè´","üìù","üéí","üß†","üí°","üé®","‚öΩ","üéµ","üöå","üí§","üçΩÔ∏è","üöø","üéÆ","üíª","üß™","üìê","üßò","‚òï","üìÖ","üèÉ","üíä","üè†","üßπ","üõí","üéÅ","‚úàÔ∏è","üê∂","üçî","‚úèÔ∏è"];

        // --- 2. INIT & CLOCK ---
        function init() {
            if(db.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
            document.getElementById('focus-dur').value = db.settings.focus;
            renderAll();
            setInterval(updateClock, 1000);
            setInterval(checkTimeline, 1000); // Timeline auto-update
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }

        function checkTimeline() {
            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            let found = false;
            
            // Only update DOM if changes needed? For simplicity, we just check status
            // A full re-render every second is heavy, so we do it via DOM updates or check if block changed
            const activeBlock = db.timeline.find(b => cur >= b.start && cur < b.end);
            
            if(activeBlock) {
                document.getElementById('now-title').innerText = activeBlock.name;
                document.getElementById('now-icon').innerText = activeBlock.icon || '‚è±Ô∏è';
                document.getElementById('now-end').innerText = activeBlock.end;
                found = true;
            } else {
                document.getElementById('now-title').innerText = "Free Time";
                document.getElementById('now-icon').innerText = "‚òï";
                document.getElementById('now-end').innerText = "--:--";
            }
            // Highlight active block in list
            document.querySelectorAll('.timeline-block').forEach(el => {
                const start = el.dataset.start;
                const end = el.dataset.end;
                if(cur >= start && cur < end) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        // --- 3. RENDERERS ---

        function renderAll() {
            renderSubjects();
            renderTasks();
            renderTimeline();
            renderGrades();
            renderSettings();
        }

        // --- SUBJECTS ---
        function renderSubjects() {
            const list = document.getElementById('subject-list');
            const subSelect = document.getElementById('t-sub');
            list.innerHTML = '';
            subSelect.innerHTML = '';

            db.subjects.forEach(s => {
                subSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                list.innerHTML += `
                    <div class="subject-card" style="border-top: 5px solid ${s.color}">
                        <div class="subject-actions">
                            <button class="btn-icon" onclick="editSubject(${s.id})">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="delSubject(${s.id})">üóëÔ∏è</button>
                        </div>
                        <div style="font-weight:800; font-size:1.1rem; color:${s.color}; margin-top:5px;">${s.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-light);">${s.room}</div>
                    </div>`;
            });
            if(db.subjects.length === 0) list.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--text-light);">No subjects added yet.</div>`;
        }

        function openSubjectModal(id = null) {
            const modal = document.getElementById('modal-subject');
            const pGrid = document.getElementById('color-picker');
            pGrid.innerHTML = '';
            
            // Populate Color Picker
            colors.forEach(c => {
                pGrid.innerHTML += `<div class="color-swatch" style="background:${c}" onclick="pickColor('${c}', this)"></div>`;
            });

            if (id) {
                const s = db.subjects.find(x => x.id === id);
                document.getElementById('s-id').value = s.id;
                document.getElementById('s-name').value = s.name;
                document.getElementById('s-room').value = s.room;
                document.getElementById('s-color').value = s.color;
                document.getElementById('s-modal-title').innerText = "Edit Subject";
            } else {
                document.getElementById('s-id').value = '';
                document.getElementById('s-name').value = '';
                document.getElementById('s-room').value = '';
                document.getElementById('s-color').value = colors[0];
                document.getElementById('s-modal-title').innerText = "New Subject";
            }
            modal.style.display = 'flex';
        }

        function pickColor(c, el) {
            document.getElementById('s-color').value = c;
            document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('selected'));
            el.classList.add('selected');
        }

        function saveSubject() {
            const id = document.getElementById('s-id').value;
            const name = document.getElementById('s-name').value;
            const room = document.getElementById('s-room').value;
            const color = document.getElementById('s-color').value;
            if(!name) return alert("Name required");

            if(id) {
                const s = db.subjects.find(x => x.id == id);
                s.name = name; s.room = room; s.color = color;
            } else {
                db.subjects.push({ id: Date.now(), name, room, color });
            }
            closeModal('modal-subject'); saveAll();
        }

        function editSubject(id) { openSubjectModal(id); }
        function delSubject(id) { if(confirm("Delete subject?")) { db.subjects = db.subjects.filter(x => x.id !== id); saveAll(); } }

        // --- AGENDA & CATEGORIES ---
        function renderTasks() {
            const container = document.getElementById('agenda-container');
            const dash = document.getElementById('dash-agenda');
            const typeSelect = document.getElementById('t-cat');
            
            container.innerHTML = ''; dash.innerHTML = ''; typeSelect.innerHTML = '';

            // Populate Category Select
            db.categories.forEach(c => {
                typeSelect.innerHTML += `<option value="${c.name}">${c.name}</option>`;
            });

            // Grouping
            const groups = { overdue: [], today: [], tomorrow: [], future: [], done: [] };
            const todayStr = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(new Date().setDate(new Date().getDate()+1)).toISOString().split('T')[0];

            db.tasks.sort((a,b) => a.date.localeCompare(b.date));

            db.tasks.forEach(t => {
                if(t.done) { groups.done.push(t); return; }
                if(t.date < todayStr) groups.overdue.push(t);
                else if(t.date === todayStr) groups.today.push(t);
                else if(t.date === tomorrow) groups.tomorrow.push(t);
                else groups.future.push(t);
            });

            const renderGroup = (title, list, isDash) => {
                if(list.length === 0) return;
                const html = `<div class="agenda-header">${title}</div>` + list.map(t => {
                    const sub = db.subjects.find(s => s.id == t.subId) || {name: 'General', color: '#6b7280'};
                    const cat = db.categories.find(c => c.name === t.type) || {color: '#ccc'};
                    
                    return `
                    <div class="agenda-card">
                        <div class="color-strip" style="background:${cat.color}"></div>
                        <div class="agenda-content">
                            <div class="agenda-subject" style="color:${cat.color}">${sub.name} ‚Ä¢ ${t.type}</div>
                            <div class="agenda-title">${t.desc}</div>
                            <div class="agenda-meta">
                                üìÖ ${t.date} ${t.time ? 'üîî '+t.time : ''}
                            </div>
                        </div>
                        <div class="agenda-check" onclick="toggleTask(${t.id})"><div class="checkbox-circle"></div></div>
                        <button onclick="delTask(${t.id})" style="position:absolute; right:55px; top:10px; border:none; background:none; color:#ccc;">&times;</button>
                    </div>`;
                }).join('');
                container.innerHTML += html;
                if(isDash) dash.innerHTML += html;
            };

            renderGroup("Overdue", groups.overdue, true);
            renderGroup("Today", groups.today, true);
            renderGroup("Tomorrow", groups.tomorrow, false);
            renderGroup("Upcoming", groups.future, false);
            renderGroup("Completed", groups.done, false);

            if(dash.innerHTML === '') dash.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:10px;">No tasks due today.</div>';
        }

        function renderSettings() {
            const list = document.getElementById('settings-cat-list');
            list.innerHTML = '';
            db.categories.forEach(c => {
                list.innerHTML += `
                <div class="setting-item">
                    <div><span class="color-preview" style="background:${c.color}"></span>${c.name}</div>
                    <button class="btn-icon" onclick="delCategory(${c.id})">&times;</button>
                </div>`;
            });
        }

        function addCategory() {
            const name = document.getElementById('new-cat-name').value;
            const color = document.getElementById('new-cat-color').value;
            if(name) {
                db.categories.push({ id: Date.now(), name, color });
                document.getElementById('new-cat-name').value = '';
                saveAll();
            }
        }
        function delCategory(id) { if(confirm("Delete category?")) { db.categories = db.categories.filter(x=>x.id!==id); saveAll(); } }

        function openTaskModal() { document.getElementById('t-date').value = new Date().toISOString().split('T')[0]; document.getElementById('modal-task').style.display = 'flex'; }
        function addTask() {
            db.tasks.push({
                id: Date.now(),
                subId: document.getElementById('t-sub').value,
                desc: document.getElementById('t-desc').value,
                type: document.getElementById('t-type').value,
                date: document.getElementById('t-date').value,
                time: document.getElementById('t-time').value,
                done: false
            });
            closeModal('modal-task'); saveAll();
        }
        function toggleTask(id) { const t = db.tasks.find(x=>x.id==id); if(t) t.done=!t.done; saveAll(); }
        function delTask(id) { if(confirm("Delete task?")) { db.tasks=db.tasks.filter(x=>x.id!==id); saveAll(); } }

        // --- GRADES ---
        function renderGrades() {
            const list = document.getElementById('grades-list');
            list.innerHTML = '';
            db.subjects.forEach(s => {
                const sGrades = db.grades.filter(g => g.subId == s.id);
                let total = 0, max = 0;
                sGrades.forEach(g => { total += parseFloat(g.score); max += parseFloat(g.total); });
                let pct = max > 0 ? Math.round((total/max)*100) : 0;
                
                let gradesHtml = sGrades.map(g => `
                    <div class="grade-row">
                        <span>${g.title}</span>
                        <div>
                            <span style="font-weight:bold; margin-right:10px;">${g.score}/${g.total}</span>
                            <button class="btn-icon" onclick="editGrade(${g.id})">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="delGrade(${g.id})">&times;</button>
                        </div>
                    </div>`).join('');

                list.innerHTML += `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="color:${s.color}">${s.name}</h3>
                            <div class="grade-badge" style="color:${s.color}">${pct}%</div>
                        </div>
                        <div style="margin:10px 0;">${gradesHtml}</div>
                        <button class="btn-sm btn-ghost" onclick="openGradeModal(null, ${s.id})">+ Add Grade</button>
                    </div>`;
            });
        }

        function openGradeModal(id, subId) {
            if(id) {
                const g = db.grades.find(x => x.id == id);
                document.getElementById('g-id').value = g.id;
                document.getElementById('g-sub-id').value = g.subId;
                document.getElementById('g-title').value = g.title;
                document.getElementById('g-score').value = g.score;
                document.getElementById('g-total').value = g.total;
                document.getElementById('grade-modal-title').innerText = "Edit Grade";
            } else {
                document.getElementById('g-id').value = '';
                document.getElementById('g-sub-id').value = subId;
                document.getElementById('g-title').value = '';
                document.getElementById('g-score').value = '';
                document.getElementById('grade-modal-title').innerText = "Add Grade";
            }
            document.getElementById('modal-grade').style.display = 'flex';
        }

        function saveGrade() {
            const id = document.getElementById('g-id').value;
            const subId = document.getElementById('g-sub-id').value;
            const title = document.getElementById('g-title').value;
            const score = document.getElementById('g-score').value;
            const total = document.getElementById('g-total').value;

            if(id) {
                const g = db.grades.find(x => x.id == id);
                g.title = title; g.score = score; g.total = total;
            } else {
                db.grades.push({ id: Date.now(), subId, title, score, total });
            }
            closeModal('modal-grade'); saveAll();
        }
        function editGrade(id) { openGradeModal(id); }
        function delGrade(id) { if(confirm("Delete grade?")) { db.grades = db.grades.filter(x => x.id !== id); saveAll(); } }

        // --- TIMELINE ---
        function renderTimeline() {
            const list = document.getElementById('timeline-list');
            list.innerHTML = '';
            db.timeline.sort((a,b) => a.start.localeCompare(b.start));
            
            db.timeline.forEach(b => {
                list.innerHTML += `
                    <div class="timeline-block" data-start="${b.start}" data-end="${b.end}">
                        <div class="time-col">${b.start}</div>
                        <div class="icon-col">${b.icon || '‚Ä¢'}</div>
                        <div class="info-col" style="display:flex; justify-content:space-between;">
                            <div>
                                <div style="font-weight:700;">${b.name}</div>
                                <div style="font-size:0.8rem; color:var(--text-light);">${b.start} - ${b.end}</div>
                            </div>
                            <button onclick="delBlock(${b.id})" class="btn-icon">&times;</button>
                        </div>
                    </div>`;
            });
            checkTimeline(); // Force check to set active class immediately
        }

        function addBlock() {
            const name = document.getElementById('tl-name').value;
            const icon = document.getElementById('tl-name').dataset.emoji || '‚è±Ô∏è';
            const start = document.getElementById('tl-start').value;
            const end = document.getElementById('tl-end').value;
            
            if(name && start && end) {
                db.timeline.push({ id: Date.now(), name, start, end, icon });
                document.getElementById('tl-name').value = '';
                saveAll();
            }
        }
        function delBlock(id) { db.timeline = db.timeline.filter(x => x.id !== id); saveAll(); }

        // --- UTILS ---
        function saveAll() {
            localStorage.setItem('vFixSub', JSON.stringify(db.subjects));
            localStorage.setItem('vFixTasks', JSON.stringify(db.tasks));
            localStorage.setItem('vFixCats', JSON.stringify(db.categories));
            localStorage.setItem('vFixGrades', JSON.stringify(db.grades));
            localStorage.setItem('vFixTime', JSON.stringify(db.timeline));
            localStorage.setItem('vFixSet', JSON.stringify(db.settings));
            renderAll();
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function showEmojiPicker(btn, inputId) {
            const pop = document.getElementById('emoji-popup');
            pop.innerHTML = '';
            pop.style.display = 'grid';
            pop.style.top = (btn.getBoundingClientRect().bottom + window.scrollY) + 'px';
            pop.style.left = (btn.getBoundingClientRect().left - 100) + 'px';
            
            emojis.forEach(e => {
                const b = document.createElement('button');
                b.className = 'emoji-btn';
                b.innerText = e;
                b.onclick = () => {
                    const input = document.getElementById(inputId);
                    input.value = e + " " + input.value;
                    input.dataset.emoji = e;
                    pop.style.display = 'none';
                };
                pop.appendChild(b);
            });
        }
        
        // Hide picker on outside click
        window.onclick = function(event) {
            if (!event.target.matches('.btn-ghost') && !event.target.matches('.emoji-btn')) {
                document.getElementById('emoji-popup').style.display = "none";
            }
        };

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
            
            document.querySelector('.fab').style.display = id === 'tasks' ? 'flex' : 'none';
            document.getElementById('page-title').innerText = id === 'dashboard' ? 'Dashboard' : id.charAt(0).toUpperCase() + id.slice(1);
        }

        function schoolTab(t) {
            document.getElementById('view-subjects').style.display = t === 'sub' ? 'block' : 'none';
            document.getElementById('view-grades').style.display = t === 'grd' ? 'block' : 'none';
            document.getElementById('tab-sub').className = t === 'sub' ? 'btn btn-sm' : 'btn-ghost btn-sm';
            document.getElementById('tab-grd').className = t === 'grd' ? 'btn btn-sm' : 'btn-ghost btn-sm';
        }

        function toggleTheme() {
            db.settings.theme = db.settings.theme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', db.settings.theme);
            if(db.settings.theme === 'light') document.body.removeAttribute('data-theme');
            saveAll();
        }
        
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "vidyarthi_backup.json");
            dlAnchorElem.click();
        }

        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                db = JSON.parse(e.target.result);
                saveAll();
                alert("Data Restored!");
            };
            reader.readAsText(file);
        }

        function resetApp() { if(confirm("Factory Reset?")) { localStorage.clear(); location.reload(); } }

        // Start
        init();
        nav('dashboard');

    </script>
</body>
</html>
