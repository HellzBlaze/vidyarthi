<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi - LifeOS v2</title>
    <style>
        :root {
            /* Dynamic Accent Defaults */
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241;
            --primary-light: rgba(99, 102, 241, 0.15);
            
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface-2: #f1f5f9;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            
            --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="dark"] {
            --bg: #020617;
            --surface: #0f172a;
            --surface-2: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- SIDEBAR --- */
        .sidebar { width: 80px; background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 100; align-items: center; padding-top: 30px; }
        .logo { width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), #a855f7); border-radius: 14px; display: grid; place-items: center; color: white; font-weight: 900; font-size: 1.5rem; margin-bottom: 40px; box-shadow: 0 8px 20px -5px rgba(var(--primary-rgb), 0.5); }
        .nav-item { width: 50px; height: 50px; border-radius: 16px; color: var(--text-muted); font-size: 1.4rem; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); border: none; background: transparent; position: relative; }
        .nav-item:hover { background: var(--surface-2); color: var(--primary); transform: translateY(-2px); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); }
        .nav-item.active::after { content:''; position: absolute; right: -15px; height: 30px; width: 4px; background: var(--primary); border-radius: 4px 0 0 4px; }

        /* --- CONTENT --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; position: relative; max-width: 1200px; margin: 0 auto; width: 100%; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        
        .section { display: none; animation: fadeIn 0.4s ease-out; padding-bottom: 100px; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & BUTTONS --- */
        .card { background: var(--surface); border-radius: var(--radius-lg); padding: 25px; border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden; margin-bottom: 20px; }
        
        .btn { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); font-size: 0.95rem; box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.2); }
        .btn:active { transform: scale(0.96); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 2px solid var(--border); box-shadow: none; }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); background: var(--surface-2); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; border-radius: 10px; }
        .btn-icon { width: 36px; height: 36px; display: grid; place-items: center; border-radius: 10px; background: var(--surface-2); color: var(--text); border: none; cursor: pointer; }

        input, select { padding: 12px 15px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); outline: none; width: 100%; font-size: 0.95rem; transition: 0.2s; }
        input:focus { border-color: var(--primary); background: var(--surface); }

        /* --- TIMELINE (Universal) --- */
        .timeline-container { position: relative; padding-left: 20px; }
        .timeline-line { position: absolute; left: 45px; top: 15px; bottom: 15px; width: 2px; background: var(--border); z-index: 0; }
        .tl-block { display: flex; margin-bottom: 20px; position: relative; z-index: 1; gap: 15px; }
        .tl-time { width: 50px; text-align: right; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); padding-top: 12px; }
        .tl-node { width: 40px; height: 40px; border-radius: 50%; background: var(--surface); border: 2px solid var(--border); display: grid; place-items: center; font-size: 1.1rem; flex-shrink: 0; transition: var(--transition); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tl-block.school .tl-node { border-radius: 12px; } 
        .tl-card { flex: 1; background: var(--surface); border-radius: var(--radius-md); border: 1px solid var(--border); padding: 15px; display: flex; justify-content: space-between; align-items: center; transition: var(--transition); }
        .tl-block.active .tl-node { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.1); }
        .tl-block.active .tl-card { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        /* --- TOOLS GRID --- */
        .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .tool-card { background: var(--surface); padding: 25px; border-radius: var(--radius-lg); border: 1px solid var(--border); cursor: pointer; transition: var(--transition); text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 180px; }
        .tool-card:hover { transform: translateY(-5px); border-color: var(--primary); background: var(--primary-light); }
        .tool-icon { font-size: 3rem; margin-bottom: 15px; }
        .tool-title { font-weight: 700; font-size: 1.1rem; }

        /* --- FLASHCARDS --- */
        .flashcard-container { perspective: 1000px; width: 100%; height: 250px; cursor: pointer; margin-bottom: 20px; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-container.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; display: flex; align-items: center; justify-content: center; padding: 20px; font-size: 1.2rem; font-weight: 700; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .flashcard-front { background: var(--surface); color: var(--text); }
        .flashcard-back { background: var(--primary); color: white; transform: rotateY(180deg); }

        /* --- SPINNING WHEEL --- */
        #wheel-container { position: relative; width: 280px; height: 280px; margin: 0 auto 20px auto; }
        #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 4s cubic-bezier(0.1, 0.9, 0.2, 1); }
        #wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid var(--text); z-index: 10; }

        /* --- SETTINGS --- */
        .color-grid { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .color-dot { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: var(--text); }

        /* --- MODALS --- */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--surface); width: 90%; max-width: 450px; border-radius: 24px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: popIn 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* FAB */
        .fab { position: fixed; bottom: 35px; right: 35px; width: 65px; height: 65px; background: var(--text); color: var(--bg); border-radius: 20px; display: grid; place-items: center; font-size: 2rem; box-shadow: 0 15px 30px rgba(0,0,0,0.25); cursor: pointer; z-index: 500; transition: var(--transition); }
        .fab:hover { transform: scale(1.1) rotate(90deg); border-radius: 50%; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; flex-direction: row; padding: 0; justify-content: space-evenly; border-top: 1px solid var(--border); border-right: none; padding-top: 0; }
            .logo { display: none; }
            .main-content { padding: 20px; margin-bottom: 75px; }
            .fab { bottom: 95px; right: 25px; }
            .tools-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">V</div>
        <button class="nav-item active" onclick="nav('dashboard')" title="Home">üè†</button>
        <button class="nav-item" onclick="nav('timeline')" title="My Day">‚è±Ô∏è</button>
        <button class="nav-item" onclick="nav('school')" title="School">üéí</button>
        <button class="nav-item" onclick="nav('tasks')" title="Tasks">‚úÖ</button>
        <button class="nav-item" onclick="nav('tools')" title="Tools">üõ†Ô∏è</button>
        <button class="nav-item" onclick="nav('settings')" title="Settings">‚öôÔ∏è</button>
    </nav>

    <main class="main-content">
        <div class="header">
            <h1 id="page-title">Dashboard</h1>
            <div id="clock" style="font-family:monospace; font-weight:700; color:var(--primary);">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="card" style="background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; border: none; padding: 30px;">
                <div style="opacity:0.8; font-size:0.9rem; font-weight:700;">HAPPENING NOW</div>
                <div style="font-size:2.5rem; font-weight:800; margin-top:5px;" id="dash-now-title">Free Time</div>
                <div style="opacity:0.9;" id="dash-now-time">Until --:--</div>
            </div>
            
            <div class="tools-grid" style="margin-top:20px;">
                <div class="card" onclick="nav('tasks')" style="margin:0; height:120px; justify-content:center; align-items:center; display:flex; flex-direction:column; cursor:pointer;">
                    <div style="font-size:2.5rem; font-weight:900;" id="dash-task-count">0</div>
                    <div style="color:var(--text-muted); font-size:0.8rem; font-weight:700;">TASKS DUE</div>
                </div>
                <div class="card" onclick="openTool('focus')" style="margin:0; height:120px; justify-content:center; align-items:center; display:flex; cursor:pointer; background:var(--primary-light);">
                    <span style="font-size:2rem; margin-right:10px;">üçÖ</span>
                    <span style="font-weight:700; color:var(--primary);">Focus Mode</span>
                </div>
            </div>
        </section>

        <section id="timeline" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--surface); padding:10px 15px; border-radius:16px; border:1px solid var(--border);">
                <button class="btn-icon" onclick="changeDate(-1)">‚óÄ</button>
                <div style="text-align:center;">
                    <div style="font-weight:800;" id="tl-date-main">Today</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="tl-date-sub">Date</div>
                </div>
                <button class="btn-icon" onclick="changeDate(1)">‚ñ∂</button>
            </div>
            <div class="timeline-container"><div class="timeline-line"></div><div id="timeline-list"></div></div>
        </section>

        <section id="school" class="section">
            <div id="subject-list"></div>
        </section>

        <section id="tasks" class="section">
            <div id="task-list"></div>
        </section>

        <section id="tools" class="section">
            <div class="tools-grid">
                <div class="tool-card" onclick="openTool('focus')"><div class="tool-icon">üçÖ</div><div class="tool-title">Focus Timer</div></div>
                <div class="tool-card" onclick="openTool('flashcards')"><div class="tool-icon">üóÇÔ∏è</div><div class="tool-title">Flashcards</div></div>
                <div class="tool-card" onclick="openTool('wheel')"><div class="tool-icon">üé≤</div><div class="tool-title">Decision Wheel</div></div>
                <div class="tool-card" onclick="openTool('breathe')"><div class="tool-icon">üå¨Ô∏è</div><div class="tool-title">Breathe</div></div>
            </div>
        </section>

        <section id="settings" class="section">
            <div class="card">
                <h3>Appearance</h3>
                <button class="btn-ghost" style="width:100%; margin:15px 0;" onclick="toggleTheme()">Toggle Dark Mode üåó</button>
                
                <div style="font-size:0.9rem; font-weight:700; margin-bottom:10px;">Accent Color</div>
                <div class="color-grid">
                    <div class="color-dot" style="background:#6366f1" onclick="setAccent('#6366f1')"></div> <div class="color-dot" style="background:#f43f5e" onclick="setAccent('#f43f5e')"></div> <div class="color-dot" style="background:#06b6d4" onclick="setAccent('#06b6d4')"></div> <div class="color-dot" style="background:#f59e0b" onclick="setAccent('#f59e0b')"></div> <div class="color-dot" style="background:#10b981" onclick="setAccent('#10b981')"></div> <div class="color-dot" style="background:#8b5cf6" onclick="setAccent('#8b5cf6')"></div> </div>
            </div>
            
            <div class="card">
                <h3>Data & System</h3>
                <button class="btn-ghost" style="width:100%; margin-top:10px;" onclick="resetApp()">Factory Reset üóëÔ∏è</button>
            </div>
        </section>

    </main>

    <button class="fab" onclick="handleFab()">+</button>

    <div id="modal-tool-focus" class="modal">
        <div class="modal-box" style="text-align:center;">
            <div style="font-size:4rem; font-weight:900; color:var(--primary); margin:20px 0;" id="focus-display">25:00</div>
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                <button class="btn-sm btn-ghost" onclick="setFocusTime(25)">25m</button>
                <button class="btn-sm btn-ghost" onclick="setFocusTime(45)">45m</button>
                <button class="btn-sm btn-ghost" onclick="setFocusTime(60)">60m</button>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" id="focus-btn" style="flex:1;" onclick="toggleFocus()">START</button>
                <button class="btn-ghost" style="flex:1;" onclick="closeModal('modal-tool-focus')">Exit</button>
            </div>
        </div>
    </div>

    <div id="modal-tool-flashcards" class="modal">
        <div class="modal-box">
            <h3 style="margin-bottom:15px; display:flex; justify-content:space-between;">
                Flashcards 
                <button class="btn-sm btn" onclick="addFlashcardUI()">+ Add</button>
            </h3>
            
            <div id="fc-study-area" style="display:none;">
                <div class="flashcard-container" onclick="this.classList.toggle('flipped')">
                    <div class="flashcard-inner">
                        <div class="flashcard-front" id="fc-front">Question</div>
                        <div class="flashcard-back" id="fc-back">Answer</div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <button class="btn-ghost" onclick="nextCard(-1)">Prev</button>
                    <span id="fc-count">0/0</span>
                    <button class="btn" onclick="nextCard(1)">Next</button>
                </div>
            </div>

            <div id="fc-empty" style="text-align:center; padding:30px; color:var(--text-muted);">
                No cards yet. Add some to start studying!
            </div>

            <div id="fc-add-form" style="display:none; margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                <input id="fc-q" placeholder="Question (Front)" style="margin-bottom:10px;">
                <input id="fc-a" placeholder="Answer (Back)" style="margin-bottom:10px;">
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="saveFlashcard()" style="flex:1;">Save Card</button>
                    <button class="btn-ghost" onclick="toggleAddFC(false)" style="flex:1;">Cancel</button>
                </div>
            </div>
            
            <button class="btn-ghost" onclick="closeModal('modal-tool-flashcards')" style="width:100%; margin-top:20px;">Close</button>
        </div>
    </div>

    <div id="modal-tool-wheel" class="modal">
        <div class="modal-box" style="text-align:center;">
            <h3 style="margin-bottom:20px;">Decision Wheel</h3>
            <div id="wheel-container">
                <div id="wheel-pointer"></div>
                <canvas id="wheel-canvas" width="280" height="280"></canvas>
            </div>
            
            <button class="btn" onclick="spinWheel()" style="width:100%; margin-bottom:20px; font-size:1.2rem;">SPIN!</button>
            
            <div style="text-align:left;">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input id="wheel-opt" placeholder="Add option (e.g. Sleep)">
                    <button class="btn-sm btn" onclick="addWheelOption()">+</button>
                </div>
                <div id="wheel-list" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>
            
            <button class="btn-ghost" onclick="closeModal('modal-tool-wheel')" style="width:100%; margin-top:15px;">Close</button>
        </div>
    </div>

    <div id="modal-block" class="modal"><div class="modal-box"><h3>Add Activity</h3><div style="display:flex; gap:10px; margin:20px 0;"><button class="btn" id="btn-type-school" onclick="setBlockType('school')">School</button><button class="btn-ghost" id="btn-type-life" onclick="setBlockType('life')">Life</button></div><div id="input-school"><select id="b-sub" style="margin-bottom:15px;"></select></div><div id="input-life" style="display:none;"><input id="b-name" placeholder="Activity Name" style="margin-bottom:15px;"><select id="b-icon" style="margin-bottom:15px;"><option value="üßò">üßò Yoga</option><option value="üéÆ">üéÆ Game</option><option value="üí§">üí§ Sleep</option></select></div><div style="display:flex; gap:10px; margin-bottom:20px;"><input type="time" id="b-start"><input type="time" id="b-end"></div><div style="display:flex; gap:10px;"><button class="btn-ghost" style="flex:1;" onclick="closeModal('modal-block')">Cancel</button><button class="btn" style="flex:1;" onclick="saveBlock()">Save</button></div></div></div>

    <div id="modal-sub" class="modal"><div class="modal-box"><h3>Add Subject</h3><input id="s-name" placeholder="Name" style="margin:10px 0;"><input id="s-room" placeholder="Room" style="margin-bottom:10px;"><input type="color" id="s-color" value="#6366f1" style="width:100%; height:40px; margin-bottom:20px;"><button class="btn" onclick="saveSubject()" style="width:100%;">Save</button><button class="btn-ghost" onclick="closeModal('modal-sub')" style="width:100%; margin-top:10px;">Cancel</button></div></div>
    <div id="modal-task" class="modal"><div class="modal-box"><h3>Add Task</h3><input id="t-desc" placeholder="Task" style="margin:10px 0;"><select id="t-sub" style="margin-bottom:10px;"></select><input type="date" id="t-date" style="margin-bottom:20px;"><button class="btn" onclick="saveTask()" style="width:100%;">Save</button><button class="btn-ghost" onclick="closeModal('modal-task')" style="width:100%; margin-top:10px;">Cancel</button></div></div>
    <div id="modal-tool-breathe" class="modal"><div class="modal-box" style="text-align:center; padding:50px 20px;"><div style="width:150px; height:150px; background:var(--primary-light); border-radius:50%; margin:0 auto 30px auto; animation: breathe 4s infinite ease-in-out;"></div><h2 style="color:var(--primary);">Breathe In...</h2><button class="btn-ghost" onclick="closeModal('modal-tool-breathe')" style="margin-top:30px;">Close</button></div><style> @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.5); } } </style></div>

    <script>
        // --- DATA STORE ---
        let db = {
            days: JSON.parse(localStorage.getItem('vLoDays')) || {},
            subjects: JSON.parse(localStorage.getItem('vLoSubs')) || [],
            tasks: JSON.parse(localStorage.getItem('vLoTasks')) || [],
            settings: JSON.parse(localStorage.getItem('vLoSets')) || { theme: 'light', accent: '#6366f1' },
            flashcards: JSON.parse(localStorage.getItem('vLoCards')) || [],
            wheelOptions: JSON.parse(localStorage.getItem('vLoWheel')) || ["Study", "Sleep", "Eat", "Play"]
        };

        let selectedDate = new Date();
        let currentBlockType = 'school';
        let currentPage = 'dashboard';

        // --- INIT ---
        function init() {
            applyTheme();
            renderAll();
            setInterval(updateClock, 1000);
            setInterval(checkLiveStatus, 5000);
        }

        function applyTheme() {
            if(db.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
            
            // Apply Accent Variable
            const hex = db.settings.accent;
            document.documentElement.style.setProperty('--primary', hex);
            
            // Hex to RGB
            const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            document.documentElement.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
            document.documentElement.style.setProperty('--primary-light', `rgba(${r}, ${g}, ${b}, 0.15)`);
        }

        // --- FLASHCARDS LOGIC ---
        let currentCardIdx = 0;
        
        function addFlashcardUI() { toggleAddFC(true); }
        function toggleAddFC(show) { 
            document.getElementById('fc-add-form').style.display = show ? 'block' : 'none'; 
            if(!show) { document.getElementById('fc-q').value=''; document.getElementById('fc-a').value=''; }
        }
        
        function saveFlashcard() {
            const q = document.getElementById('fc-q').value, a = document.getElementById('fc-a').value;
            if(q && a) {
                db.flashcards.push({q, a});
                save(); toggleAddFC(false); renderFlashcards();
            }
        }

        function renderFlashcards() {
            const hasCards = db.flashcards.length > 0;
            document.getElementById('fc-study-area').style.display = hasCards ? 'block' : 'none';
            document.getElementById('fc-empty').style.display = hasCards ? 'none' : 'block';
            
            if(hasCards) {
                if(currentCardIdx >= db.flashcards.length) currentCardIdx = 0;
                if(currentCardIdx < 0) currentCardIdx = db.flashcards.length - 1;
                
                const card = db.flashcards[currentCardIdx];
                document.getElementById('fc-front').innerText = card.q;
                document.getElementById('fc-back').innerText = card.a;
                document.getElementById('fc-count').innerText = `${currentCardIdx+1}/${db.flashcards.length}`;
                
                // Reset flip
                document.querySelector('.flashcard-container').classList.remove('flipped');
            }
        }

        function nextCard(dir) { currentCardIdx += dir; renderFlashcards(); }

        // --- WHEEL LOGIC ---
        let wheelCtx = null;
        
        function initWheel() {
            const canvas = document.getElementById('wheel-canvas');
            wheelCtx = canvas.getContext('2d');
            drawWheel();
            renderWheelList();
        }

        function drawWheel(rotation = 0) {
            const ctx = wheelCtx;
            const size = 280;
            const center = size/2;
            const radius = size/2 - 10;
            const step = (2 * Math.PI) / db.wheelOptions.length;
            const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6'];

            ctx.clearRect(0,0,size,size);
            
            db.wheelOptions.forEach((opt, i) => {
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, radius, i*step + rotation, (i+1)*step + rotation);
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.stroke();
                
                // Text
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(i*step + step/2 + rotation);
                ctx.textAlign = "right";
                ctx.fillStyle = "white";
                ctx.font = "bold 14px sans-serif";
                ctx.fillText(opt, radius - 20, 5);
                ctx.restore();
            });
        }

        function spinWheel() {
            let rotation = 0;
            let speed = 0.5 + Math.random();
            const animate = () => {
                rotation += speed;
                speed *= 0.98; // Friction
                drawWheel(rotation);
                if(speed > 0.005) requestAnimationFrame(animate);
                else {
                    // Calc winner (simplified)
                    // In real app, calculate angle modulo 2PI
                }
            };
            animate();
        }

        function addWheelOption() {
            const val = document.getElementById('wheel-opt').value;
            if(val) { db.wheelOptions.push(val); document.getElementById('wheel-opt').value=''; save(); drawWheel(); renderWheelList(); }
        }
        function removeWheelOpt(idx) { db.wheelOptions.splice(idx, 1); save(); drawWheel(); renderWheelList(); }
        
        function renderWheelList() {
            const list = document.getElementById('wheel-list');
            list.innerHTML = db.wheelOptions.map((o,i) => `<button class="btn-sm btn-ghost" onclick="removeWheelOpt(${i})">${o} &times;</button>`).join('');
        }

        // --- TOOLS ROUTER ---
        function openTool(t) {
            if(t==='focus') document.getElementById('modal-tool-focus').style.display='flex';
            if(t==='flashcards') { document.getElementById('modal-tool-flashcards').style.display='flex'; renderFlashcards(); }
            if(t==='wheel') { document.getElementById('modal-tool-wheel').style.display='flex'; setTimeout(initWheel, 100); }
            if(t==='breathe') document.getElementById('modal-tool-breathe').style.display='flex';
        }

        // --- SETTINGS ---
        function setAccent(hex) { db.settings.accent = hex; save(); applyTheme(); }
        
        // --- TIMELINE & SCHOOL (Standard Logic) ---
        function changeDate(d) { selectedDate.setDate(selectedDate.getDate()+d); renderTimeline(); }
        
        function renderTimeline() {
            const list = document.getElementById('timeline-list');
            const preview = document.getElementById('dash-timeline-preview');
            list.innerHTML = ''; if(preview) preview.innerHTML = '';

            const isToday = new Date().toDateString() === selectedDate.toDateString();
            document.getElementById('tl-date-main').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', {weekday:'short'});
            document.getElementById('tl-date-sub').innerText = selectedDate.toLocaleDateString('en-US', {day:'numeric', month:'short'});

            const key = selectedDate.toISOString().split('T')[0];
            const blocks = db.days[key] || [];
            
            if(blocks.length === 0) {
                const empty = `<div style="text-align:center; padding:30px; color:var(--text-muted);">No plans.<br>Tap + to add.</div>`;
                list.innerHTML = empty; if(preview) preview.innerHTML = empty;
                return;
            }

            blocks.sort((a,b) => a.start.localeCompare(b.start));
            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');

            blocks.forEach(b => {
                let title, icon, color;
                if(b.type === 'school') {
                    const sub = db.subjects.find(s => s.id == b.subId) || {name:'?', color:'#ccc'};
                    title = sub.name; icon = 'üìö'; color = sub.color;
                } else {
                    title = b.name; icon = b.icon; color = 'var(--text-muted)';
                }
                const active = isToday && (cur >= b.start && cur < b.end);
                const html = `
                    <div class="tl-block ${b.type} ${active?'active':''}">
                        <div class="tl-time">${b.start}</div>
                        <div class="tl-node" style="color:${color}; border-color:${active?'var(--primary)':color}">${icon}</div>
                        <div class="tl-card" style="border-left:4px solid ${color}">
                            <div><div style="font-weight:700;">${title}</div><div style="font-size:0.8rem; color:var(--text-muted);">${b.start} - ${b.end}</div></div>
                            <button class="btn-icon" onclick="delBlock(${b.id})">üóëÔ∏è</button>
                        </div>
                    </div>`;
                list.innerHTML += html; if(preview && isToday) preview.innerHTML += html;
            });
        }

        // --- BLOCK CRUD ---
        function setBlockType(t) {
            currentBlockType = t;
            document.getElementById('btn-type-school').className = t==='school'?'btn':'btn-ghost';
            document.getElementById('btn-type-life').className = t==='life'?'btn':'btn-ghost';
            document.getElementById('input-school').style.display = t==='school'?'block':'none';
            document.getElementById('input-life').style.display = t==='life'?'block':'none';
        }
        function saveBlock() {
            const start = document.getElementById('b-start').value, end = document.getElementById('b-end').value;
            if(!start) return;
            const key = selectedDate.toISOString().split('T')[0];
            if(!db.days[key]) db.days[key] = [];
            const blk = { id:Date.now(), type:currentBlockType, start, end };
            if(currentBlockType==='school') blk.subId=document.getElementById('b-sub').value;
            else { blk.name=document.getElementById('b-name').value; blk.icon=document.getElementById('b-icon').value; }
            db.days[key].push(blk); save(); closeModal('modal-block'); renderTimeline();
        }
        function delBlock(id) {
            const key = selectedDate.toISOString().split('T')[0];
            if(confirm("Delete?")) { db.days[key]=db.days[key].filter(b=>b.id!==id); save(); renderTimeline(); }
        }

        // --- FOCUS TIMER ---
        let focusTimer=null, focusTime=1500;
        function setFocusTime(m) { focusTime=m*60; document.getElementById('focus-display').innerText=`${m}:00`; }
        function toggleFocus() {
            const btn = document.getElementById('focus-btn');
            if(focusTimer) { clearInterval(focusTimer); focusTimer=null; btn.innerText="START"; }
            else {
                btn.innerText="STOP";
                focusTimer = setInterval(() => {
                    focusTime--;
                    const m = Math.floor(focusTime/60).toString().padStart(2,'0');
                    const s = (focusTime%60).toString().padStart(2,'0');
                    document.getElementById('focus-display').innerText = `${m}:${s}`;
                    if(focusTime<=0) clearInterval(focusTimer);
                }, 1000);
            }
        }

        // --- GENERAL ---
        function renderSchool() {
            const grid=document.getElementById('subject-list');
            const subSel=document.getElementById('b-sub');
            const tSel=document.getElementById('t-sub');
            grid.innerHTML=''; subSel.innerHTML=''; tSel.innerHTML='';
            db.subjects.forEach(s => {
                subSel.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
                tSel.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
                grid.innerHTML+=`<div class="card" style="border-left:5px solid ${s.color}; margin-bottom:10px;"><h3 style="color:${s.color}">${s.name}</h3><p style="color:var(--text-muted);">${s.room}</p></div>`;
            });
        }
        function renderTasks() {
            const list=document.getElementById('task-list'); list.innerHTML='';
            const count = db.tasks.filter(t=>!t.done).length;
            document.getElementById('dash-task-count').innerText = count;
            db.tasks.forEach(t=>{
                const s = db.subjects.find(x=>x.id==t.subId);
                list.innerHTML+=`<div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center; opacity:${t.done?0.5:1}"><div><div style="font-size:0.8rem; font-weight:700; color:${s?s.color:'#ccc'}">${s?s.name:'General'}</div><div style="font-weight:600; text-decoration:${t.done?'line-through':'none'}">${t.desc}</div></div><input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="width:24px; height:24px;"></div>`;
            });
        }

        // CRUD Helpers
        function saveSubject(){ const n=document.getElementById('s-name').value; if(n){ db.subjects.push({id:Date.now(), name:n, room:document.getElementById('s-room').value, color:document.getElementById('s-color').value}); save(); closeModal('modal-sub'); } }
        function saveTask(){ const d=document.getElementById('t-desc').value; if(d){ db.tasks.push({id:Date.now(), desc:d, subId:document.getElementById('t-sub').value, date:document.getElementById('t-date').value, done:false}); save(); closeModal('modal-task'); } }
        function toggleTask(id){ const t=db.tasks.find(x=>x.id==id); if(t)t.done=!t.done; save(); }
        
        function save() { localStorage.setItem('vLoDays', JSON.stringify(db.days)); localStorage.setItem('vLoSubs', JSON.stringify(db.subjects)); localStorage.setItem('vLoTasks', JSON.stringify(db.tasks)); localStorage.setItem('vLoSets', JSON.stringify(db.settings)); localStorage.setItem('vLoCards', JSON.stringify(db.flashcards)); localStorage.setItem('vLoWheel', JSON.stringify(db.wheelOptions)); renderAll(); }
        function renderAll() { renderSchool(); renderTimeline(); renderTasks(); }
        
        function nav(id) {
            currentPage = id;
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = Array.from(document.querySelectorAll('.nav-item')).find(b=>b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
            document.querySelector('.fab').style.display = (id==='timeline'||id==='school'||id==='tasks')?'grid':'none';
            document.getElementById('page-title').innerText = id.charAt(0).toUpperCase() + id.slice(1);
        }

        function handleFab() {
            if(currentPage==='timeline') { document.getElementById('modal-block').style.display='flex'; setBlockType('school'); }
            if(currentPage==='school') document.getElementById('modal-sub').style.display='flex';
            if(currentPage==='tasks') document.getElementById('modal-task').style.display='flex';
        }

        function closeModal(id){ document.getElementById(id).style.display='none'; }
        function toggleTheme(){ db.settings.theme = db.settings.theme==='dark'?'light':'dark'; save(); location.reload(); }
        function resetApp(){ if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
        function updateClock(){ document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}); }
        function checkLiveStatus() { /* Simplified dash update for brevity */ }

        init();
        nav('dashboard');
    </script>
</body>
</html>
