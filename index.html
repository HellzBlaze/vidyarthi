<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi v1.7.17.9</title>
    <style>
        :root {
            /* Default Accent (Indigo) */
            --primary: #4f46e5;
            --primary-rgb: 79, 70, 229;
            --primary-light: #e0e7ff;
            
            /* Theme Base */
            --bg: #f3f4f6;
            --surface: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.9);
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            /* System */
            --radius: 24px;
            --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --transition: cubic-bezier(0.2, 0.8, 0.2, 1);
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-glass: rgba(30, 41, 59, 0.9);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --glass-border: 1px solid rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.4s var(--transition); }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 85px; background: var(--surface-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 100; 
            align-items: center; padding-top: 30px; transition: 0.3s;
        }
        
        .brand { 
            font-size: 1.8rem; font-weight: 900; background: linear-gradient(135deg, var(--primary), #a855f7); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; 
        }

        .nav-item { 
            width: 50px; height: 50px; border-radius: 18px; color: var(--text-muted); font-size: 1.5rem; 
            margin-bottom: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: all 0.3s var(--transition); border: none; background: transparent; position: relative;
        }
        .nav-item:hover { background: var(--bg); color: var(--primary); transform: translateY(-3px); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 10px 20px -5px rgba(var(--primary-rgb), 0.4); transform: translateY(-3px); }
        .nav-item.active::after { content:''; position: absolute; bottom: -8px; width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; position: relative; max-width: 1000px; margin: 0 auto; width: 100%; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; }
        #clock { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--primary); background: var(--primary-light); padding: 8px 16px; border-radius: 12px; }

        /* --- CARDS & UI --- */
        .section { display: none; animation: slideUp 0.4s var(--transition); padding-bottom: 120px; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--surface); border-radius: var(--radius); padding: 25px; 
            box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; 
            transition: transform 0.3s var(--transition), box-shadow 0.3s var(--transition);
        }
        
        .btn { 
            padding: 14px 24px; background: var(--primary); color: white; border: none; border-radius: 16px; 
            font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            gap: 10px; transition: 0.2s; font-size: 0.95rem; box-shadow: 0 4px 15px rgba(var(--primary-rgb), 0.3);
        }
        .btn:active { transform: scale(0.95); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 2px solid var(--border); box-shadow: none; }
        .btn-ghost:hover { border-color: var(--text); color: var(--text); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; border-radius: 10px; }
        .btn-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: none; background: transparent; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .btn-icon:hover { background: var(--bg); color: var(--text); }

        input, select { 
            padding: 14px 18px; border: 2px solid var(--border); border-radius: 16px; 
            background: var(--bg); color: var(--text); outline: none; width: 100%; 
            font-size: 1rem; transition: 0.2s; font-weight: 500;
        }
        input:focus, select:focus { border-color: var(--primary); background: var(--surface); box-shadow: 0 0 0 4px var(--primary-light); }

        /* --- üéí SUBJECT CARDS (3D Folder Style) --- */
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .sub-card { 
            background: var(--surface); border-radius: 24px; padding: 20px; cursor: pointer; 
            border: 1px solid var(--border); position: relative; overflow: hidden; 
            display: flex; flex-direction: column; justify-content: space-between; min-height: 180px;
            transition: all 0.3s var(--transition);
        }
        .sub-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: var(--shadow-hover); }
        .sub-card::before {
            content:''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; 
            background: var(--color, var(--text));
        }
        .sub-icon-box { 
            width: 50px; height: 50px; border-radius: 14px; background: var(--bg); 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px;
        }
        .sub-meta h3 { font-size: 1.2rem; font-weight: 800; margin-bottom: 4px; }
        .sub-meta p { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }
        .sub-pill { 
            position: absolute; top: 20px; right: 20px; font-size: 0.75rem; font-weight: 800; 
            padding: 5px 12px; border-radius: 20px; background: var(--surface); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); color: var(--color);
        }

        /* --- üíé HERO SECTION --- */
        .gpa-hero { 
            background: linear-gradient(135deg, var(--primary), #8b5cf6); 
            color: white; padding: 35px; border-radius: 30px; 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; box-shadow: 0 20px 40px -10px rgba(var(--primary-rgb), 0.4); 
            position: relative; overflow: hidden;
        }
        .gpa-hero::after {
            content: ''; position: absolute; top: -50%; right: -20%; width: 300px; height: 300px;
            background: rgba(255,255,255,0.1); border-radius: 50%; filter: blur(40px);
        }

        /* --- üìÖ TIMETABLE --- */
        .date-nav { display: flex; align-items: center; justify-content: space-between; background: var(--surface); padding: 12px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: var(--shadow); }
        .date-btn { width: 40px; height: 40px; border-radius: 12px; border: none; background: var(--bg); cursor: pointer; transition: 0.2s; }
        .date-btn:hover { background: var(--primary-light); color: var(--primary); }
        
        .tt-item { display: flex; gap: 20px; margin-bottom: 20px; position: relative; }
        .tt-time { width: 60px; text-align: right; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: flex; flex-direction: column; justify-content: space-between; padding: 5px 0; }
        .tt-card { 
            flex: 1; background: var(--surface); border-radius: 20px; border: 1px solid var(--border); 
            padding: 18px; position: relative; overflow: hidden; box-shadow: var(--shadow); 
            transition: 0.3s; display: flex; align-items: center; gap: 15px;
        }
        .tt-item.now .tt-card { border: 2px solid var(--primary); background: linear-gradient(to right, var(--primary-light), var(--surface)); }
        
        /* --- ‚öôÔ∏è SETTINGS --- */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .setting-card { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 20px; cursor: pointer; transition: 0.2s; }
        .setting-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .setting-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }
        
        /* Color Picker */
        .color-row { display: flex; gap: 12px; margin-top: 15px; justify-content: space-between; }
        .color-opt { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; position: relative; }
        .color-opt.active { border-color: var(--text); transform: scale(1.2); }

        /* FAB */
        .fab { position: fixed; bottom: 35px; right: 35px; width: 65px; height: 65px; background: var(--text); color: var(--bg); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 15px 30px rgba(0,0,0,0.25); cursor: pointer; z-index: 500; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fab:hover { transform: scale(1.1) rotate(90deg); border-radius: 50%; }

        /* Modal */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(8px); }
        .modal-box { background: var(--surface); width: 90%; max-width: 450px; border-radius: 30px; padding: 35px; max-height: 90vh; overflow-y: auto; box-shadow: 0 30px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; flex-direction: row; padding: 0; justify-content: space-evenly; border-top: 1px solid var(--border); border-right: none; padding-bottom: 10px; background: var(--surface); }
            .brand { display: none; }
            .main-content { padding: 20px; margin-bottom: 75px; }
            .fab { bottom: 95px; right: 25px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand">V</div>
        <button class="nav-item active" onclick="nav('dashboard')" title="Home">üè†</button>
        <button class="nav-item" onclick="nav('timetable')" title="Timetable">üìÖ</button>
        <button class="nav-item" onclick="nav('school')" title="School">üéí</button>
        <button class="nav-item" onclick="nav('agenda')" title="Tasks">‚úÖ</button>
        <button class="nav-item" onclick="nav('settings')" title="Settings">‚öôÔ∏è</button>
    </nav>

    <main class="main-content">
        
        <div class="header">
            <div>
                <div style="font-size:0.9rem; color:var(--text-muted); font-weight:600; text-transform:uppercase; letter-spacing:1px;">Welcome Back</div>
                <h1 id="page-title">Dashboard</h1>
            </div>
            <div id="clock">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="gpa-hero">
                <div>
                    <div style="opacity:0.9; font-size:0.85rem; font-weight:700; letter-spacing:1px; margin-bottom:5px;">ACADEMIC PERFORMANCE</div>
                    <div style="font-size:3.5rem; font-weight:900; line-height:1;" id="dash-gpa">0%</div>
                    <div style="opacity:0.9; font-size:1rem; margin-top:5px;" id="dash-grade">Current Grade: -</div>
                </div>
                <div style="font-size:4rem; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.2));">üéì</div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>Happening Now</h3>
                    <div style="font-size:0.9rem; font-weight:700; color:var(--primary);" id="now-time">--:--</div>
                </div>
                <div style="display:flex; align-items:center; gap:20px;">
                    <div style="width:60px; height:60px; background:var(--primary-light); color:var(--primary); border-radius:18px; display:flex; align-items:center; justify-content:center; font-size:1.8rem;">üè´</div>
                    <div>
                        <div style="font-size:1.4rem; font-weight:800;" id="now-activity">No Classes</div>
                        <div style="font-size:0.95rem; color:var(--text-muted);" id="now-room">Enjoy your free time</div>
                    </div>
                </div>
            </div>
            
            <h3 style="margin: 30px 0 15px 0;">Today's Tasks</h3>
            <div id="dash-agenda-preview"></div>
        </section>

        <section id="timetable" class="section">
            <div class="date-nav">
                <button class="date-btn" onclick="changeDate(-1)">‚óÄ</button>
                <div style="text-align:center;">
                    <div style="font-weight:800; font-size:1.2rem;" id="tt-date-main">Today</div>
                    <div style="font-size:0.9rem; color:var(--text-muted);" id="tt-date-sub">Loading...</div>
                    <div id="tt-modifier-badge" style="display:none; font-size:0.7rem; background:var(--warning); color:#fff; padding:2px 8px; border-radius:6px; margin-top:4px;">CUSTOM DAY</div>
                </div>
                <button class="date-btn" onclick="changeDate(1)">‚ñ∂</button>
            </div>

            <div style="display:none; justify-content:center; margin-bottom:20px;" id="reset-day-container">
                <button class="btn-sm btn-ghost" onclick="resetCurrentDay()" style="color:var(--danger); border-color:var(--danger);">‚Ü© Restore Weekly Schedule</button>
            </div>

            <div class="tt-list" id="timetable-list"></div>
            
            <div style="text-align:center; margin-top:40px; color:var(--text-muted);">
                <small>Tap + to add a class to <span id="tt-add-hint">this day</span></small>
            </div>
        </section>

        <section id="school" class="section">
            <div id="school-grid">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>My Courses</h3>
                    <button class="btn btn-sm" onclick="openSubjectModal()">+ Add New</button>
                </div>
                <div class="sub-grid" id="subject-list"></div>
            </div>
            
            <div id="school-detail" style="display:none; animation: slideUp 0.3s;">
                <button class="btn-ghost" onclick="closeDetail()" style="margin-bottom:20px;">‚Üê Back to Courses</button>
                
                <div class="gpa-hero" style="background: var(--surface); color: var(--text); border: 1px solid var(--border); margin-bottom: 20px;">
                    <div>
                        <h1 id="det-name" style="color:var(--primary);">Math</h1>
                        <div style="color:var(--text-muted); font-weight:600;" id="det-room">Room 101</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:2.5rem; font-weight:900;" id="det-grade-val">95%</span>
                        <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">GRADE</div>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3>Grades</h3>
                        <button class="btn-sm btn-ghost" onclick="openGradeModal()">+ New</button>
                    </div>
                    <div id="det-grades"></div>
                </div>

                <button class="btn-ghost" style="width:100%; color:var(--danger); border-color:var(--border);" onclick="deleteSubject()">Delete Course</button>
            </div>
        </section>

        <section id="agenda" class="section">
            <div id="agenda-container"></div>
            <div style="height:60px;"></div>
        </section>

        <section id="settings" class="section">
            <div class="settings-grid">
                
                <div class="setting-card">
                    <div class="setting-icon">üé®</div>
                    <div style="font-weight:700; margin-bottom:5px;">Appearance</div>
                    <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">Customize your theme</div>
                    
                    <button class="btn-ghost" style="width:100%; margin-bottom:15px;" onclick="toggleTheme()">Toggle Dark Mode</button>
                    
                    <div style="font-size:0.8rem; font-weight:700;">Accent Color</div>
                    <div class="color-row">
                        <div class="color-opt" style="background:#4f46e5" onclick="setAccent('#4f46e5', this)"></div> <div class="color-opt" style="background:#06b6d4" onclick="setAccent('#06b6d4', this)"></div> <div class="color-opt" style="background:#10b981" onclick="setAccent('#10b981', this)"></div> <div class="color-opt" style="background:#f59e0b" onclick="setAccent('#f59e0b', this)"></div> <div class="color-opt" style="background:#f43f5e" onclick="setAccent('#f43f5e', this)"></div> <div class="color-opt" style="background:#d946ef" onclick="setAccent('#d946ef', this)"></div> </div>
                </div>

                <div class="setting-card">
                    <div class="setting-icon">üíæ</div>
                    <div style="font-weight:700; margin-bottom:5px;">Data Manager</div>
                    <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">Backup and restore</div>
                    
                    <button class="btn-ghost" style="width:100%; margin-bottom:10px;" onclick="exportData()">Backup to File ‚¨áÔ∏è</button>
                    <button class="btn-ghost" style="width:100%;" onclick="document.getElementById('restore-input').click()">Restore File ‚¨ÜÔ∏è</button>
                    <input type="file" id="restore-input" style="display:none;" accept=".json" onchange="importData(this)">
                </div>

                <div class="setting-card" onclick="resetApp()" style="border-color:var(--danger);">
                    <div class="setting-icon">üóëÔ∏è</div>
                    <div style="font-weight:700; margin-bottom:5px; color:var(--danger);">Factory Reset</div>
                    <div style="font-size:0.9rem; color:var(--text-muted);">Erase all data and start fresh</div>
                </div>

            </div>
            <div style="text-align:center; color:var(--text-muted); font-size:0.8rem; margin-top:40px;">Vidyarthi v1.7.17.9</div>
        </section>

    </main>

    <button class="fab" onclick="handleFab()">+</button>

    <div id="modal-class" class="modal">
        <div class="modal-box">
            <h3>Add Class</h3>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">
                <span id="class-modal-date" style="font-weight:bold; color:var(--primary);">Today</span>
            </p>
            <label style="font-size:0.85rem; font-weight:700; margin-bottom:5px; display:block;">Subject</label>
            <select id="c-sub" style="margin-bottom:20px;"></select>
            <div style="display:flex; gap:15px; margin-bottom:25px;">
                <div style="flex:1"><label style="font-size:0.85rem; font-weight:700;">Start</label><input type="time" id="c-start"></div>
                <div style="flex:1"><label style="font-size:0.85rem; font-weight:700;">End</label><input type="time" id="c-end"></div>
            </div>
            <div style="background:var(--bg); padding:15px; border-radius:16px; margin-bottom:25px;">
                <label style="display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="c-repeat" checked style="width:auto; margin-right:10px;">
                    <span style="font-weight:600;">Repeat Weekly</span>
                </label>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1" onclick="closeModal('modal-class')">Cancel</button>
                <button class="btn" style="flex:1" onclick="saveClass()">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-task" class="modal">
        <div class="modal-box">
            <h3>New Task</h3>
            <input type="text" id="t-desc" placeholder="What needs to be done?" style="margin:20px 0 15px 0;">
            <select id="t-sub" style="margin-bottom:15px;"></select>
            <input type="date" id="t-date" style="margin-bottom:25px;">
            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1" onclick="closeModal('modal-task')">Cancel</button>
                <button class="btn" style="flex:1" onclick="saveTask()">Create</button>
            </div>
        </div>
    </div>

    <div id="modal-sub" class="modal">
        <div class="modal-box">
            <h3>Add Course</h3>
            <input type="text" id="s-name" placeholder="Course Name" style="margin:20px 0 15px 0;">
            <input type="text" id="s-room" placeholder="Room / Teacher" style="margin-bottom:15px;">
            <label style="font-size:0.85rem; font-weight:700; display:block; margin-bottom:5px;">Color Tag</label>
            <input type="color" id="s-color" value="#4f46e5" style="width:100%; height:50px; margin-bottom:25px; cursor:pointer;">
            <div style="display:flex; gap:10px;">
                <button class="btn-ghost" style="flex:1" onclick="closeModal('modal-sub')">Cancel</button>
                <button class="btn" style="flex:1" onclick="saveSubject()">Create</button>
            </div>
        </div>
    </div>

    <div id="modal-grade" class="modal">
        <div class="modal-box">
            <h3>Record Grade</h3>
            <input type="text" id="g-name" placeholder="Exam Name" style="margin:20px 0 15px 0;">
            <div style="display:flex; gap:15px; margin-bottom:25px;">
                <div style="flex:1"><label style="font-size:0.85rem;">Score</label><input type="number" id="g-score" placeholder="0"></div>
                <div style="flex:1"><label style="font-size:0.85rem;">Total</label><input type="number" id="g-total" placeholder="100"></div>
            </div>
            <button class="btn" onclick="saveGrade()" style="width:100%;">Save</button>
        </div>
    </div>

    <script>
        // --- DATA LAYER ---
        let db = {
            timetable: [], overrides: {}, subjects: [], tasks: [], grades: [], 
            settings: { theme: 'light', accent: '#4f46e5' }
        };

        // Load Robustly
        try {
            const saved = localStorage.getItem('vPro_Data');
            if(saved) db = JSON.parse(saved);
        } catch(e) { console.error("Data load error", e); }

        let selectedDate = new Date();
        let currentSubId = null;
        let currentPage = 'dashboard';

        function init() {
            applyTheme();
            renderAll();
            setInterval(updateClock, 1000);
            setInterval(checkLiveStatus, 5000);
        }

        function applyTheme() {
            if(db.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
            
            // Apply Accent
            document.documentElement.style.setProperty('--primary', db.settings.accent);
            
            // Hex to RGB for rgba usage
            const hex = db.settings.accent.replace('#','');
            const r = parseInt(hex.substring(0,2), 16);
            const g = parseInt(hex.substring(2,4), 16);
            const b = parseInt(hex.substring(4,6), 16);
            document.documentElement.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
            document.documentElement.style.setProperty('--primary-light', `rgba(${r}, ${g}, ${b}, 0.15)`);
        }

        // --- RENDERERS ---
        
        function renderSchool() {
            const grid = document.getElementById('subject-list');
            grid.innerHTML = '';
            
            const options = db.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('t-sub').innerHTML = options;
            document.getElementById('c-sub').innerHTML = options;

            if(db.subjects.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted);">No courses yet.<br>Tap "+ Add New" to start.</div>`;
                return;
            }

            db.subjects.forEach(s => {
                const sGrades = db.grades.filter(g => g.subId == s.id);
                let total=0, max=0;
                sGrades.forEach(g => { total+=parseFloat(g.score); max+=parseFloat(g.total); });
                const pct = max > 0 ? Math.round((total/max)*100) : 0;

                grid.innerHTML += `
                    <div class="sub-card" style="--color:${s.color}" onclick="openDetail(${s.id})">
                        <div class="sub-pill">${pct}%</div>
                        <div class="sub-icon-box" style="color:${s.color}; background:${s.color}15;">üìö</div>
                        <div class="sub-meta">
                            <h3>${s.name}</h3>
                            <p>${s.room}</p>
                        </div>
                        <div class="att-bar-bg"><div class="att-bar-fill" style="width:${pct}%; background:${s.color}"></div></div>
                    </div>`;
            });
            updateGPA();
        }

        function renderTimetable() {
            const list = document.getElementById('timetable-list');
            list.innerHTML = '';

            const isToday = new Date().toDateString() === selectedDate.toDateString();
            document.getElementById('tt-date-main').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', {weekday:'long'});
            document.getElementById('tt-date-sub').innerText = selectedDate.toLocaleDateString('en-US', {month:'long', day:'numeric'});
            document.getElementById('tt-add-hint').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', {weekday:'long'});

            const dateStr = selectedDate.toISOString().split('T')[0];
            let classes = db.overrides[dateStr] ? db.overrides[dateStr] : db.timetable.filter(c => c.day === selectedDate.getDay());
            
            // Indicators
            document.getElementById('tt-modifier-badge').style.display = db.overrides[dateStr] ? 'inline-block' : 'none';
            document.getElementById('reset-day-container').style.display = db.overrides[dateStr] ? 'flex' : 'none';

            if (classes.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No classes.<br>Enjoy your day!</div>`;
                return;
            }

            classes.sort((a,b) => a.start.localeCompare(b.start));
            const now = new Date();
            const curTime = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

            classes.forEach(c => {
                const sub = db.subjects.find(s => s.id == c.subId) || { name: 'Unknown', color: '#ccc', room: '?' };
                const isNow = isToday && (curTime >= c.start && curTime < c.end);

                list.innerHTML += `
                    <div class="tt-item ${isNow ? 'now' : ''}">
                        <div class="tt-time"><span>${c.start}</span><span style="opacity:0.6">${c.end}</span></div>
                        <div class="tt-card">
                            <div style="flex:1;">
                                <div style="font-weight:800; font-size:1.1rem; color:${sub.color}">${sub.name}</div>
                                <div style="font-size:0.9rem; color:var(--text-muted);">${sub.room}</div>
                            </div>
                            <button onclick="deleteClass(${c.id})" class="btn-icon">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
        }

        // --- CORE LOGIC ---
        function saveClass() {
            const subId = document.getElementById('c-sub').value;
            const start = document.getElementById('c-start').value;
            const end = document.getElementById('c-end').value;
            const repeat = document.getElementById('c-repeat').checked;
            
            if(subId && start && end) {
                const newC = { id:Date.now(), day:selectedDate.getDay(), subId, start, end };
                if(repeat) {
                    db.timetable.push(newC);
                } else {
                    const dateStr = selectedDate.toISOString().split('T')[0];
                    if(!db.overrides[dateStr]) {
                        db.overrides[dateStr] = JSON.parse(JSON.stringify(db.timetable.filter(c => c.day === selectedDate.getDay())));
                    }
                    db.overrides[dateStr].push(newC);
                }
                save(); closeModal('modal-class'); renderTimetable();
            }
        }

        function deleteClass(id) {
            const dateStr = selectedDate.toISOString().split('T')[0];
            const isOverride = !!db.overrides[dateStr];

            if(confirm("Remove this class?")) {
                if(isOverride) {
                    db.overrides[dateStr] = db.overrides[dateStr].filter(c => c.id !== id);
                } else {
                    if(confirm("Delete for ALL weeks (OK) or just TODAY (Cancel)?")) {
                        db.timetable = db.timetable.filter(c => c.id !== id);
                    } else {
                        db.overrides[dateStr] = JSON.parse(JSON.stringify(db.timetable.filter(c => c.day === selectedDate.getDay())));
                        db.overrides[dateStr] = db.overrides[dateStr].filter(c => c.id !== id);
                    }
                }
                save(); renderTimetable();
            }
        }

        function checkLiveStatus() {
            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            const dateStr = now.toISOString().split('T')[0];
            
            let classes = db.overrides[dateStr] ? db.overrides[dateStr] : db.timetable.filter(c => c.day === now.getDay());
            const active = classes.find(c => cur >= c.start && cur < c.end);

            if (active) {
                const sub = db.subjects.find(s => s.id == active.subId);
                document.getElementById('now-activity').innerText = sub.name;
                document.getElementById('now-room').innerText = sub.room;
                document.getElementById('now-time').innerText = active.end;
            } else {
                document.getElementById('now-activity').innerText = "Free Time";
                document.getElementById('now-room').innerText = "No class right now";
                document.getElementById('now-time').innerText = "--:--";
            }
            if(selectedDate.toDateString() === now.toDateString()) renderTimetable();
        }

        function renderTasks() {
            const list = document.getElementById('agenda-container');
            const preview = document.getElementById('dash-agenda-preview');
            list.innerHTML = ''; preview.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            db.tasks.sort((a,b) => a.date.localeCompare(b.date));
            
            const renderItem = (t) => {
                const sub = db.subjects.find(s => s.id == t.subId) || {name:'Personal', color:'#ccc'};
                return `
                <div class="card" style="padding:15px; display:flex; align-items:center; gap:15px; margin-bottom:10px; opacity:${t.done?0.6:1}">
                    <div class="task-check" style="width:24px; height:24px; border:2px solid var(--border); border-radius:8px; cursor:pointer; background:${t.done?'var(--success)':'transparent'}; border-color:${t.done?'var(--success)':'var(--border)'}" onclick="toggleTask(${t.id})"></div>
                    <div style="flex:1">
                        <div style="font-size:0.75rem; font-weight:800; color:${sub.color}; text-transform:uppercase; letter-spacing:0.5px;">${sub.name}</div>
                        <div style="font-weight:600; text-decoration:${t.done?'line-through':'none'}">${t.desc}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">üìÖ ${t.date}</div>
                    </div>
                    <button class="btn-icon" onclick="delTask(${t.id})">√ó</button>
                </div>`;
            };

            db.tasks.forEach(t => {
                const html = renderItem(t);
                list.innerHTML += html;
                if(!t.done && t.date === today) preview.innerHTML += html;
            });
            if(preview.innerHTML === '') preview.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:10px;">No tasks due today.</div>';
        }

        // --- BACKUP & RESTORE ---
        function exportData() {
            const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vidyarthi_v1.7.17.9_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.timetable && imported.subjects) {
                        db = imported;
                        save();
                        alert("Restored Successfully!");
                        location.reload();
                    } else alert("Invalid Backup File");
                } catch(err) { alert("Error: " + err); }
            };
            reader.readAsText(file);
        }

        // --- UTILS & CRUD ---
        function save() { localStorage.setItem('vPro_Data', JSON.stringify(db)); renderAll(); }
        function renderAll() { renderSchool(); renderTimetable(); renderTasks(); }
        function changeDate(d) { selectedDate.setDate(selectedDate.getDate() + d); renderTimetable(); }
        function resetCurrentDay() { const d=selectedDate.toISOString().split('T')[0]; delete db.overrides[d]; save(); renderTimetable(); }
        function setAccent(c) { db.settings.accent = c; save(); applyTheme(); }
        function toggleTheme() { db.settings.theme = db.settings.theme==='dark'?'light':'dark'; save(); applyTheme(); }
        function resetApp() { if(confirm("Factory Reset?")) { localStorage.clear(); location.reload(); } }
        
        function saveSubject() { const n=document.getElementById('s-name').value; if(n){db.subjects.push({id:Date.now(), name:n, room:document.getElementById('s-room').value, color:document.getElementById('s-color').value}); save(); closeModal('modal-sub');} }
        function saveTask() { const d=document.getElementById('t-desc').value; if(d){db.tasks.push({id:Date.now(), desc:d, subId:document.getElementById('t-sub').value, date:document.getElementById('t-date').value, done:false}); save(); closeModal('modal-task');} }
        function saveGrade() { const n=document.getElementById('g-name').value; if(n){db.grades.push({id:Date.now(), subId:currentSubId, name:n, score:document.getElementById('g-score').value, total:document.getElementById('g-total').value}); save(); document.getElementById('modal-grade').style.display='none'; openDetail(currentSubId);} }
        function delTask(id) { db.tasks=db.tasks.filter(t=>t.id!==id); save(); }
        function toggleTask(id) { const t=db.tasks.find(x=>x.id==id); if(t)t.done=!t.done; save(); }
        function deleteSubject() { if(confirm("Delete Course?")) { db.subjects=db.subjects.filter(x=>x.id!=currentSubId); db.timetable=db.timetable.filter(x=>x.subId!=currentSubId); save(); closeDetail(); } }

        function openDetail(id) {
            currentSubId = id;
            const s = db.subjects.find(x => x.id == id);
            document.getElementById('school-grid').style.display='none';
            document.getElementById('school-detail').style.display='block';
            document.getElementById('det-name').innerText=s.name;
            document.getElementById('det-name').style.color=s.color;
            document.getElementById('det-room').innerText=s.room;
            
            const grads = db.grades.filter(g => g.subId == id);
            const list = document.getElementById('det-grades');
            list.innerHTML = '';
            grads.forEach(g => {
                list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid var(--border);"><span>${g.name}</span><strong>${g.score}/${g.total}</strong></div>`;
            });
            
            let t=0,m=0; grads.forEach(g=>{t+=parseFloat(g.score); m+=parseFloat(g.total)});
            document.getElementById('det-grade-val').innerText = m>0 ? Math.round((t/m)*100)+'%' : '-';
        }
        
        function updateGPA() {
            let t=0,m=0; db.grades.forEach(g=>{t+=parseFloat(g.score); m+=parseFloat(g.total)});
            const pct = m>0?Math.round((t/m)*100):0;
            document.getElementById('dash-gpa').innerText = pct+'%';
            let l='F'; if(pct>=90)l='A'; else if(pct>=80)l='B'; else if(pct>=70)l='C'; else if(pct>=60)l='D';
            document.getElementById('dash-grade').innerText = 'Current Grade: '+l;
        }

        function closeDetail() { document.getElementById('school-detail').style.display='none'; document.getElementById('school-grid').style.display='grid'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function openTaskModal() { document.getElementById('t-date').value=new Date().toISOString().split('T')[0]; document.getElementById('modal-task').style.display='flex'; }
        function openSubjectModal() { document.getElementById('modal-sub').style.display='flex'; }
        function openGradeModal() { document.getElementById('modal-grade').style.display='flex'; }
        function handleFab() { if(currentPage==='timetable') { document.getElementById('class-modal-date').innerText=selectedDate.toLocaleDateString(); document.getElementById('modal-class').style.display='flex'; } else openTaskModal(); }
        
        function nav(id) {
            currentPage = id;
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = Array.from(document.querySelectorAll('.nav-item')).find(b=>b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
            document.getElementById('page-title').innerText = id.charAt(0).toUpperCase()+id.slice(1);
            document.querySelector('.fab').style.display = (id==='agenda'||id==='timetable')?'flex':'none';
        }
        function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}); }

        init();
        nav('dashboard');
    </script>
</body>
</html>
