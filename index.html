<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi - LifeOS v2.1</title>
    <style>
        :root {
            /* Dynamic Variables */
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241; 
            --primary-light: rgba(99, 102, 241, 0.15);
            
            --bg: #f8fafc;
            --surface: #ffffff;
            --surface-2: #f1f5f9;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="dark"] {
            --bg: #020617;
            --surface: #0f172a;
            --surface-2: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- SIDEBAR --- */
        .sidebar { width: 80px; background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 100; align-items: center; padding-top: 30px; }
        .logo { width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary), #a855f7); border-radius: 14px; display: grid; place-items: center; color: white; font-weight: 900; font-size: 1.5rem; margin-bottom: 40px; box-shadow: 0 8px 20px -5px rgba(var(--primary-rgb), 0.5); }
        .nav-item { width: 50px; height: 50px; border-radius: 16px; color: var(--text-muted); font-size: 1.4rem; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); border: none; background: transparent; position: relative; }
        .nav-item:hover { background: var(--surface-2); color: var(--primary); transform: translateY(-2px); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); }
        .nav-item.active::after { content:''; position: absolute; right: -15px; height: 30px; width: 4px; background: var(--primary); border-radius: 4px 0 0 4px; }

        /* --- CONTENT --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; position: relative; max-width: 1200px; margin: 0 auto; width: 100%; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        .section { display: none; animation: fadeIn 0.4s ease-out; padding-bottom: 100px; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & BUTTONS --- */
        .card { background: var(--surface); border-radius: var(--radius-lg); padding: 25px; border: 1px solid var(--border); box-shadow: var(--shadow); position: relative; overflow: hidden; margin-bottom: 20px; }
        .btn { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); font-size: 0.95rem; box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3); }
        .btn:active { transform: scale(0.96); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 2px solid var(--border); box-shadow: none; }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); background: var(--surface-2); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; border-radius: 10px; }
        .btn-icon { width: 36px; height: 36px; display: grid; place-items: center; border-radius: 10px; background: var(--surface-2); color: var(--text); border: none; cursor: pointer; }

        input, select { padding: 12px 15px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); outline: none; width: 100%; font-size: 0.95rem; transition: 0.2s; }
        input:focus { border-color: var(--primary); background: var(--surface); }

        /* --- TIMELINE --- */
        .timeline-container { position: relative; padding-left: 20px; }
        .timeline-line { position: absolute; left: 45px; top: 15px; bottom: 15px; width: 2px; background: var(--border); z-index: 0; }
        .tl-block { display: flex; margin-bottom: 20px; position: relative; z-index: 1; gap: 15px; }
        .tl-time { width: 50px; text-align: right; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); padding-top: 12px; }
        .tl-node { width: 40px; height: 40px; border-radius: 50%; background: var(--surface); border: 2px solid var(--border); display: grid; place-items: center; font-size: 1.1rem; flex-shrink: 0; transition: var(--transition); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tl-block.school .tl-node { border-radius: 12px; } 
        .tl-card { flex: 1; background: var(--surface); border-radius: var(--radius-md); border: 1px solid var(--border); padding: 15px; display: flex; justify-content: space-between; align-items: center; transition: var(--transition); }
        .tl-block.active .tl-node { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.1); }
        .tl-block.active .tl-card { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }

        /* --- TOOLS GRID --- */
        .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .tool-card { background: var(--surface); padding: 25px; border-radius: var(--radius-lg); border: 1px solid var(--border); cursor: pointer; transition: var(--transition); text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 180px; }
        .tool-card:hover { transform: translateY(-5px); border-color: var(--primary); background: var(--primary-light); }
        .tool-icon { font-size: 3rem; margin-bottom: 15px; }
        .tool-title { font-weight: 700; font-size: 1.1rem; }

        /* --- FLASHCARDS (Decks) --- */
        .deck-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .deck-card { background: var(--surface-2); padding: 20px; border-radius: 16px; text-align: center; cursor: pointer; border: 1px solid var(--border); position: relative; }
        .deck-card:hover { border-color: var(--primary); background: var(--primary-light); }
        .deck-count { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }
        
        .flashcard-container { perspective: 1000px; width: 100%; height: 250px; cursor: pointer; margin-bottom: 20px; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard-container.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; display: flex; align-items: center; justify-content: center; padding: 20px; font-size: 1.2rem; font-weight: 700; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .flashcard-front { background: var(--surface); color: var(--text); }
        .flashcard-back { background: var(--primary); color: white; transform: rotateY(180deg); }

        /* --- CALCULATOR --- */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .calc-btn { aspect-ratio: 1; border-radius: 12px; border: none; background: var(--surface-2); font-size: 1.2rem; font-weight: 600; color: var(--text); cursor: pointer; transition: 0.1s; }
        .calc-btn:active { transform: scale(0.95); }
        .calc-btn.op { background: var(--primary-light); color: var(--primary); }
        .calc-btn.eq { background: var(--primary); color: white; grid-column: span 2; aspect-ratio: auto; }
        #calc-display { width: 100%; height: 60px; background: var(--bg); border-radius: 12px; border: 1px solid var(--border); text-align: right; font-size: 2rem; padding: 10px; margin-bottom: 10px; color: var(--text); }

        /* --- SPINNING WHEEL --- */
        #wheel-container { position: relative; width: 280px; height: 280px; margin: 0 auto 20px auto; }
        #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 4s cubic-bezier(0.1, 0.9, 0.2, 1); }
        #wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid var(--text); z-index: 10; }

        /* --- SETTINGS --- */
        .color-grid { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .color-dot { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: var(--text); }

        /* --- MODALS --- */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--surface); width: 90%; max-width: 450px; border-radius: 24px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: popIn 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* FAB */
        .fab { position: fixed; bottom: 35px; right: 35px; width: 65px; height: 65px; background: var(--text); color: var(--bg); border-radius: 20px; display: grid; place-items: center; font-size: 2rem; box-shadow: 0 15px 30px rgba(0,0,0,0.25); cursor: pointer; z-index: 500; transition: var(--transition); }
        .fab:hover { transform: scale(1.1) rotate(90deg); border-radius: 50%; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; flex-direction: row; padding: 0; justify-content: space-evenly; border-top: 1px solid var(--border); border-right: none; padding-top: 0; }
            .logo { display: none; }
            .main-content { padding: 20px; margin-bottom: 75px; }
            .fab { bottom: 95px; right: 25px; }
            .tools-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">V</div>
        <button class="nav-item active" onclick="nav('dashboard')" title="Home">üè†</button>
        <button class="nav-item" onclick="nav('timeline')" title="My Day">‚è±Ô∏è</button>
        <button class="nav-item" onclick="nav('school')" title="School">üéí</button>
        <button class="nav-item" onclick="nav('tasks')" title="Tasks">‚úÖ</button>
        <button class="nav-item" onclick="nav('tools')" title="Tools">üõ†Ô∏è</button>
        <button class="nav-item" onclick="nav('settings')" title="Settings">‚öôÔ∏è</button>
    </nav>

    <main class="main-content">
        <div class="header">
            <h1 id="page-title">Dashboard</h1>
            <div id="clock" style="font-family:monospace; font-weight:700; color:var(--primary);">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="card" style="background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; border: none; padding: 30px;">
                <div style="opacity:0.8; font-size:0.9rem; font-weight:700;">HAPPENING NOW</div>
                <div style="font-size:2.5rem; font-weight:800; margin-top:5px;" id="dash-now-title">Free Time</div>
                <div style="opacity:0.9;" id="dash-now-time">Until --:--</div>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><div style="font-size:2rem; font-weight:900;" id="dash-task-count">0</div><div style="color:var(--text-muted); font-size:0.8rem; font-weight:700;">TASKS DUE</div></div>
                <button class="btn-sm btn" onclick="nav('tasks')">View</button>
            </div>
        </section>

        <section id="timeline" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--surface); padding:10px 15px; border-radius:16px; border:1px solid var(--border);">
                <button class="btn-icon" onclick="changeDate(-1)">‚óÄ</button>
                <div style="text-align:center;"><div style="font-weight:800;" id="tl-date-main">Today</div><div style="font-size:0.8rem; color:var(--text-muted);" id="tl-date-sub">Date</div></div>
                <button class="btn-icon" onclick="changeDate(1)">‚ñ∂</button>
            </div>
            <div class="timeline-container"><div class="timeline-line"></div><div id="timeline-list"></div></div>
        </section>

        <section id="school" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3>My Subjects</h3><button class="btn-sm btn-ghost" onclick="openSubjectModal()">+ Add Subject</button></div>
            <div id="subject-list"></div>
        </section>

        <section id="tasks" class="section"><div id="task-list"></div></section>

        <section id="tools" class="section">
            <div class="tools-grid">
                <div class="tool-card" onclick="openTool('focus')"><div class="tool-icon">üçÖ</div><div class="tool-title">Focus Timer</div></div>
                <div class="tool-card" onclick="openTool('flashcards')"><div class="tool-icon">üóÇÔ∏è</div><div class="tool-title">Flashcards</div></div>
                <div class="tool-card" onclick="openTool('calc')"><div class="tool-icon">üßÆ</div><div class="tool-title">Calculator</div></div>
                <div class="tool-card" onclick="openTool('wheel')"><div class="tool-icon">üé≤</div><div class="tool-title">Picker Wheel</div></div>
            </div>
        </section>

        <section id="settings" class="section">
            <div class="card">
                <h3>Appearance</h3>
                <button class="btn-ghost" style="width:100%; margin:15px 0;" onclick="toggleTheme()">Toggle Dark Mode üåó</button>
                <div style="font-size:0.9rem; font-weight:700; margin-bottom:10px;">Accent Color</div>
                <div class="color-grid">
                    <div class="color-dot" style="background:#6366f1" onclick="setAccent('#6366f1')"></div> <div class="color-dot" style="background:#f43f5e" onclick="setAccent('#f43f5e')"></div> <div class="color-dot" style="background:#06b6d4" onclick="setAccent('#06b6d4')"></div> <div class="color-dot" style="background:#f59e0b" onclick="setAccent('#f59e0b')"></div> <div class="color-dot" style="background:#10b981" onclick="setAccent('#10b981')"></div> <div class="color-dot" style="background:#8b5cf6" onclick="setAccent('#8b5cf6')"></div> </div>
            </div>
            <div class="card"><button class="btn-ghost" style="width:100%; color:var(--danger); border-color:var(--danger);" onclick="resetApp()">Factory Reset üóëÔ∏è</button></div>
        </section>

    </main>

    <button class="fab" onclick="handleFab()">+</button>

    <div id="modal-tool-calc" class="modal">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">Calculator</h3>
            <div id="calc-display">0</div>
            <div class="calc-grid">
                <button class="calc-btn op" onclick="calcClear()">C</button>
                <button class="calc-btn op" onclick="calcInput('/')">√∑</button>
                <button class="calc-btn op" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn op" onclick="calcInputBack()">‚å´</button>
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn op" onclick="calcInput('-')">-</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn op" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn eq" onclick="calcResult()">=</button>
                <button class="calc-btn" onclick="calcInput('0')" style="grid-column:span 2; aspect-ratio:auto;">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
            </div>
            <button class="btn-ghost" style="width:100%; margin-top:20px;" onclick="closeModal('modal-tool-calc')">Close</button>
        </div>
    </div>

    <div id="modal-tool-flashcards" class="modal">
        <div class="modal-box">
            <div id="fc-deck-view">
                <h3 style="margin-bottom:15px;">My Decks</h3>
                <div class="deck-grid" id="fc-deck-list"></div>
                <button class="btn" style="width:100%; margin-top:20px;" onclick="createDeck()">+ New Deck</button>
                <button class="btn-ghost" style="width:100%; margin-top:10px;" onclick="closeModal('modal-tool-flashcards')">Close</button>
            </div>

            <div id="fc-study-view" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <button class="btn-sm btn-ghost" onclick="showDeckList()">‚Üê</button>
                    <h3 id="fc-study-title">Deck</h3>
                    <button class="btn-sm btn" onclick="addCardMode()">+ Card</button>
                </div>
                
                <div id="fc-study-area">
                    <div class="flashcard-container" onclick="this.classList.toggle('flipped')">
                        <div class="flashcard-inner">
                            <div class="flashcard-front" id="fc-front">?</div>
                            <div class="flashcard-back" id="fc-back">!</div>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <button class="btn-ghost" onclick="nextCard(-1)">Prev</button>
                        <span id="fc-count">0/0</span>
                        <button class="btn" onclick="nextCard(1)">Next</button>
                    </div>
                </div>
                
                <div id="fc-add-area" style="display:none; border-top:1px solid var(--border); padding-top:15px; margin-top:15px;">
                    <input id="fc-new-q" placeholder="Question">
                    <input id="fc-new-a" placeholder="Answer">
                    <button class="btn" style="width:100%;" onclick="saveNewCard()">Save Card</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-tool-focus" class="modal"><div class="modal-box" style="text-align:center;"><div style="font-size:4rem; font-weight:900; color:var(--primary); margin:20px 0;" id="focus-display">25:00</div><div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;"><button class="btn-sm btn-ghost" onclick="setFocusTime(25)">25m</button><button class="btn-sm btn-ghost" onclick="setFocusTime(45)">45m</button></div><button class="btn" id="focus-btn" style="width:100%;" onclick="toggleFocus()">START</button><button class="btn-ghost" style="width:100%; margin-top:10px;" onclick="closeModal('modal-tool-focus')">Exit</button></div></div>

    <div id="modal-tool-wheel" class="modal"><div class="modal-box" style="text-align:center;"><h3 style="margin-bottom:20px;">Picker Wheel</h3><div id="wheel-container"><div id="wheel-pointer"></div><canvas id="wheel-canvas" width="280" height="280"></canvas></div><button class="btn" onclick="spinWheel()" style="width:100%; margin-bottom:20px;">SPIN!</button><div style="display:flex; gap:5px;"><input id="wheel-opt" placeholder="Add option"><button class="btn-sm btn" onclick="addWheelOption()">+</button></div><div id="wheel-list" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div><button class="btn-ghost" onclick="closeModal('modal-tool-wheel')" style="width:100%; margin-top:15px;">Close</button></div></div>

    <div id="modal-block" class="modal"><div class="modal-box"><h3>Add Activity</h3><div style="display:flex; gap:10px; margin:20px 0;"><button class="btn" id="btn-type-school" onclick="setBlockType('school')">School</button><button class="btn-ghost" id="btn-type-life" onclick="setBlockType('life')">Life</button></div><div id="input-school"><select id="b-sub" style="margin-bottom:15px;"></select></div><div id="input-life" style="display:none;"><input id="b-name" placeholder="Activity Name" style="margin-bottom:15px;"><select id="b-icon" style="margin-bottom:15px;"><option value="üßò">üßò Yoga</option><option value="üéÆ">üéÆ Game</option><option value="üí§">üí§ Sleep</option></select></div><div style="display:flex; gap:10px; margin-bottom:20px;"><input type="time" id="b-start"><input type="time" id="b-end"></div><div style="display:flex; gap:10px;"><button class="btn-ghost" style="flex:1;" onclick="closeModal('modal-block')">Cancel</button><button class="btn" style="flex:1;" onclick="saveBlock()">Save</button></div></div></div>
    <div id="modal-sub" class="modal"><div class="modal-box"><h3>Add Subject</h3><input id="s-name" placeholder="Name" style="margin:10px 0;"><input id="s-room" placeholder="Room" style="margin-bottom:10px;"><input type="color" id="s-color" value="#6366f1" style="width:100%; height:40px; margin-bottom:20px;"><button class="btn" onclick="saveSubject()" style="width:100%;">Save</button><button class="btn-ghost" onclick="closeModal('modal-sub')" style="width:100%; margin-top:10px;">Cancel</button></div></div>
    <div id="modal-task" class="modal"><div class="modal-box"><h3>Add Task</h3><input id="t-desc" placeholder="Task" style="margin:10px 0;"><select id="t-sub" style="margin-bottom:10px;"></select><input type="date" id="t-date" style="margin-bottom:20px;"><button class="btn" onclick="saveTask()" style="width:100%;">Save</button><button class="btn-ghost" onclick="closeModal('modal-task')" style="width:100%; margin-top:10px;">Cancel</button></div></div>

    <script>
        // --- DATA ---
        let db = {
            days: JSON.parse(localStorage.getItem('vLoDays')) || {},
            subjects: JSON.parse(localStorage.getItem('vLoSubs')) || [],
            tasks: JSON.parse(localStorage.getItem('vLoTasks')) || [],
            settings: JSON.parse(localStorage.getItem('vLoSets')) || { theme: 'light', accent: '#6366f1' },
            flashcardSets: JSON.parse(localStorage.getItem('vLoDecks')) || [], // Changed to Sets
            wheelOptions: JSON.parse(localStorage.getItem('vLoWheel')) || ["Study", "Sleep", "Eat", "Play"]
        };

        let selectedDate = new Date();
        let currentBlockType = 'school';
        let currentPage = 'dashboard';

        function init() {
            applyTheme();
            renderAll();
            setInterval(updateClock, 1000);
            setInterval(checkLiveStatus, 5000);
        }

        // --- ACCENT SYSTEM (FIXED) ---
        function applyTheme() {
            if(db.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
            setAccentVars(db.settings.accent);
        }

        function setAccent(hex) {
            db.settings.accent = hex;
            setAccentVars(hex);
            save();
        }

        function setAccentVars(hex) {
            document.documentElement.style.setProperty('--primary', hex);
            // Convert Hex to RGB
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            document.documentElement.style.setProperty('--primary-rgb', `${r}, ${g}, ${b}`);
            document.documentElement.style.setProperty('--primary-light', `rgba(${r}, ${g}, ${b}, 0.15)`);
        }

        // --- CALCULATOR TOOL ---
        let calcVal = "";
        function calcInput(c) { calcVal += c; document.getElementById('calc-display').innerText = calcVal; }
        function calcInputBack() { calcVal = calcVal.slice(0, -1); document.getElementById('calc-display').innerText = calcVal || "0"; }
        function calcClear() { calcVal = ""; document.getElementById('calc-display').innerText = "0"; }
        function calcResult() { try { calcVal = eval(calcVal).toString(); document.getElementById('calc-display').innerText = calcVal; } catch(e) { document.getElementById('calc-display').innerText = "Error"; calcVal=""; } }

        // --- FLASHCARDS (SETS) ---
        let activeDeckId = null;
        let cardIndex = 0;

        function renderDeckList() {
            const grid = document.getElementById('fc-deck-list');
            grid.innerHTML = '';
            if(db.flashcardSets.length === 0) grid.innerHTML = `<div style="text-align:center; color:var(--text-muted); grid-column:1/-1;">No decks created.</div>`;
            
            db.flashcardSets.forEach(d => {
                grid.innerHTML += `
                    <div class="deck-card" onclick="openDeck(${d.id})">
                        <div style="font-weight:700;">${d.name}</div>
                        <div class="deck-count">${d.cards.length} cards</div>
                    </div>`;
            });
        }

        function createDeck() {
            const name = prompt("Deck Name:");
            if(name) {
                db.flashcardSets.push({ id: Date.now(), name: name, cards: [] });
                save(); renderDeckList();
            }
        }

        function openDeck(id) {
            activeDeckId = id;
            cardIndex = 0;
            document.getElementById('fc-deck-view').style.display = 'none';
            document.getElementById('fc-study-view').style.display = 'block';
            
            const deck = db.flashcardSets.find(d => d.id === id);
            document.getElementById('fc-study-title').innerText = deck.name;
            renderStudyCard();
        }

        function showDeckList() {
            document.getElementById('fc-study-view').style.display = 'none';
            document.getElementById('fc-deck-view').style.display = 'block';
            document.getElementById('fc-add-area').style.display = 'none';
        }

        function renderStudyCard() {
            const deck = db.flashcardSets.find(d => d.id === activeDeckId);
            if (!deck || deck.cards.length === 0) {
                document.getElementById('fc-front').innerText = "Empty Deck";
                document.getElementById('fc-back').innerText = "Add cards +";
                document.getElementById('fc-count').innerText = "0/0";
                return;
            }
            
            if (cardIndex >= deck.cards.length) cardIndex = 0;
            if (cardIndex < 0) cardIndex = deck.cards.length - 1;

            const card = deck.cards[cardIndex];
            document.getElementById('fc-front').innerText = card.q;
            document.getElementById('fc-back').innerText = card.a;
            document.getElementById('fc-count').innerText = `${cardIndex + 1}/${deck.cards.length}`;
            document.querySelector('.flashcard-container').classList.remove('flipped');
        }

        function nextCard(dir) { cardIndex += dir; renderStudyCard(); }
        function addCardMode() { document.getElementById('fc-add-area').style.display = 'block'; }
        
        function saveNewCard() {
            const q = document.getElementById('fc-new-q').value;
            const a = document.getElementById('fc-new-a').value;
            if(q && a) {
                const deck = db.flashcardSets.find(d => d.id === activeDeckId);
                deck.cards.push({q, a});
                save();
                document.getElementById('fc-new-q').value = '';
                document.getElementById('fc-new-a').value = '';
                document.getElementById('fc-add-area').style.display = 'none';
                renderStudyCard();
            }
        }

        // --- WHEEL ---
        let wheelCtx = null;
        function initWheel() {
            const canvas = document.getElementById('wheel-canvas');
            wheelCtx = canvas.getContext('2d');
            drawWheel(); renderWheelList();
        }
        function drawWheel(rotation = 0) {
            const ctx = wheelCtx;
            const size = 280, center = size/2, radius = size/2 - 10;
            const step = (2 * Math.PI) / db.wheelOptions.length;
            const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6'];
            ctx.clearRect(0,0,size,size);
            db.wheelOptions.forEach((opt, i) => {
                ctx.beginPath(); ctx.moveTo(center, center);
                ctx.arc(center, center, radius, i*step + rotation, (i+1)*step + rotation);
                ctx.fillStyle = colors[i % colors.length]; ctx.fill(); ctx.stroke();
                ctx.save(); ctx.translate(center, center);
                ctx.rotate(i*step + step/2 + rotation); ctx.textAlign = "right";
                ctx.fillStyle = "white"; ctx.font = "bold 14px sans-serif";
                ctx.fillText(opt, radius - 20, 5); ctx.restore();
            });
        }
        function spinWheel() {
            let rotation = 0, speed = 0.5 + Math.random();
            const animate = () => {
                rotation += speed; speed *= 0.98;
                drawWheel(rotation);
                if(speed > 0.005) requestAnimationFrame(animate);
            };
            animate();
        }
        function addWheelOption() { const val = document.getElementById('wheel-opt').value; if(val) { db.wheelOptions.push(val); document.getElementById('wheel-opt').value=''; save(); drawWheel(); renderWheelList(); } }
        function removeWheelOpt(idx) { db.wheelOptions.splice(idx, 1); save(); drawWheel(); renderWheelList(); }
        function renderWheelList() { document.getElementById('wheel-list').innerHTML = db.wheelOptions.map((o,i) => `<button class="btn-sm btn-ghost" onclick="removeWheelOpt(${i})">${o} &times;</button>`).join(''); }

        // --- STANDARD APP LOGIC ---
        function changeDate(d) { selectedDate.setDate(selectedDate.getDate()+d); renderTimeline(); }
        function renderTimeline() {
            const list = document.getElementById('timeline-list'); list.innerHTML = '';
            const isToday = new Date().toDateString() === selectedDate.toDateString();
            document.getElementById('tl-date-main').innerText = isToday ? "Today" : selectedDate.toLocaleDateString('en-US', {weekday:'short'});
            document.getElementById('tl-date-sub').innerText = selectedDate.toLocaleDateString('en-US', {day:'numeric', month:'short'});
            const key = selectedDate.toISOString().split('T')[0];
            const blocks = db.days[key] || [];
            if(blocks.length === 0) { list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No plans. Tap +</div>`; return; }
            blocks.sort((a,b) => a.start.localeCompare(b.start));
            const cur = new Date().getHours().toString().padStart(2,'0')+":"+new Date().getMinutes().toString().padStart(2,'0');
            blocks.forEach(b => {
                let title, icon, color;
                if(b.type === 'school') { const sub = db.subjects.find(s => s.id == b.subId) || {name:'?', color:'#ccc'}; title = sub.name; icon = 'üìö'; color = sub.color; }
                else { title = b.name; icon = b.icon; color = 'var(--text-muted)'; }
                const active = isToday && (cur >= b.start && cur < b.end);
                list.innerHTML += `<div class="tl-block ${b.type} ${active?'active':''}"><div class="tl-time">${b.start}</div><div class="tl-node" style="color:${color}; border-color:${active?'var(--primary)':color}">${icon}</div><div class="tl-card" style="border-left:4px solid ${color}"><div><div style="font-weight:700;">${title}</div><div style="font-size:0.8rem; color:var(--text-muted);">${b.start} - ${b.end}</div></div><button class="btn-icon" onclick="delBlock(${b.id})">üóëÔ∏è</button></div></div>`;
            });
        }
        function saveBlock() {
            const start = document.getElementById('b-start').value, end = document.getElementById('b-end').value;
            if(!start) return;
            const key = selectedDate.toISOString().split('T')[0];
            if(!db.days[key]) db.days[key] = [];
            const blk = { id:Date.now(), type:currentBlockType, start, end };
            if(currentBlockType==='school') blk.subId=document.getElementById('b-sub').value;
            else { blk.name=document.getElementById('b-name').value; blk.icon=document.getElementById('b-icon').value; }
            db.days[key].push(blk); save(); closeModal('modal-block'); renderTimeline();
        }
        function delBlock(id) { const key = selectedDate.toISOString().split('T')[0]; if(confirm("Delete?")) { db.days[key]=db.days[key].filter(b=>b.id!==id); save(); renderTimeline(); } }
        function saveSubject(){ const n=document.getElementById('s-name').value; if(n){ db.subjects.push({id:Date.now(), name:n, room:document.getElementById('s-room').value, color:document.getElementById('s-color').value}); save(); closeModal('modal-sub'); renderAll(); } }
        function saveTask(){ const d=document.getElementById('t-desc').value; if(d){ db.tasks.push({id:Date.now(), desc:d, subId:document.getElementById('t-sub').value, date:document.getElementById('t-date').value, done:false}); save(); closeModal('modal-task'); renderAll(); } }
        function toggleTask(id){ const t=db.tasks.find(x=>x.id==id); if(t)t.done=!t.done; save(); renderTasks(); }
        
        function renderSchool() {
            const grid=document.getElementById('subject-list'), subSel=document.getElementById('b-sub'), tSel=document.getElementById('t-sub');
            grid.innerHTML=''; subSel.innerHTML=''; tSel.innerHTML='';
            db.subjects.forEach(s => {
                subSel.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
                tSel.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
                grid.innerHTML+=`<div class="card" style="border-left:5px solid ${s.color}; margin-bottom:10px;"><h3 style="color:${s.color}">${s.name}</h3><p style="color:var(--text-muted);">${s.room}</p></div>`;
            });
        }
        function renderTasks() {
            const list=document.getElementById('task-list'); list.innerHTML='';
            document.getElementById('dash-task-count').innerText = db.tasks.filter(t=>!t.done).length;
            db.tasks.forEach(t=>{
                const s = db.subjects.find(x=>x.id==t.subId);
                list.innerHTML+=`<div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center; opacity:${t.done?0.5:1}"><div><div style="font-size:0.8rem; font-weight:700; color:${s?s.color:'#ccc'}">${s?s.name:'General'}</div><div style="font-weight:600; text-decoration:${t.done?'line-through':'none'}">${t.desc}</div></div><input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="width:24px; height:24px;"></div>`;
            });
        }

        // System
        function save() { localStorage.setItem('vLoDays', JSON.stringify(db.days)); localStorage.setItem('vLoSubs', JSON.stringify(db.subjects)); localStorage.setItem('vLoTasks', JSON.stringify(db.tasks)); localStorage.setItem('vLoSets', JSON.stringify(db.settings)); localStorage.setItem('vLoDecks', JSON.stringify(db.flashcardSets)); localStorage.setItem('vLoWheel', JSON.stringify(db.wheelOptions)); renderAll(); }
        function renderAll() { renderSchool(); renderTimeline(); renderTasks(); }
        function openTool(t) {
            if(t==='focus') document.getElementById('modal-tool-focus').style.display='flex';
            if(t==='calc') document.getElementById('modal-tool-calc').style.display='flex';
            if(t==='flashcards') { document.getElementById('modal-tool-flashcards').style.display='flex'; renderDeckList(); }
            if(t==='wheel') { document.getElementById('modal-tool-wheel').style.display='flex'; setTimeout(initWheel, 100); }
        }
        function nav(id) { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); const btn = Array.from(document.querySelectorAll('.nav-item')).find(b=>b.onclick.toString().includes(id)); if(btn) btn.classList.add('active'); currentPage=id; document.querySelector('.fab').style.display = (id==='timeline'||id==='school'||id==='tasks')?'grid':'none'; }
        function handleFab() { if(currentPage==='timeline') { document.getElementById('modal-block').style.display='flex'; setBlockType('school'); } if(currentPage==='school') document.getElementById('modal-sub').style.display='flex'; if(currentPage==='tasks') document.getElementById('modal-task').style.display='flex'; }
        function closeModal(id){ document.getElementById(id).style.display='none'; }
        function toggleTheme(){ db.settings.theme = db.settings.theme==='dark'?'light':'dark'; save(); location.reload(); }
        function resetApp(){ if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
        function updateClock(){ document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}); }
        function checkLiveStatus(){ const now=new Date(); const cur=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0'); const key=now.toISOString().split('T')[0]; const blocks=db.days[key]||[]; const active=blocks.find(b=>cur>=b.start&&cur<b.end); if(active) { let name = active.type==='school'?(db.subjects.find(s=>s.id==active.subId)?.name):active.name; document.getElementById('dash-now-title').innerText=name; document.getElementById('dash-now-time').innerText=`Until ${active.end}`; } else { document.getElementById('dash-now-title').innerText="Free Time"; document.getElementById('dash-now-time').innerText="--:--"; } if(selectedDate.toDateString()===now.toDateString()) renderTimeline(); }
        function setBlockType(t){ currentBlockType = t; document.getElementById('btn-type-school').className = t==='school'?'btn':'btn-ghost'; document.getElementById('btn-type-life').className = t==='life'?'btn':'btn-ghost'; document.getElementById('input-school').style.display = t==='school'?'block':'none'; document.getElementById('input-life').style.display = t==='life'?'block':'none'; }
        
        // Focus Timer
        let focusTimer=null, focusTime=1500;
        function setFocusTime(m) { focusTime=m*60; document.getElementById('focus-display').innerText=`${m}:00`; }
        function toggleFocus() { const btn=document.getElementById('focus-btn'); if(focusTimer) { clearInterval(focusTimer); focusTimer=null; btn.innerText="START"; } else { btn.innerText="STOP"; focusTimer=setInterval(()=>{ focusTime--; const m=Math.floor(focusTime/60).toString().padStart(2,'0'); const s=(focusTime%60).toString().padStart(2,'0'); document.getElementById('focus-display').innerText=`${m}:${s}`; if(focusTime<=0) clearInterval(focusTimer); },1000); } }

        init();
        nav('dashboard');
    </script>
</body>
</html>
