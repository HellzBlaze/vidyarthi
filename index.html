<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vidyarthi - Ultimate</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-soft: #e0e7ff;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --radius: 16px;
            --shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05);
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --text-light: #94a3b8;
            --border: #334155;
            --primary: #6366f1;
            --primary-soft: #1e3a8a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; transition: background 0.3s; }

        /* --- LAYOUT --- */
        .sidebar { width: 75px; background: var(--card-bg); display: flex; flex-direction: column; border-right: 1px solid var(--border); z-index: 100; align-items: center; padding-top: 20px; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; position: relative; }
        
        .nav-btn { background: none; border: none; width: 50px; height: 50px; border-radius: 14px; color: var(--text-light); font-size: 1.5rem; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .nav-btn:hover { background: var(--bg); color: var(--primary); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { font-size: 1.6rem; font-weight: 800; letter-spacing: -0.5px; }

        /* --- COMPONENTS --- */
        .section { display: none; animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); padding-bottom: 80px; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 15px; position: relative; }
        
        .btn { padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; }
        .btn-ghost { background: transparent; color: var(--text-light); border: 1px solid var(--border); }
        
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); outline: none; width: 100%; font-size: 0.95rem; }
        input:focus, select:focus { border-color: var(--primary); background: var(--card-bg); }

        /* --- AGENDA (SCHOOL PLANNER EXACT) --- */
        .agenda-header { font-size: 0.8rem; font-weight: 800; color: var(--text-light); margin: 25px 0 10px 0; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .agenda-card { background: var(--card-bg); border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; margin-bottom: 10px; position: relative; overflow: hidden; border: 1px solid var(--border); transition: transform 0.1s; }
        .agenda-card:active { transform: scale(0.99); }
        .color-strip { width: 6px; flex-shrink: 0; }
        .agenda-content { flex: 1; padding: 12px 15px; }
        .agenda-subject { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 3px; }
        .agenda-title { font-size: 1rem; font-weight: 600; color: var(--text); }
        .agenda-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 5px; display: flex; align-items: center; gap: 8px; }
        .agenda-check { width: 50px; display: flex; align-items: center; justify-content: center; border-left: 1px solid var(--border); cursor: pointer; background: var(--bg); }
        .checkbox-circle { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--text-light); transition: 0.2s; }
        .agenda-card.done .agenda-title { text-decoration: line-through; opacity: 0.5; }
        .agenda-card.done .checkbox-circle { background: var(--success); border-color: var(--success); }

        /* --- SUBJECT & GRADES --- */
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .subject-card { background: var(--card-bg); border-radius: 12px; padding: 15px; border: 1px solid var(--border); text-align: center; cursor: pointer; transition: 0.2s; box-shadow: var(--shadow); }
        .subject-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .grade-badge { background: var(--bg); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.8rem; display: inline-block; margin-top: 5px; }
        .grade-a { color: var(--success); } .grade-b { color: var(--primary); } .grade-c { color: var(--warning); } .grade-f { color: var(--danger); }

        /* --- EMOJI & COLOR PICKER --- */
        .picker-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 10px; max-height: 150px; overflow-y: auto; }
        .emoji-btn { font-size: 1.5rem; background: var(--bg); border: none; border-radius: 8px; cursor: pointer; padding: 5px; }
        .emoji-btn:hover { background: var(--border); }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
        .color-btn.selected { border-color: var(--text); transform: scale(1.1); }

        /* --- TIMELINE --- */
        .timeline-container { position: relative; padding-left: 20px; margin-top: 20px; }
        .timeline-container::before { content: ''; position: absolute; left: 29px; top: 0; bottom: 0; width: 2px; background: var(--border); z-index: 0; }
        .timeline-block { position: relative; margin-bottom: 15px; display: flex; align-items: flex-start; z-index: 1; }
        .icon-col { width: 36px; height: 36px; border-radius: 50%; background: var(--card-bg); border: 2px solid var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-right: 15px; z-index: 2; }
        .timeline-block.active .icon-col { background: var(--primary); color: white; box-shadow: 0 0 0 5px rgba(79, 70, 229, 0.2); }

        /* --- MODALS --- */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 450px; border-radius: 20px; padding: 25px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }

        /* --- FAB --- */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); cursor: pointer; border: none; z-index: 500; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }

        @media (max-width: 768px) {
            body { flex-direction: column; height: 100vh; }
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; flex-direction: row; padding: 0; border-top: 1px solid var(--border); border-right: none; justify-content: space-around; }
            .nav-btn { width: auto; height: 100%; margin: 0; flex: 1; border-radius: 0; margin-bottom: 0; }
            .main-content { padding: 15px; margin-bottom: 65px; }
            .fab { bottom: 85px; right: 20px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div style="font-weight: 900; color: var(--primary); margin-bottom: 20px; font-size: 1.5rem;">V</div>
        <button class="nav-btn active" onclick="nav('dashboard')" title="Dashboard">üè†</button>
        <button class="nav-btn" onclick="nav('tasks')" title="Agenda">üìÖ</button>
        <button class="nav-btn" onclick="nav('school')" title="School">üéí</button>
        <button class="nav-btn" onclick="nav('timeline')" title="Timeline">‚è±Ô∏è</button>
        <button class="nav-btn" onclick="nav('settings')" title="Settings">‚öôÔ∏è</button>
    </nav>

    <main class="main-content">
        
        <div class="header">
            <h2 id="page-title">Dashboard</h2>
            <div id="clock" style="font-weight: 600; color: var(--primary);">00:00</div>
        </div>

        <section id="dashboard" class="section active">
            <div class="card" style="background: linear-gradient(135deg, var(--primary), #818cf8); color: white; border: none; padding: 25px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">HAPPENING NOW</div>
                    <div style="font-size: 2rem; font-weight: 800; margin: 5px 0;" id="now-title">Free Time</div>
                    <div style="font-size: 0.9rem;">Until <span id="now-end">--:--</span></div>
                </div>
                <div style="font-size: 3rem; opacity: 0.8;" id="now-icon">‚òï</div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 10px;">Due Today</h3>
                <div id="dash-agenda"></div>
            </div>
        </section>

        <section id="tasks" class="section">
            <div id="agenda-container"></div>
            <div style="text-align: center; color: var(--text-light); margin-top: 20px; font-size: 0.8rem;">
                Tap + to add Homework, Exams, or Reminders
            </div>
            <div style="height: 60px;"></div>
        </section>

        <section id="school" class="section">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-sm btn" id="tab-sub" onclick="schoolTab('sub')">Subjects</button>
                <button class="btn-sm btn-ghost" id="tab-grd" onclick="schoolTab('grd')">Grades</button>
            </div>

            <div id="view-subjects">
                <div class="subject-grid" id="subject-list"></div>
                <button class="btn" onclick="openSubjectModal()" style="width: 100%; margin-top: 20px;">+ Add New Subject</button>
            </div>

            <div id="view-grades" style="display: none;">
                <div id="grades-list"></div>
            </div>
        </section>

        <section id="timeline" class="section">
            <div class="card">
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <input type="time" id="tl-start">
                    <input type="time" id="tl-end">
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="tl-name" placeholder="Activity name..." style="flex:1;">
                    <button class="btn-ghost" onclick="toggleEmojiPicker(this, 'tl-name')" style="font-size: 1.2rem;">üòä</button>
                    <button class="btn" onclick="addBlock()">+</button>
                </div>
            </div>
            <div class="timeline-container" id="timeline-list"></div>
        </section>

        <section id="settings" class="section">
            <div class="card">
                <h3>Data Management</h3>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-ghost" onclick="exportData()" style="flex:1;">Backup Data ‚¨áÔ∏è</button>
                    <button class="btn-ghost" onclick="document.getElementById('file-input').click()" style="flex:1;">Restore ‚¨ÜÔ∏è</button>
                    <input type="file" id="file-input" style="display:none" onchange="importData(this)">
                </div>
            </div>
            
            <div class="card">
                <h3>Focus Timer Settings</h3>
                <div style="margin-top: 10px;">
                    Duration: <input type="number" id="focus-dur" value="25" style="width: 60px; display: inline-block;"> mins
                    <button class="btn-sm" onclick="saveSettings()">Save</button>
                </div>
            </div>

            <div class="card">
                <button class="btn-ghost" onclick="toggleTheme()" style="width: 100%; margin-bottom: 10px;">Toggle Dark Mode üåó</button>
                <button class="btn-ghost" onclick="resetApp()" style="width: 100%; color: var(--danger); border-color: var(--danger);">Factory Reset</button>
            </div>
        </section>

    </main>

    <div id="modal-task" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">New Task</h3>
            <label style="font-size: 0.8rem; color: var(--text-light);">Subject</label>
            <select id="t-sub" style="margin-bottom: 10px;"></select>
            
            <label style="font-size: 0.8rem; color: var(--text-light);">Task Info</label>
            <input type="text" id="t-desc" placeholder="Description (e.g. Chapter 1)" style="margin-bottom: 10px;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <select id="t-type">
                    <option value="Homework">Homework</option>
                    <option value="Exam">Exam</option>
                    <option value="Project">Project</option>
                    <option value="Reminder">Reminder</option>
                </select>
                <input type="date" id="t-date">
            </div>

            <div style="display: flex; gap: 10px; align-items: center; border: 1px solid var(--border); padding: 8px; border-radius: 8px; margin-bottom: 20px;">
                <span>‚è∞ Time:</span>
                <input type="time" id="t-time" style="border:none; background:transparent;">
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-ghost" onclick="closeModal('modal-task')" style="flex:1;">Cancel</button>
                <button class="btn" onclick="addTask()" style="flex:1;">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-subject" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">Manage Subject</h3>
            <input type="hidden" id="s-id">
            <input type="text" id="s-name" placeholder="Subject Name (e.g. Math)" style="margin-bottom: 10px;">
            <input type="text" id="s-room" placeholder="Room / Teacher" style="margin-bottom: 10px;">
            
            <label style="font-size: 0.8rem; color: var(--text-light);">Color Code</label>
            <div id="color-picker" class="picker-grid" style="margin-bottom: 15px;">
                </div>
            <input type="color" id="s-color-custom" style="width: 100%; height: 40px; margin-bottom: 20px;">

            <div style="display: flex; gap: 10px;">
                <button class="btn-ghost" onclick="closeModal('modal-subject')" style="flex:1;">Cancel</button>
                <button class="btn" onclick="saveSubject()" style="flex:1;">Save Subject</button>
            </div>
        </div>
    </div>

    <div id="modal-grade" class="modal">
        <div class="modal-content">
            <h3 id="grade-modal-title">Add Grade</h3>
            <input type="hidden" id="g-sub-id">
            <input type="text" id="g-title" placeholder="Exam Name (e.g. Midterm)" style="margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="number" id="g-score" placeholder="Score">
                <span style="align-self:center;">/</span>
                <input type="number" id="g-total" placeholder="Total" value="100">
            </div>
            <button class="btn" onclick="saveGrade()" style="width: 100%;">Add Grade</button>
            <button class="btn-ghost" onclick="closeModal('modal-grade')" style="width: 100%; margin-top: 10px;">Close</button>
        </div>
    </div>

    <div id="emoji-popup" style="display: none; position: absolute; background: var(--card-bg); box-shadow: 0 5px 20px rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; z-index: 2000; width: 250px;">
        <div class="picker-grid" id="emoji-grid"></div>
    </div>

    <button class="fab" onclick="openTaskModal()">+</button>

    <script>
        // --- 1. DATA STORE ---
        let db = {
            subjects: JSON.parse(localStorage.getItem('vUltSub')) || [
                { id: 1, name: "Math", room: "Rm 101", color: "#4f46e5", attendance: {p:0, a:0, l:0} },
                { id: 2, name: "Science", room: "Lab A", color: "#10b981", attendance: {p:0, a:0, l:0} },
                { id: 3, name: "English", room: "Rm 204", color: "#f59e0b", attendance: {p:0, a:0, l:0} }
            ],
            tasks: JSON.parse(localStorage.getItem('vUltTasks')) || [],
            grades: JSON.parse(localStorage.getItem('vUltGrades')) || [],
            timeline: JSON.parse(localStorage.getItem('vUltTime')) || [],
            settings: JSON.parse(localStorage.getItem('vUltSet')) || { theme: 'light', focus: 25 }
        };

        const colors = ["#4f46e5", "#ef4444", "#f59e0b", "#10b981", "#3b82f6", "#8b5cf6", "#ec4899", "#6366f1", "#14b8a6", "#f43f5e"];
        const emojis = ["üìö","üè´","üìù","üéí","üß†","üí°","üé®","‚öΩ","üéµ","üöå","üí§","üçΩÔ∏è","üöø","üéÆ","üíª","üß™","üìê","üßò","‚òï","üìÖ","üèÉ","üíä","üè†","üßπ","üõí","üéÅ","‚úàÔ∏è","üê∂","üçî","‚úèÔ∏è"];

        // --- 2. INIT ---
        function init() {
            if(db.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
            document.getElementById('focus-dur').value = db.settings.focus;
            renderAll();
            setInterval(() => {
                updateClock();
                checkTimeline();
            }, 1000);
        }

        // --- 3. NAVIGATION ---
        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // Highlight Btn
            const btn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
            
            document.querySelector('.fab').style.display = (id === 'tasks') ? 'flex' : 'none';
            document.getElementById('page-title').innerText = id === 'dashboard' ? 'Dashboard' : id.charAt(0).toUpperCase() + id.slice(1);
        }

        function schoolTab(tab) {
            document.getElementById('view-subjects').style.display = tab === 'sub' ? 'block' : 'none';
            document.getElementById('view-grades').style.display = tab === 'grd' ? 'block' : 'none';
            document.getElementById('tab-sub').className = tab === 'sub' ? 'btn btn-sm' : 'btn-ghost btn-sm';
            document.getElementById('tab-grd').className = tab === 'grd' ? 'btn btn-sm' : 'btn-ghost btn-sm';
        }

        // --- 4. RENDERERS ---

        function renderAll() {
            renderSubjects();
            renderTasks();
            renderTimeline();
            renderGrades();
        }

        // --- SUBJECTS & GRADES ---
        function renderSubjects() {
            const list = document.getElementById('subject-list');
            list.innerHTML = '';
            const tSub = document.getElementById('t-sub');
            tSub.innerHTML = '';

            db.subjects.forEach(s => {
                // Populate Dropdown
                tSub.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                
                // Subject Card
                list.innerHTML += `
                    <div class="subject-card" style="border-top: 5px solid ${s.color}" onclick="editSubject(${s.id})">
                        <div style="font-weight:800; font-size:1.1rem; color:${s.color}">${s.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-light);">${s.room}</div>
                        <div style="margin-top:10px; font-size:0.8rem;">
                            Attendance: <span style="color:var(--success)">${s.attendance.p}</span> / <span style="color:var(--danger)">${s.attendance.a}</span>
                        </div>
                    </div>`;
            });
        }

        function renderGrades() {
            const list = document.getElementById('grades-list');
            list.innerHTML = '';

            db.subjects.forEach(s => {
                // Filter grades for this subject
                const sGrades = db.grades.filter(g => g.subId == s.id);
                let total = 0, max = 0;
                sGrades.forEach(g => { total += parseFloat(g.score); max += parseFloat(g.total); });
                
                let percent = max > 0 ? Math.round((total/max)*100) : 0;
                let letter = getGradeLetter(percent);

                let gradesHtml = sGrades.map(g => `
                    <div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid var(--border); font-size:0.9rem;">
                        <span>${g.title}</span>
                        <span>${g.score}/${g.total}</span>
                        <button onclick="delGrade(${g.id})" style="border:none; background:none; color:var(--text-light); cursor:pointer;">&times;</button>
                    </div>
                `).join('');

                list.innerHTML += `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="color:${s.color}">${s.name}</h3>
                            <div class="grade-badge ${letter === 'A' ? 'grade-a' : letter === 'B' ? 'grade-b' : letter === 'F' ? 'grade-f' : 'grade-c'}">
                                ${percent}% (${letter})
                            </div>
                        </div>
                        <div style="margin: 10px 0;">${gradesHtml}</div>
                        
                        <div style="display:flex; gap:5px; margin-top:10px; padding-top:10px; border-top:1px dashed var(--border);">
                            <button class="btn-sm btn-ghost" onclick="addGradeModal(${s.id}, '${s.name}')">+ Grade</button>
                            <div style="flex:1"></div>
                            <button class="btn-sm" style="background:#d1fae5; color:#065f46" onclick="att(${s.id}, 'p')">P</button>
                            <button class="btn-sm" style="background:#fee2e2; color:#991b1b" onclick="att(${s.id}, 'a')">A</button>
                            <button class="btn-sm" style="background:#fef3c7; color:#92400e" onclick="att(${s.id}, 'l')">L</button>
                        </div>
                    </div>
                `;
            });
        }

        function getGradeLetter(p) {
            if(p >= 90) return 'A'; if(p >= 80) return 'B'; if(p >= 70) return 'C'; if(p >= 60) return 'D'; return 'F';
        }

        // --- TASKS (AGENDA) ---
        function renderTasks() {
            const container = document.getElementById('agenda-container');
            const dash = document.getElementById('dash-agenda');
            container.innerHTML = ''; dash.innerHTML = '';

            // Grouping Logic
            const groups = { overdue: [], today: [], tomorrow: [], future: [], done: [] };
            const todayStr = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(new Date().setDate(new Date().getDate()+1)).toISOString().split('T')[0];

            db.tasks.sort((a,b) => a.date.localeCompare(b.date));

            db.tasks.forEach(t => {
                if(t.done) { groups.done.push(t); return; }
                if(t.date < todayStr) groups.overdue.push(t);
                else if(t.date === todayStr) groups.today.push(t);
                else if(t.date === tomorrow) groups.tomorrow.push(t);
                else groups.future.push(t);
            });

            // Render Groups
            const renderGroup = (title, list, isDash) => {
                if(list.length === 0) return;
                const html = `<div class="agenda-header">${title}</div>` + list.map(t => {
                    const sub = db.subjects.find(s => s.id == t.subId) || {name:'Unknown', color:'#ccc'};
                    return `
                    <div class="agenda-card">
                        <div class="color-strip" style="background:${sub.color}"></div>
                        <div class="agenda-content">
                            <div class="agenda-subject" style="color:${sub.color}">${sub.name} ‚Ä¢ ${t.type}</div>
                            <div class="agenda-title">${t.desc}</div>
                            <div class="agenda-meta">
                                üìÖ ${t.date} ${t.time ? 'üîî '+t.time : ''}
                            </div>
                        </div>
                        <div class="agenda-check" onclick="toggleTask(${t.id})"><div class="checkbox-circle"></div></div>
                        <button onclick="delTask(${t.id})" style="position:absolute; right:55px; top:10px; border:none; background:none; color:#ccc;">&times;</button>
                    </div>`;
                }).join('');
                
                container.innerHTML += html;
                if(isDash) dash.innerHTML += html;
            };

            renderGroup("Overdue", groups.overdue, true);
            renderGroup("Today", groups.today, true);
            renderGroup("Tomorrow", groups.tomorrow, false);
            renderGroup("Upcoming", groups.future, false);
            renderGroup("Completed", groups.done, false);
            
            if(dash.innerHTML === '') dash.innerHTML = '<div style="text-align:center; color:var(--text-light); padding:10px;">No tasks due today.</div>';
        }

        // --- TIMELINE ---
        function renderTimeline() {
            const list = document.getElementById('timeline-list');
            list.innerHTML = '';
            db.timeline.sort((a,b) => a.start.localeCompare(b.start));

            const now = new Date();
            const cur = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            let found = false;

            db.timeline.forEach(b => {
                const active = (cur >= b.start && cur < b.end);
                if(active) {
                    found = true;
                    document.getElementById('now-title').innerText = b.name;
                    document.getElementById('now-icon').innerText = b.icon || '‚è±Ô∏è';
                    document.getElementById('now-end').innerText = b.end;
                }
                list.innerHTML += `
                    <div class="timeline-block ${active ? 'active' : ''}">
                        <div class="time-col">${b.start}</div>
                        <div class="icon-col">${b.icon || '‚Ä¢'}</div>
                        <div class="info-col" style="display:flex; justify-content:space-between;">
                            <div>
                                <div style="font-weight:700;">${b.name}</div>
                                <div style="font-size:0.8rem; color:var(--text-light);">${b.start} - ${b.end}</div>
                            </div>
                            <button onclick="delBlock(${b.id})" style="border:none; background:none; color:var(--text-light);">&times;</button>
                        </div>
                    </div>`;
            });
            if(!found) {
                document.getElementById('now-title').innerText = "Free Time";
                document.getElementById('now-icon').innerText = "‚òï";
                document.getElementById('now-end').innerText = "--:--";
            }
        }

        // --- CRUD OPERATIONS ---
        
        function saveAll() {
            localStorage.setItem('vUltSub', JSON.stringify(db.subjects));
            localStorage.setItem('vUltTasks', JSON.stringify(db.tasks));
            localStorage.setItem('vUltGrades', JSON.stringify(db.grades));
            localStorage.setItem('vUltTime', JSON.stringify(db.timeline));
            localStorage.setItem('vUltSet', JSON.stringify(db.settings));
            renderAll();
        }

        // Task
        function openTaskModal() { document.getElementById('t-date').value = new Date().toISOString().split('T')[0]; document.getElementById('modal-task').style.display='flex'; }
        function addTask() {
            db.tasks.push({
                id: Date.now(),
                subId: document.getElementById('t-sub').value,
                desc: document.getElementById('t-desc').value,
                type: document.getElementById('t-type').value,
                date: document.getElementById('t-date').value,
                time: document.getElementById('t-time').value,
                done: false
            });
            closeModal('modal-task'); saveAll();
        }
        function toggleTask(id) { const t = db.tasks.find(x=>x.id==id); if(t) t.done=!t.done; saveAll(); }
        function delTask(id) { if(confirm('Delete?')) { db.tasks=db.tasks.filter(x=>x.id!==id); saveAll(); } }

        // Subject
        function openSubjectModal() {
            // Setup Color Picker
            const grid = document.getElementById('color-picker');
            grid.innerHTML = '';
            colors.forEach(c => grid.innerHTML += `<div class="color-btn" style="background:${c}" onclick="pickColor('${c}', this)"></div>`);
            document.getElementById('modal-subject').style.display='flex';
        }
        function pickColor(c, el) { 
            document.getElementById('s-color-custom').value = c; 
            document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('selected'));
            el.classList.add('selected');
        }
        function saveSubject() {
            db.subjects.push({
                id: Date.now(),
                name: document.getElementById('s-name').value,
                room: document.getElementById('s-room').value,
                color: document.getElementById('s-color-custom').value,
                attendance: {p:0, a:0, l:0}
            });
            closeModal('modal-subject'); saveAll();
        }
        function att(id, type) { const s = db.subjects.find(x=>x.id==id); s.attendance[type]++; saveAll(); }

        // Grade
        function addGradeModal(sid, sname) {
            document.getElementById('g-sub-id').value = sid;
            document.getElementById('grade-modal-title').innerText = "Add Grade: " + sname;
            document.getElementById('modal-grade').style.display = 'flex';
        }
        function saveGrade() {
            db.grades.push({
                id: Date.now(),
                subId: document.getElementById('g-sub-id').value,
                title: document.getElementById('g-title').value,
                score: document.getElementById('g-score').value,
                total: document.getElementById('g-total').value
            });
            closeModal('modal-grade'); saveAll();
        }
        function delGrade(id) { db.grades=db.grades.filter(x=>x.id!==id); saveAll(); }

        // Timeline
        function addBlock() {
            const name = document.getElementById('tl-name').value;
            const icon = document.getElementById('tl-name').dataset.emoji || '‚è±Ô∏è';
            db.timeline.push({
                id: Date.now(),
                start: document.getElementById('tl-start').value,
                end: document.getElementById('tl-end').value,
                name: name,
                icon: icon
            });
            saveAll();
        }
        function delBlock(id) { db.timeline = db.timeline.filter(x=>x.id!==id); saveAll(); }

        // --- UTILS ---
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        // Emoji Picker
        function toggleEmojiPicker(btn, inputId) {
            const pop = document.getElementById('emoji-popup');
            const rect = btn.getBoundingClientRect();
            pop.style.top = (rect.bottom + window.scrollY) + 'px';
            pop.style.left = (rect.left - 100) + 'px';
            pop.style.display = 'block';
            
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';
            emojis.forEach(e => {
                grid.innerHTML += `<button class="emoji-btn" onclick="insertEmoji('${e}', '${inputId}')">${e}</button>`;
            });
        }
        function insertEmoji(e, inputId) {
            const input = document.getElementById(inputId);
            input.value = e + " " + input.value;
            input.dataset.emoji = e;
            document.getElementById('emoji-popup').style.display='none';
        }
        // Close picker when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.btn-ghost') && !event.target.matches('.emoji-btn')) {
                document.getElementById('emoji-popup').style.display = "none";
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "vidyarthi_backup.json");
            dlAnchorElem.click();
        }

        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                db = JSON.parse(e.target.result);
                saveAll();
                alert("Restored Successfully!");
            };
            reader.readAsText(file);
        }

        function toggleTheme() {
            db.settings.theme = db.settings.theme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', db.settings.theme);
            if(db.settings.theme === 'light') document.body.removeAttribute('data-theme');
            saveAll();
        }

        function resetApp() { if(confirm("Factory Reset?")) { localStorage.clear(); location.reload(); } }
        function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        function checkTimeline() { /* Alarm logic same as before, simplified for space */ }

        // Run
        init();
        nav('dashboard');

    </script>
</body>
</html>
